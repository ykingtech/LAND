<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sithuliya Admin Pro - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .luxury-font { font-family: 'Playfair Display', serif; }
        .glass-dark { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* PDF Layout Specifics */
        #pdfPreviewOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #525659; z-index: 10000; overflow-y: auto; display: none;
        }
        .print-paper {
            width: 210mm; min-height: 297mm; margin: 30px auto; background: white; 
            padding: 40px; color: black; font-family: 'Times New Roman', serif;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); position: relative;
        }
        
        /* Professional Receipt Styles */
        .receipt-box { border: 2px solid #333; padding: 20px; position: relative; }
        .receipt-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .receipt-logo { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; }
        .receipt-title { font-size: 24px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .receipt-label { font-weight: bold; color: #555; }
        .receipt-value { font-weight: bold; color: #000; }
        .receipt-footer { margin-top: 40px; display: flex; justify-content: space-between; text-align: center; font-size: 12px; }
        .sign-line { border-top: 1px dotted #000; width: 150px; margin-top: 40px; padding-top: 5px; }

        /* Report Table Styles */
        .report-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; margin-bottom: 15px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 4px 8px; vertical-align: middle; }
        .report-table th { background-color: #f0f0f0; text-align: left; font-weight: bold; }
        .report-header-bg { background-color: #e0e0e0; font-weight: bold; text-transform: uppercase; padding: 5px; border: 1px solid #000; font-size: 13px; margin-top: 15px; }
        
        .progress-bar-fill { transition: width 0.8s ease-in-out; }
        .modal-content-scroll { max-height: 85vh; overflow-y: auto; }
        
        .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 100%; overflow: auto; border: 1px solid #ddd; z-index: 50; max-height: 150px; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dropdown-content div { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; }
        .dropdown-content div:hover {background-color: #f3f4f6;}
        .show {display: block;}
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">

    <div id="pdfPreviewOverlay">
        <div class="sticky top-0 w-full bg-slate-800 p-4 flex justify-between items-center z-50 shadow-md">
            <h2 class="text-white font-bold">Document Preview</h2>
            <div class="flex gap-4">
                <button onclick="document.getElementById('pdfPreviewOverlay').style.display='none'" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow font-bold text-sm">Close</button>
                <button onclick="downloadPDFActual()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow font-bold text-sm"><i class="fas fa-download mr-2"></i> Download PDF</button>
            </div>
        </div>
        <div id="printContainer" class="print-paper"></div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 cursor-pointer backdrop-blur-sm" onclick="closeImgModal()">
        <img id="imgModalSrc" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl border border-gray-600">
    </div>

    <div id="staffAccessModal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-80 shadow-2xl text-center">
            <h3 class="text-lg font-bold mb-4 text-slate-800">Staff Access Required</h3>
            <input type="password" id="staffAccessInput" placeholder="Enter Access Code" class="w-full p-3 border rounded-lg mb-4 text-center bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="document.getElementById('staffAccessModal').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600 font-bold">Cancel</button>
                <button onclick="verifyStaffAccess()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700">Access</button>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1600596542815-2a429b08e695?q=80&w=2070&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-blue-900/60"></div>
        <div class="relative z-10 glass-dark p-10 rounded-3xl shadow-2xl w-96 text-center border border-blue-400/30">
            <div class="mb-8">
                <div class="flex justify-center mb-4">
                    <img src="ico.jpeg" class="w-32 h-32 rounded-full border-4 border-blue-500 shadow-xl object-cover" onerror="this.src='https://via.placeholder.com/150'">
                </div>
                <h1 class="text-4xl text-white luxury-font tracking-wide">Sithuliya</h1>
                <p class="text-blue-300 text-xs uppercase tracking-[0.4em] mt-2">Exclusive Real Estate</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="loginPass" class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-300 focus:outline-none focus:border-blue-500 text-center tracking-widest transition" placeholder="Password">
                <button onclick="attemptLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-105">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden flex h-full">
        <div class="w-64 bg-slate-900 text-white shadow-2xl flex flex-col z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-800 flex flex-col items-center">
                <img src="ico.jpeg" class="w-16 h-16 rounded-full border-2 border-blue-500 mb-3 object-cover shadow-lg" onerror="this.src='https://via.placeholder.com/150'">
                <h2 class="text-2xl luxury-font text-blue-400">Sithuliya <span class="text-[10px] font-sans text-slate-500 block tracking-widest mt-1 text-center">ADMIN CONSOLE</span></h2>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="nav('projects')" id="nav-projects" class="nav-btn w-full text-left p-3 rounded-xl bg-blue-900/50 text-blue-400 font-bold border border-blue-800"><i class="fas fa-map-marked-alt mr-3"></i> Projects</button>
                <button onclick="nav('lands')" id="nav-lands" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tree mr-3"></i> Lands</button>
                <button onclick="openStaffAccess()" id="nav-staff" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-users mr-3"></i> Staff</button>
                <button onclick="nav('readings')" id="nav-readings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tachometer-alt mr-3"></i> Meter Approvals</button>
                <button onclick="nav('reports')" id="nav-reports" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-file-invoice-dollar mr-3"></i> Financial Center</button>
                <div class="pt-8 border-t border-slate-800 mt-8">
                    <button onclick="nav('settings')" id="nav-settings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-cog mr-3"></i> Settings</button>
                </div>
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 px-8 border-b border-blue-100">
                <div class="relative w-96 group">
                    <input type="text" id="projSearch" placeholder="Search Customer ID, Name, Phone..." class="w-full pl-10 pr-4 py-2 border-none bg-blue-50 rounded-full focus:ring-2 focus:ring-blue-500 transition text-sm group-hover:bg-blue-100 text-blue-900">
                    <i class="fas fa-search absolute left-4 top-2.5 text-blue-400"></i>
                    <div id="searchResults" class="hidden absolute top-12 left-0 w-full bg-white shadow-2xl rounded-xl border border-blue-100 max-h-96 overflow-y-auto p-2 z-50"></div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="relative cursor-pointer" onclick="toggleNotifPanel()">
                        <div class="relative">
                            <i id="bellIcon" class="fas fa-bell text-gray-400 text-xl hover:text-blue-800 transition"></i>
                            <span id="notifBadge" class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">0</span>
                        </div>
                    </div>
                    <button onclick="openNewProjectModal()" class="bg-blue-900 text-white px-5 py-2 rounded-full hover:bg-blue-800 shadow-lg shadow-blue-900/20 text-sm font-bold transition transform hover:scale-105"><i class="fas fa-plus mr-2"></i> New Project</button>
                </div>
            </header>

            <div id="notifPanel" class="hidden absolute top-20 right-8 w-96 bg-white shadow-2xl rounded-xl border border-gray-100 z-50 overflow-hidden animate-fade-in-down">
                <div class="bg-slate-900 p-3 text-white text-sm font-bold flex justify-between items-center">
                    <span><i class="fas fa-exclamation-circle mr-2"></i>Notifications</span>
                    <button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
                </div>
                <div id="notifList" class="max-h-80 overflow-y-auto bg-gray-50"></div>
            </div>

            <main class="flex-1 overflow-auto p-8" id="mainScrollContainer">
                <div id="page-projects">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Active Developments</h2>
                        <div class="flex bg-gray-200 rounded-lg p-1">
                             <button onclick="toggleProjectView('active')" id="btn-view-active" class="px-4 py-1 rounded-md text-sm font-bold bg-white shadow text-slate-800">Active</button>
                             <button onclick="toggleProjectView('closed')" id="btn-view-closed" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-slate-800">Closed</button>
                        </div>
                    </div>
                    <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="closedProjectList" class="hidden space-y-4"></div>
                </div>

                <div id="page-lands" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Land Acquisition</h2>
                        <button onclick="document.getElementById('newLandModal').classList.remove('hidden')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700"><i class="fas fa-plus mr-2"></i> Add New Land</button>
                    </div>
                    <div id="landsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                </div>

                <div id="page-staff" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Staff Management</h2>
                        <div class="flex gap-4 items-center">
                            <div class="relative">
                                <input type="text" id="staffSearchInput" onkeyup="filterStaffGrid()" placeholder="Search Staff..." class="pl-8 pr-4 py-2 border rounded-full text-sm focus:ring-blue-500 bg-white">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('staffPassChangeModal').classList.remove('hidden')" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-yellow-600 text-xs">Change Access Code</button>
                                <button onclick="document.getElementById('newStaffModal').classList.remove('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><i class="fas fa-user-plus mr-2"></i> Add Staff</button>
                            </div>
                        </div>
                    </div>
                    <div id="staffGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>

                <div id="page-detail" class="hidden pb-20">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <button onclick="nav('projects')" class="text-gray-400 hover:text-blue-800 mb-2 font-bold text-xs uppercase tracking-wide"><i class="fas fa-arrow-left mr-2"></i> Back to Dashboard</button>
                            <h1 id="detailName" class="text-4xl font-bold text-blue-900 luxury-font">Project Name</h1>
                            <p class="text-gray-500 flex items-center mt-1 text-sm"><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> <span id="detailArea">Area</span> | <span id="detailLandName" class="ml-2 font-bold text-slate-800"></span></p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span id="detailStatus" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-blue-100 text-blue-800 border border-blue-200">Development</span>
                            <div class="flex gap-2 flex-wrap justify-end">
                                <button onclick="openReportDataModal()" class="text-xs bg-slate-100 text-slate-700 px-3 py-1 rounded font-bold border hover:bg-slate-200"><i class="fas fa-edit mr-1"></i> Report Data</button>
                                <button onclick="generateProjectMasterReport()" class="text-xs bg-slate-800 text-white px-3 py-1 rounded font-bold hover:bg-slate-900"><i class="fas fa-print mr-1"></i> Report (PDF)</button>
                                <button id="endDevBtn" onclick="endDevelopmentPhase()" class="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200 font-bold">End Development Phase</button>
                                <button id="closeProjBtn" onclick="closeProject()" class="hidden text-xs bg-red-600 text-white px-3 py-1 rounded shadow hover:bg-red-700 font-bold"><i class="fas fa-lock mr-1"></i> CLOSE PROJECT</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto hide-scrollbar">
                        <button onclick="subTab('overview')" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 sub-tab whitespace-nowrap" id="st-overview">Overview & Blocks</button>
                        <button onclick="subTab('tasks')" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 sub-tab whitespace-nowrap" id="st-tasks">Site Tasks & Costs</button>
                        <button onclick="subTab('finance')" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 sub-tab whitespace-nowrap" id="st-finance">Financials</button>
                    </div>

                    <div id="view-overview">
                        <div id="devPhaseUI" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Add Land Blocks</h3>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input type="text" id="blockName" placeholder="No (e.g. A1)" class="p-2 border rounded w-20 text-sm focus:ring-blue-500">
                                    <input type="number" id="blockSize" placeholder="Perches" class="p-2 border rounded w-24 text-sm focus:ring-blue-500" oninput="calcBlockPrice()">
                                    <input type="number" id="blockPerchPrice" placeholder="Price/Perch" class="p-2 border rounded w-32 text-sm focus:ring-blue-500" oninput="calcBlockPrice()">
                                    <input type="number" id="blockPrice" placeholder="Total Price" class="p-2 border rounded flex-1 bg-gray-50 font-bold text-slate-700 text-sm" readonly>
                                    <button id="addBlockBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 shadow"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Assigned Vehicles</h3>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="regVehicleNo" placeholder="Vehicle Number (e.g. WP-1234)" class="p-2 border rounded w-full uppercase text-sm focus:ring-blue-500">
                                    <button id="regVehicleBtn" onclick="assignVehicle()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900 shadow">Assign</button>
                                </div>
                                <div id="vehicleList" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-slate-700">Land Blocks Map</h3>
                        <div id="blocksContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>

                    <div id="view-tasks" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Site Operations</h3>
                            <button onclick="document.getElementById('newTaskModal').classList.remove('hidden')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900"><i class="fas fa-plus mr-2"></i> Assign Task</button>
                        </div>
                        <div id="adminTaskList" class="space-y-4"></div>
                    </div>

                    <div id="view-finance" class="hidden">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-2xl text-slate-800 luxury-font">Profit Analysis</h3>
                                <div class="flex gap-2">
                                    <button onclick="downloadFinancialReport()" class="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-bold border hover:bg-blue-800 transition"><i class="fas fa-file-download mr-2"></i> Report</button>
                                    <button onclick="openExpenseModal()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 transition"><i class="fas fa-receipt mr-2"></i> Add Misc Expense</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="p-6 rounded-xl bg-green-50 border border-green-100">
                                    <p class="text-xs text-green-600 uppercase font-bold tracking-widest mb-2">Revenue (Sold)</p>
                                    <h4 id="finIncome" class="text-3xl font-bold text-green-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-red-50 border border-red-100">
                                    <p class="text-xs text-red-600 uppercase font-bold tracking-widest mb-2">Cost (Exp + Tasks)</p>
                                    <h4 id="finExpense" class="text-3xl font-bold text-red-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-slate-50 border border-slate-200 relative overflow-hidden">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent"></div>
                                    <p class="text-xs text-slate-600 uppercase font-bold tracking-widest mb-2 relative z-10">Net Profit</p>
                                    <h4 id="finProfit" class="text-3xl font-bold text-slate-800 relative z-10">Rs. 0.00</h4>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Expense Ledger</h3>
                        <table class="w-full text-sm text-left bg-white rounded-lg overflow-hidden shadow-sm"><tbody id="expenseList"></tbody></table>
                    </div>
                </div>

                <div id="page-readings" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">Meter Approvals</h2>
                    <div id="readingsList" class="space-y-4"></div>
                </div>

                <div id="page-reports" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Financial Center</h2>
                    <div class="flex border-b border-gray-200 mb-6">
                        <button onclick="switchFinTab('entry')" id="ft-entry" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 transition">Data Entry</button>
                        <button onclick="switchFinTab('reports')" id="ft-reports" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 transition">View Reports</button>
                    </div>

                    <div id="fin-view-entry">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-coins text-blue-500 mr-2"></i> Transaction Entry</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="txDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Voucher No</label><input type="text" id="txVno" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Description</label><input type="text" id="txDesc" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="txType" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><option value="Expense">Expense</option><option value="Income">Income</option></select></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Amount</label><input type="number" id="txAmount" class="w-full p-2 border rounded bg-gray-50 font-bold focus:ring-blue-500"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Category</label><select id="txCategory" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><optgroup label="Income"><option value="Sales">Revenue</option><option value="Other Income">Other</option></optgroup><optgroup label="Expenses"><option value="Admin Expense">Admin</option><option value="Petty Cash">Petty Cash</option></optgroup></select></div>
                                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="txIsPetty" class="w-4 h-4 text-blue-500 rounded"><label for="txIsPetty" class="text-sm font-bold text-slate-700">Petty Cash Record</label></div>
                                    <button onclick="saveTransaction()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 mt-4 shadow-lg">SAVE TRANSACTION</button>
                                </div>
                            </div>
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 h-fit">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-balance-scale text-blue-500 mr-2"></i> Balance Sheet Entry</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="bsDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Account</label><input type="text" id="bsName" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="bsType" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><option value="Non-Current Asset">Asset (Fixed)</option><option value="Current Asset">Asset (Current)</option><option value="Equity">Equity</option><option value="Current Liability">Liability</option></select></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Value</label><input type="number" id="bsAmount" class="w-full p-2 border rounded bg-gray-50 font-bold focus:ring-blue-500"></div>
                                    <button onclick="saveBSItem()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 mt-4 shadow-lg">SAVE ITEM</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="fin-view-reports" class="hidden">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-wrap gap-4 items-center mb-6">
                            <input type="date" id="repFrom" class="p-2 border rounded bg-gray-50 text-sm"> <input type="date" id="repTo" class="p-2 border rounded bg-gray-50 text-sm">
                            <button onclick="genReport('daybook')" class="px-4 py-2 bg-slate-100 text-slate-800 rounded text-sm font-bold">Day Book</button>
                            <button onclick="genReport('petty')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Petty Cash</button>
                            <button onclick="genReport('pnl')" class="px-4 py-2 bg-green-50 text-green-700 rounded text-sm font-bold">P & L</button>
                            <button onclick="genReport('bs')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Balance Sheet</button>
                        </div>
                        <div id="reportOutputArea" class="bg-white p-8 rounded-2xl shadow border border-blue-100 min-h-[400px]">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-400 uppercase tracking-widest text-sm">Report Preview</h3><button onclick="triggerPDFDownload()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold">Download PDF</button></div>
                            <div id="reportContent" class="overflow-x-auto border rounded-lg p-4 bg-gray-50 text-sm"><p class="text-center text-gray-400 py-10">Select date range & type.</p></div>
                        </div>
                    </div>
                </div>

                <div id="page-settings" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 max-w-md">
                        <h3 class="font-bold text-lg mb-4 text-blue-600">Change Admin Password</h3>
                        <input type="password" id="newAdminPass" placeholder="New Password" class="w-full p-3 border rounded-lg mb-4 focus:ring-blue-500">
                        <button onclick="updatePassword()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800">Update Password</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="newProjectReportDataModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-[500px] modal-content-scroll">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Project Master Data</h2>
            <div class="space-y-3 text-sm">
                <div><label class="block font-bold text-gray-500 mb-1">Land Owner Name</label><input type="text" id="pdOwner" class="w-full p-2 border rounded"></div>
                <div><label class="block font-bold text-gray-500 mb-1">Introducer Name</label><input type="text" id="pdIntroducer" class="w-full p-2 border rounded"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block font-bold text-gray-500 mb-1">Extent (Acres)</label><input type="number" id="pdAcres" class="w-full p-2 border rounded"></div>
                    <div><label class="block font-bold text-gray-500 mb-1">Extent (Roods)</label><input type="number" id="pdRoods" class="w-full p-2 border rounded"></div>
                    <div><label class="block font-bold text-gray-500 mb-1">Extent (Perches)</label><input type="number" id="pdPerches" class="w-full p-2 border rounded"></div>
                    <div><label class="block font-bold text-gray-500 mb-1">Project Period (Months)</label><input type="number" id="pdPeriod" class="w-full p-2 border rounded" value="6"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block font-bold text-gray-500 mb-1">Stamp Duty %</label><input type="number" id="pdStamp" class="w-full p-2 border rounded" value="4"></div>
                    <div><label class="block font-bold text-gray-500 mb-1">Legal Fee %</label><input type="number" id="pdLegal" class="w-full p-2 border rounded" value="1"></div>
                    <div><label class="block font-bold text-gray-500 mb-1">Roadways %</label><input type="number" id="pdRoad" class="w-full p-2 border rounded" value="10"></div>
                    <div><label class="block font-bold text-gray-500 mb-1">Reservations %</label><input type="number" id="pdRes" class="w-full p-2 border rounded" value="10"></div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6"><button onclick="document.getElementById('newProjectReportDataModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button onclick="saveReportData()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold">Save Data</button></div>
        </div>
    </div>

    <div id="newProjectModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 modal-content-scroll">
            <h2 class="text-xl font-bold mb-6 text-slate-800">New Project</h2>
            <input type="text" id="newProjName" placeholder="Project Name" class="w-full p-3 border rounded-lg mb-3 bg-gray-50 focus:ring-blue-500">
            <input type="text" id="newProjArea" placeholder="Location" class="w-full p-3 border rounded-lg mb-3 bg-gray-50 focus:ring-blue-500">
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-1">Link Land (Optional)</label>
                <select id="landLinkSelect" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-blue-500 text-sm">
                    <option value="">Loading...</option>
                </select>
                <p class="text-[10px] text-gray-400 mt-1">Available unlinked lands only. Linked lands cannot be relinked.</p>
            </div>

            <div class="flex justify-end gap-3"><button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button onclick="createProject()" class="px-6 py-2 bg-slate-900 text-white rounded-lg">Create</button></div>
        </div>
    </div>
    
    <div id="newTaskModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 modal-content-scroll">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Assign Site Task</h2>
            <input type="text" id="newTaskTitle" placeholder="Title" class="w-full p-3 border rounded-lg mb-3 focus:ring-blue-500">
            <textarea id="newTaskDesc" placeholder="Instructions" class="w-full p-3 border rounded-lg mb-3 h-24 focus:ring-blue-500"></textarea>
            <label class="block text-xs font-bold text-gray-500 mb-1">Task Photo (Optional)</label>
            <input type="file" id="taskPhoto" accept="image/*" class="w-full p-2 border rounded-lg mb-6 text-sm">
            <div class="flex justify-end gap-3"><button onclick="document.getElementById('newTaskModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button id="saveTaskBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Assign</button></div>
        </div>
    </div>

    <div id="newLandModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 modal-content-scroll">
            <h2 class="text-xl font-bold mb-4 text-slate-800">New Land Acquisition</h2>
            <input type="text" id="landName" placeholder="Land Name/Location" class="w-full p-3 border rounded-lg mb-2">
            <input type="text" id="landSeller" placeholder="Seller Name" class="w-full p-3 border rounded-lg mb-2">
            <input type="number" id="landCost" placeholder="Total Cost" class="w-full p-3 border rounded-lg mb-2" oninput="calcLandAdvance()">
            <input type="number" id="landAdvance" placeholder="Advance Paid (Auto 10%)" class="w-full p-3 border rounded-lg mb-2">
            <button onclick="saveLand()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg mt-2">Save Land</button>
            <button onclick="document.getElementById('newLandModal').classList.add('hidden')" class="w-full mt-2 text-gray-500">Cancel</button>
        </div>
    </div>

    <div id="newStaffModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 modal-content-scroll">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Add Staff Member</h2>
            <input type="file" id="stfPhoto" accept="image/*" class="w-full p-2 border rounded-lg mb-2 text-sm text-gray-500">
            <input type="text" id="stfName" placeholder="Full Name" class="w-full p-3 border rounded-lg mb-2">
            <input type="text" id="stfNIC" placeholder="NIC Number" class="w-full p-3 border rounded-lg mb-2">
            <input type="text" id="stfAddress" placeholder="Address" class="w-full p-3 border rounded-lg mb-2">
            <input type="number" id="stfSalary" placeholder="Basic Salary" class="w-full p-3 border rounded-lg mb-2">
            <input type="number" id="stfFuel" placeholder="Fuel Allowance" class="w-full p-3 border rounded-lg mb-2">
            <button onclick="saveStaff()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg mt-2">Save Staff</button>
            <button onclick="document.getElementById('newStaffModal').classList.add('hidden')" class="w-full mt-2 text-gray-500">Cancel</button>
        </div>
    </div>

    <div id="staffDetailModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl modal-content-scroll">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-4">
                        <img id="detailStfImg" src="" class="w-20 h-20 rounded-full object-cover border-4 border-blue-500 bg-gray-200">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800" id="detailStfName">Name</h2>
                            <p class="text-sm text-gray-500" id="detailStfNIC">NIC</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('staffDetailModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <div id="staffViewMode" class="space-y-2 mb-6 text-sm">
                    <p><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> <span id="detailStfAddr"></span></p>
                    <p><i class="fas fa-money-bill-wave mr-2 text-green-500"></i> Salary: Rs.<span id="detailStfSal"></span></p>
                    <p><i class="fas fa-gas-pump mr-2 text-amber-500"></i> Fuel: Rs.<span id="detailStfFuel"></span></p>
                </div>

                <div id="staffEditMode" class="hidden space-y-2 mb-6">
                    <input type="text" id="editStfName" class="w-full p-2 border rounded" placeholder="Name">
                    <input type="text" id="editStfNIC" class="w-full p-2 border rounded" placeholder="NIC">
                    <input type="text" id="editStfAddr" class="w-full p-2 border rounded" placeholder="Address">
                    <input type="number" id="editStfSal" class="w-full p-2 border rounded" placeholder="Salary">
                    <input type="number" id="editStfFuel" class="w-full p-2 border rounded" placeholder="Fuel">
                    <button onclick="updateStaffDetails()" class="w-full bg-green-600 text-white py-2 rounded font-bold">Save Changes</button>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-2">Sales Commissions</h3>
                    <div id="stfCommList" class="max-h-32 overflow-y-auto text-xs space-y-1"></div>
                    <div class="border-t border-blue-200 mt-2 pt-2 flex justify-between font-bold">
                        <span>Total Earned:</span>
                        <span class="text-green-600" id="stfTotalComm">Rs. 0.00</span>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-2">
                    <button onclick="toggleStaffEdit()" class="px-4 py-2 bg-slate-200 rounded-lg text-slate-600 font-bold text-sm">Edit Details</button>
                </div>
            </div>
        </div>
    </div>

    <div id="staffPassChangeModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-80 shadow-2xl text-center">
            <h3 class="text-lg font-bold mb-4 text-blue-600">Change Staff Code</h3>
            <input type="password" id="newStaffPass" placeholder="New Code" class="w-full p-3 border rounded-lg mb-4 text-center">
            <button onclick="updateStaffPassword()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">Update</button>
            <button onclick="document.getElementById('staffPassChangeModal').classList.add('hidden')" class="w-full mt-2 text-gray-500 text-xs">Cancel</button>
        </div>
    </div>

    <div id="landPaymentModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-xl text-center">
            <h3 class="text-lg font-bold mb-4 text-green-700">Add Land Payment</h3>
            <p id="landPayInfo" class="text-xs text-gray-500 mb-4"></p>
            <input type="number" id="landPayAmount" placeholder="Amount" class="w-full p-3 border rounded-lg mb-4 text-lg font-bold">
            <button onclick="submitLandPayment()" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow">PAY NOW</button>
            <button onclick="document.getElementById('landPaymentModal').classList.add('hidden')" class="w-full mt-2 text-gray-500">Close</button>
        </div>
    </div>

    <div id="taskApproveModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50"><h2 class="text-xl font-bold text-slate-800" id="taskModalHeader">Review</h2><button onclick="document.getElementById('taskApproveModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 overflow-y-auto flex-1">
                <h3 id="approveTaskTitle" class="text-2xl font-bold text-slate-800 mb-2"></h3>
                <p class="text-lg mb-4">Cost: <span id="approveTaskCost" class="font-bold text-green-600 text-2xl"></span></p>
                <p class="text-sm mb-4 bg-yellow-50 p-2 rounded border border-yellow-200" id="approveTaskTimeInfo"></p>
                <div id="approveTaskPhotos" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end"><button id="confirmApproveTaskBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700">APPROVE</button></div>
        </div>
    </div>

    <div id="sellModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-8 rounded-2xl w-full max-w-4xl my-10 shadow-2xl relative modal-content-scroll">
            <button onclick="closeSellModal()" class="absolute top-6 right-6 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="border-b pb-4 mb-6"><h2 class="text-3xl font-bold text-slate-800 luxury-font">Sales Agreement</h2><p class="text-blue-600 font-bold mt-1">Block: <span id="sellBlockName"></span></p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1">Customer Details</h3>
                    <div id="newCusIdDisplay" class="hidden bg-blue-50 text-blue-700 p-2 rounded text-sm font-bold border border-blue-200 text-center">New Customer ID will be generated</div>
                    <input type="text" id="cusName" placeholder="Full Name" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-blue-500">
                    <textarea id="cusAddress" placeholder="Address" class="w-full p-3 border rounded-lg h-20 bg-gray-50 focus:ring-blue-500"></textarea>
                    <div class="flex gap-3"><input type="text" id="cusNIC" placeholder="NIC (Required for ID)" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-blue-500"><input type="text" id="cusPhone" placeholder="Phone" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-blue-500"></div>
                    
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1 mt-4">Sales Commission</h3>
                    <div class="relative">
                        <input type="text" id="salesPersonInput" placeholder="Type to search Sales Person..." class="w-full p-3 border rounded-lg bg-white focus:ring-blue-500" onkeyup="filterSalesFunction()" onclick="toggleSalesDropdown()">
                        <div id="salesDropdown" class="dropdown-content border rounded-lg shadow-lg w-full max-h-40 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1">Payment Plan</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-gray-500">PRICE</label><input type="number" id="finalPrice" class="w-full p-3 border rounded-lg font-bold text-slate-800 text-lg focus:ring-blue-500" oninput="calculateEP()"></div>
                        <div><label class="text-[10px] font-bold text-gray-500">ADVANCE</label><input type="number" id="advancePay" class="w-full p-3 border rounded-lg font-bold text-green-700 text-lg focus:ring-blue-500" oninput="calculateEP()"></div>
                    </div>
                    
                    <div class="flex gap-2">
                        <input type="number" id="planFee" placeholder="Plan Fee" class="w-1/2 p-2 border rounded text-sm">
                        <input type="number" id="deedFee" placeholder="Deed Fee (Auto)" class="w-1/2 p-2 border rounded text-sm bg-gray-100" readonly>
                    </div>

                    <select id="payPlanType" class="w-full p-3 border rounded-lg bg-slate-800 text-white font-bold" onchange="toggleEPFields()"><option value="Cash">Cash Sale</option><option value="EP">Easy Payment</option></select>
                    <div id="epFields" class="hidden bg-blue-50/50 p-4 rounded-xl border border-blue-100 space-y-3">
                        <div><label class="text-[10px] font-bold text-blue-800">AGREEMENT FEE</label><input type="number" id="epAgreeFee" value="15000" class="w-full p-2 border rounded text-center font-bold"></div>
                        <div class="flex gap-3"><div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">RATE %</label><input type="number" id="epRate" value="15" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div><div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">MONTHS</label><input type="number" id="epMonths" value="60" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div><div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">CYCLE</label><input type="number" id="epCycle" value="30" class="w-full p-2 border rounded text-center font-bold text-blue-600"></div></div>
                        <div class="flex justify-between items-center pt-2 border-t border-blue-200"><span class="text-sm font-bold text-blue-900">Monthly:</span><span id="epMonthlyInst" class="text-xl font-bold text-blue-700">0.00</span></div><div class="hidden"><span id="epTotalPayable"></span></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4 pt-6 border-t">
                <button onclick="processSale(true)" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-lg shadow-lg hover:bg-slate-800 flex items-center gap-2"><i class="fas fa-file-pdf"></i> Save & Download Receipt</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl relative modal-content-scroll">
            <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="flex justify-between items-start mb-4 border-b pb-4">
                <div><h2 class="text-2xl font-bold text-slate-800">Payment Record</h2><p id="payBlockInfo" class="text-blue-700 font-bold text-sm"></p></div>
                <div class="flex flex-col items-end gap-1"><button id="editPlanBtn" class="text-xs text-blue-600 underline font-bold" onclick="toggleEditPlan()">Edit Interest/Plan</button><button id="resellBtn" class="hidden text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200" onclick="processResell()">CANCEL & RESELL</button></div>
            </div>
            
            <div id="epCycleSection" class="hidden mb-6">
                <div class="flex justify-between items-end mb-1">
                    <span id="cycleStatusLabel" class="text-[10px] font-bold uppercase tracking-wider text-blue-600">Cycle Progress</span>
                    <span id="cycleDaysLeft" class="text-[10px] font-bold text-gray-500"></span>
                </div>
                <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden relative">
                    <div id="cycleProgressBar" class="h-full progress-bar-fill bg-blue-500" style="width: 0%"></div>
                </div>
                <div class="flex gap-2 mt-2">
                     <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase block">Current Rate</span><span id="dispRate" class="text-xs font-bold text-blue-700"></span></div>
                     <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase block">Plan Period</span><span id="dispMonths" class="text-xs font-bold text-blue-700"></span></div>
                </div>
                <div class="mt-3 bg-indigo-50 p-2 rounded-lg border border-indigo-100 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-indigo-400 uppercase">This Month Payable</p>
                        <p class="text-xs text-indigo-500" id="epNextDueDetail">...</p>
                    </div>
                    <p class="text-xl font-bold text-indigo-700" id="epNextDueAmt">Rs. 0.00</p>
                </div>
                <div class="mt-2 bg-slate-800 p-2 rounded-lg text-white flex justify-between items-center">
                    <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Total Future Liability</span>
                    <span id="epRealtimeFuture" class="font-bold text-lg text-green-400">Rs. 0.00</span>
                </div>
            </div>

            <div id="cusDetailsSection" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4 text-sm">
                <h4 class="font-bold text-gray-400 text-xs uppercase mb-2">Customer Details</h4>
                <div class="grid grid-cols-2 gap-2">
                    <p><i class="fas fa-id-badge mr-2 text-blue-500"></i> <span id="viewCusId" class="font-bold text-slate-800"></span></p>
                    <p><i class="fas fa-id-card mr-2 text-gray-400"></i> <span id="viewCusNIC" class="font-medium"></span></p>
                    <p><i class="fas fa-phone mr-2 text-gray-400"></i> <span id="viewCusPhone" class="font-medium"></span></p>
                    <p class="col-span-2"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> <span id="viewCusAddr" class="font-medium text-gray-600"></span></p>
                </div>
            </div>
            <div id="editPlanSection" class="hidden bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4">
                <h4 class="text-xs font-bold text-yellow-700 uppercase mb-2">Adjust Plan</h4>
                <div class="flex gap-2 mb-2"><input type="number" id="editNewRate" placeholder="Rate %" class="p-2 border rounded w-1/3 text-sm"><input type="number" id="editNewMonths" placeholder="Months" class="p-2 border rounded w-1/3 text-sm"><button id="savePlanChangesBtn" class="bg-yellow-600 text-white px-3 rounded text-sm font-bold w-1/3 hover:bg-yellow-700">Update</button></div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-3 bg-slate-100 rounded-lg"><p class="text-[10px] uppercase font-bold text-gray-500">Payable</p><p id="pmTotal" class="font-bold text-slate-800 text-lg">0.00</p></div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-100"><p class="text-[10px] uppercase font-bold text-green-600">Paid</p><p id="pmPaid" class="font-bold text-green-700 text-lg">0.00</p></div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Balance</p><p id="pmBalance" class="font-bold text-red-700 text-lg">0.00</p></div>
            </div>
            <div id="addPaymentSection" class="bg-slate-50 p-4 rounded-xl mb-6 border border-gray-200">
                <div class="flex gap-3 mb-2"><input type="date" id="newPayDate" class="w-1/3 p-2 border rounded text-sm"><input type="number" id="newPayAmount" placeholder="Amount" class="w-1/3 p-2 border rounded text-sm font-bold text-slate-800"><button id="submitPayBtn" class="w-1/3 bg-green-600 text-white rounded font-bold text-sm shadow hover:bg-green-700">ADD PAYMENT</button></div>
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="downloadPaymentReceipt()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300 font-bold"><i class="fas fa-receipt mr-1"></i> Receipt</button>
                    <button onclick="downloadPaymentHistory()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300 font-bold"><i class="fas fa-history mr-1"></i> Report</button>
                </div>
            </div>
            <div id="paymentCompleteMsg" class="hidden bg-green-100 text-green-800 p-4 rounded-xl text-center font-bold mb-6 border border-green-200"><i class="fas fa-check-circle mr-2"></i> FULLY PAID & CLOSED</div>
            <h3 class="font-bold text-xs text-gray-400 uppercase mb-2">History</h3>
            <div class="overflow-y-auto max-h-40 border rounded-lg"><table class="w-full text-xs text-left"><tbody id="paymentHistoryList" class="divide-y"></tbody></table></div>
        </div>
    </div>
    
    <div id="expenseModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-xl modal-content-scroll">
            <h2 class="text-lg font-bold mb-4 text-red-600">Add Expense</h2>
            <input type="text" id="expDesc" placeholder="Description" class="w-full p-2 border rounded mb-2">
            <input type="number" id="expAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4 font-bold">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('expenseModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button id="saveExpenseBtn" class="px-4 py-2 bg-red-600 text-white rounded font-bold">Save</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, collectionGroup, addDoc, deleteDoc, onSnapshot, query, where, orderBy, doc, updateDoc, arrayUnion, getDoc, getDocs, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlhMTQ-_sorFg_0ULpjf9kvjuIAWQkDVY",
            authDomain: "land-4d291.firebaseapp.com",
            projectId: "land-4d291",
            storageBucket: "land-4d291.firebasestorage.app",
            messagingSenderId: "1002505362762",
            appId: "1:1002505362762:web:f30e7ba82d8a344670f5b3",
            measurementId: "G-2EEQPP29VR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentProjId = null; 
        let currentProjName = ""; 
        let selectedBlockId = null; 
        let selectedBlockData = null;
        let currentProjUnsub = null;
        let projectTasksData = {};
        
        let staffListCache = [];

        window.attemptLogin = async () => {
            const pwd = document.getElementById('loginPass').value;
            const settingsRef = doc(db, "settings", "config");
            const snap = await getDoc(settingsRef);
            let correct = "Sandeep@1116"; 
            if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword;

            if(pwd === correct) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initApp();
            } else { alert("Incorrect Password"); }
        };

        // --- NEW REPORT DATA LOGIC ---
        window.openReportDataModal = async () => {
            if(!currentProjId) return;
            document.getElementById('newProjectReportDataModal').classList.remove('hidden');
            const snap = await getDoc(doc(db, "projects", currentProjId));
            if(snap.exists()) {
                const d = snap.data().reportData || {};
                document.getElementById('pdOwner').value = d.owner || "";
                document.getElementById('pdIntroducer').value = d.introducer || "";
                document.getElementById('pdAcres').value = d.acres || "";
                document.getElementById('pdRoods').value = d.roods || "";
                document.getElementById('pdPerches').value = d.perches || "";
                document.getElementById('pdPeriod').value = d.period || 6;
                document.getElementById('pdStamp').value = d.stamp || 4;
                document.getElementById('pdLegal').value = d.legal || 1;
                document.getElementById('pdRoad').value = d.road || 10;
                document.getElementById('pdRes').value = d.res || 10;
            }
        };

        window.saveReportData = async () => {
            const data = {
                owner: document.getElementById('pdOwner').value,
                introducer: document.getElementById('pdIntroducer').value,
                acres: document.getElementById('pdAcres').value,
                roods: document.getElementById('pdRoods').value,
                perches: document.getElementById('pdPerches').value,
                period: document.getElementById('pdPeriod').value,
                stamp: document.getElementById('pdStamp').value,
                legal: document.getElementById('pdLegal').value,
                road: document.getElementById('pdRoad').value,
                res: document.getElementById('pdRes').value
            };
            await updateDoc(doc(db, "projects", currentProjId), { reportData: data });
            document.getElementById('newProjectReportDataModal').classList.add('hidden');
            alert("Report Data Saved!");
        };

        window.openNewProjectModal = async () => {
            const select = document.getElementById('landLinkSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            document.getElementById('newProjectModal').classList.remove('hidden');

            const snap = await getDocs(collection(db, "company_lands"));
            select.innerHTML = '<option value="">Select Land (Optional)...</option>';
            snap.forEach(d => {
                const l = d.data();
                if(!l.linkedProjectId) {
                    select.innerHTML += `<option value="${d.id}">${l.name}</option>`;
                }
            });
        };

        window.createProject = async () => {
            const name = document.getElementById('newProjName').value; 
            const area = document.getElementById('newProjArea').value; 
            const linkedLandId = document.getElementById('landLinkSelect').value;

            if(!name) return alert("Name is required");

            const projRef = await addDoc(collection(db, "projects"), { 
                name, area, status: 'development', 
                linkedLandId: linkedLandId || null,
                createdAt: new Date() 
            });

            if(linkedLandId) {
                await updateDoc(doc(db, "company_lands", linkedLandId), {
                    linkedProjectId: projRef.id
                });
            }

            document.getElementById('newProjectModal').classList.add('hidden');
            document.getElementById('newProjName').value = "";
            document.getElementById('newProjArea').value = "";
        };

        window.generateProjectMasterReport = async () => {
            if(!currentProjId) return alert("Open a project first.");
            
            const projSnap = await getDoc(doc(db, "projects", currentProjId));
            const proj = projSnap.data();
            const rData = proj.reportData || {};
            
            let landData = { cost: 0, purchaseItems: [] };
            
            if(proj.linkedLandId) {
                const lSnap = await getDoc(doc(db, "company_lands", proj.linkedLandId));
                if(lSnap.exists()) {
                    const l = lSnap.data();
                    landData.cost = l.cost;
                    const stampPct = parseFloat(rData.stamp || 4)/100;
                    const legalPct = parseFloat(rData.legal || 1)/100;
                    
                    landData.purchaseItems = [
                        {name: "Purchase Price", val: l.cost},
                        {name: `Stamp Duty (${(stampPct*100)}%)`, val: l.cost * stampPct},
                        {name: `Legal Fees (${(legalPct*100)}%)`, val: l.cost * legalPct}
                    ];
                }
            }

            const expSnap = await getDocs(collection(db, `projects/${currentProjId}/expenses`));
            const blocksSnap = await getDocs(collection(db, `projects/${currentProjId}/blocks`));

            let devCosts = {
                "Survey Charges": 0, "Fencing": 0, "Site Office": 0, "Clearing": 0, "Road Construction": 0,
                "Water Supply": 0, "Electricity": 0, "Advertising": 0, "Staff Expenses": 0, "Taxes & Approvals": 0
            };
            
            let totalExp = 0;
            expSnap.forEach(d => {
                const e = d.data();
                totalExp += e.amount;
                const desc = e.description.toLowerCase();
                
                if(desc.includes('survey')) devCosts["Survey Charges"] += e.amount;
                else if(desc.includes('fence') || desc.includes('parapet')) devCosts["Fencing"] += e.amount;
                else if(desc.includes('office')) devCosts["Site Office"] += e.amount;
                else if(desc.includes('clear') || desc.includes('tree')) devCosts["Clearing"] += e.amount;
                else if(desc.includes('road') || desc.includes('gravel') || desc.includes('tar')) devCosts["Road Construction"] += e.amount;
                else if(desc.includes('water') || desc.includes('pipe') || desc.includes('well')) devCosts["Water Supply"] += e.amount;
                else if(desc.includes('elec') || desc.includes('transformer')) devCosts["Electricity"] += e.amount;
                else if(desc.includes('adver') || desc.includes('banner') || desc.includes('fb')) devCosts["Advertising"] += e.amount;
                else if(desc.includes('staff') || desc.includes('salary') || desc.includes('comm')) devCosts["Staff Expenses"] += e.amount;
                else if(desc.includes('tax') || desc.includes('approval') || desc.includes('pradeshiya')) devCosts["Taxes & Approvals"] += e.amount;
                else devCosts["Advertising"] += e.amount;
            });

            let totalSalesVal = 0;
            let sellableBlocks = 0;
            let soldBlocks = 0;
            let totalPerches = 0;
            
            blocksSnap.forEach(d => {
                const b = d.data();
                sellableBlocks++;
                totalPerches += parseFloat(b.size || 0);
                if(b.status.includes('sold')) {
                    soldBlocks++;
                    totalSalesVal += (b.soldPrice || b.price);
                } else {
                    totalSalesVal += b.price; 
                }
            });

            const landTotalCost = landData.purchaseItems.reduce((a,b)=>a+b.val,0);
            const devTotalCost = Object.values(devCosts).reduce((a,b)=>a+b,0);
            const grandTotalCost = landTotalCost + devTotalCost;
            const netProfit = totalSalesVal - grandTotalCost;
            const roi = grandTotalCost > 0 ? (netProfit / grandTotalCost * 100).toFixed(0) : 0;
            
            const roadPct = rData.road || 10;
            const resPct = rData.res || 10;
            const sellablePct = 100 - roadPct - resPct;

            let html = `
                <div style="text-align:center; font-size:18px; font-weight:bold; text-decoration:underline;">PROJECT EVALUATION REPORT</div>
                <div style="text-align:center; margin-bottom:20px; font-weight:bold;">${proj.name} - ${proj.area}</div>

                <div class="report-header-bg">PROJECT OVERVIEW</div>
                <table class="report-table">
                     <tr><td>Owner</td><td colspan="3">${rData.owner || '-'}</td></tr>
                     <tr><td>Introducer</td><td colspan="3">${rData.introducer || '-'}</td></tr>
                     <tr><td>Extent</td><td colspan="3">${rData.acres||0}A - ${rData.roods||0}R - ${rData.perches||0}P</td></tr>
                     <tr><td>Total Perches</td><td style="text-align:right">${totalPerches}</td><td>No of Blocks</td><td style="text-align:right">${sellableBlocks}</td></tr>
                </table>
                <table class="report-table">
                     <tr><td>For Roadways</td><td style="text-align:right">${roadPct}%</td><td>For Reservations</td><td style="text-align:right">${resPct}%</td></tr>
                     <tr><td>Sellable Area</td><td style="text-align:right">${sellablePct}%</td><td>Project Period</td><td style="text-align:right">${rData.period || 6} Months</td></tr>
                </table>

                <div class="report-header-bg">COST OF PURCHASE</div>
                <table class="report-table">
                    <tr><th>Description</th><th style="text-align:right">Amount (Rs)</th></tr>
                    ${landData.purchaseItems.map(i => `<tr><td>${i.name}</td><td style="text-align:right">${i.val.toLocaleString()}</td></tr>`).join('')}
                    <tr style="background:#f9f9f9; font-weight:bold;"><td>Total Purchase Cost</td><td style="text-align:right">${landTotalCost.toLocaleString()}</td></tr>
                </table>

                <div class="report-header-bg">DEVELOPMENT COST</div>
                <table class="report-table">
                    <tr><th>Description</th><th style="text-align:right">Amount (Rs)</th></tr>
                    ${Object.entries(devCosts).map(([k,v]) => `<tr><td>${k}</td><td style="text-align:right">${v.toLocaleString()}</td></tr>`).join('')}
                    <tr style="background:#f9f9f9; font-weight:bold;"><td>Total Development Cost</td><td style="text-align:right">${devTotalCost.toLocaleString()}</td></tr>
                </table>

                <div class="report-header-bg">SALES & PROFITABILITY</div>
                <table class="report-table">
                    <tr><td style="font-weight:bold">TOTAL SALES PROCEEDS</td><td style="text-align:right; font-weight:bold; font-size:14px;">${totalSalesVal.toLocaleString()}</td></tr>
                    <tr><td>Total Cost of Project</td><td style="text-align:right; color:red;">(${grandTotalCost.toLocaleString()})</td></tr>
                    <tr style="background:#e0e0e0"><td style="font-weight:bold">NET PROFIT</td><td style="text-align:right; font-weight:bold; font-size:14px;">${netProfit.toLocaleString()}</td></tr>
                </table>

                <table class="report-table" style="margin-top:20px; width:50%;">
                    <tr><th colspan="2">RETURN ON INVESTMENT (ROI)</th></tr>
                    <tr><td>ROI PERCENTAGE</td><td style="text-align:right; font-weight:bold;">${roi}%</td></tr>
                </table>

                <div style="margin-top:50px; display:flex; justify-content:space-between; padding-top:20px;">
                    <div style="text-align:center; width:30%; border-top:1px solid #000;">Manager</div>
                    <div style="text-align:center; width:30%; border-top:1px solid #000;">Director</div>
                    <div style="text-align:center; width:30%; border-top:1px solid #000;">Chairman</div>
                </div>
            `;
            
            document.getElementById('printContainer').innerHTML = html;
            document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        window.downloadPDFActual = async () => {
             const element = document.getElementById('printContainer');
             const opt = {
                margin: 0,
                filename: `Project_Report_${currentProjName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            await html2pdf().set(opt).from(element).save();
            document.getElementById('pdfPreviewOverlay').style.display = 'none';
        }

        window.filterStaffGrid = () => {
            const input = document.getElementById('staffSearchInput').value.toLowerCase();
            const grid = document.getElementById('staffGrid');
            const cards = grid.getElementsByTagName('div');
            for (let i = 0; i < cards.length; i++) {
                const nameHeader = cards[i].querySelector('h4');
                if (nameHeader) {
                    const txtValue = nameHeader.textContent || nameHeader.innerText;
                    if (txtValue.toLowerCase().indexOf(input) > -1) {
                        cards[i].style.display = "";
                    } else {
                        cards[i].style.display = "none";
                    }
                }
            }
        };

        window.filterSalesFunction = () => {
            const input = document.getElementById("salesPersonInput");
            const filter = input.value.toUpperCase();
            const div = document.getElementById("salesDropdown");
            div.innerHTML = ""; 
            if(filter.length === 0) { div.classList.remove("show"); return; }
            const matched = staffListCache.filter(s => s.name.toUpperCase().includes(filter));
            if(matched.length > 0) {
                div.classList.add("show");
                matched.forEach(s => {
                    const d = document.createElement('div');
                    d.innerHTML = `<span class="font-bold">${s.name}</span> <span class="text-xs text-gray-500">(${s.nic})</span>`;
                    d.onclick = () => { document.getElementById("salesPersonInput").value = s.name; div.classList.remove("show"); };
                    div.appendChild(d);
                });
            } else { div.classList.remove("show"); }
        };

        window.toggleSalesDropdown = () => {
            const div = document.getElementById("salesDropdown");
            if(document.getElementById("salesPersonInput").value === "") {
                div.innerHTML = "";
                staffListCache.forEach(s => {
                     const d = document.createElement('div');
                    d.innerHTML = `<span class="font-bold">${s.name}</span> <span class="text-xs text-gray-500">(${s.nic})</span>`;
                    d.onclick = () => { document.getElementById("salesPersonInput").value = s.name; div.classList.remove("show"); };
                    div.appendChild(d);
                });
                div.classList.add("show");
            }
        }
        
        window.onclick = function(event) {
            if (!event.target.matches('#salesPersonInput')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                }
            }
        };

        window.loadStaff = () => {
            onSnapshot(collection(db, "staff"), (snap) => {
                const grid = document.getElementById('staffGrid'); grid.innerHTML = ""; staffListCache = []; 
                snap.forEach(d => {
                    const s = d.data(); staffListCache.push(s); 
                    const photo = s.photo || 'https://via.placeholder.com/150';
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 cursor-pointer hover:shadow-md transition";
                    el.onclick = () => openStaffDetail(d.id);
                    el.innerHTML = `<img src="${photo}" class="w-12 h-12 rounded-full object-cover border-2 border-blue-100 bg-gray-200"><div><h4 class="font-bold text-slate-800">${s.name}</h4><p class="text-xs text-gray-500">${s.nic}</p><p class="text-xs font-bold mt-1 text-blue-600">Salary: ${s.salary.toLocaleString()}</p></div>`;
                    grid.appendChild(el);
                });
            });
        }

        document.getElementById('projSearch').addEventListener('input', async (e) => {
            const term = e.target.value.toLowerCase();
            const resDiv = document.getElementById('searchResults');
            resDiv.innerHTML = "";
            if(term.length < 2) { resDiv.classList.add('hidden'); return; }

            const projQ = query(collection(db, "projects"));
            const projSnap = await getDocs(projQ);
            let results = [];
            projSnap.forEach(d => { 
                if(d.data().name.toLowerCase().includes(term)) 
                    results.push({type:'Project', name:d.data().name, id:d.id, data: d.data()}); 
            });

            const cusSnap = await getDocs(collection(db, "customers"));
            cusSnap.forEach(d => {
                const c = d.data();
                const cid = (c.customerId || "").toLowerCase();
                const cname = (c.name || "").toLowerCase();
                const cnic = (c.nic || "").toLowerCase();
                if(cid.includes(term) || cname.includes(term) || cnic.includes(term)) {
                    results.push({
                        type:'Customer', name: c.name, 
                        detail: `ID: ${c.customerId || '-'} | Block: ${c.blockName}`, 
                        projId: c.projectId, blockId: c.blockId
                    });
                }
            });

            if(results.length > 0) {
                resDiv.classList.remove('hidden');
                results.forEach(r => {
                    const div = document.createElement('div');
                    div.className = "p-2 hover:bg-blue-50 cursor-pointer border-b text-sm";
                    div.innerHTML = `<span class="font-bold text-slate-800">${r.name}</span> <span class="text-xs text-blue-900 uppercase ml-2 bg-blue-200 px-1 rounded">${r.type}</span><div class="text-xs text-gray-400">${r.detail || ''}</div>`;
                    div.onclick = async () => {
                        resDiv.classList.add('hidden');
                        document.getElementById('projSearch').value = "";
                        if(r.type === 'Project') { openProject(r.id, r.data); }
                        else if (r.type === 'Customer') { 
                            const projDoc = await getDoc(doc(db, "projects", r.projId));
                            if(projDoc.exists()) {
                                openProject(r.projId, projDoc.data()); 
                                setTimeout(async () => {
                                    const blockSnap = await getDoc(doc(db, `projects/${r.projId}/blocks/${r.blockId}`));
                                    if(blockSnap.exists()) { selectedBlockId = r.blockId; openPaymentModal(blockSnap.data()); }
                                }, 800);
                            }
                        }
                    };
                    resDiv.appendChild(div);
                });
            } else { resDiv.innerHTML = "<div class='p-2 text-sm text-gray-400'>No matches found.</div>"; resDiv.classList.remove('hidden'); }
        });

        window.triggerPDFDownload = async () => {
            const overlay = document.getElementById('pdfPreviewOverlay');
            const content = document.getElementById('reportContent').innerHTML;
            if(!content || content.includes('Select date range')) return alert("Please generate a report first.");
            document.getElementById('printContainer').innerHTML = `<h2 class="text-center text-xl font-bold mb-4 underline">${document.getElementById('overlayPrintTitle')?.innerText || 'REPORT'}</h2>` + content;
            overlay.style.display = 'block';
        };

        window.updatePassword = async () => {
            const newP = document.getElementById('newAdminPass').value;
            if(!newP || newP.length < 4) return alert("Password too short");
            await setDoc(doc(db, "settings", "config"), { adminPassword: newP }, { merge: true });
            alert("Password Updated"); document.getElementById('newAdminPass').value = "";
        };

        window.updateStaffPassword = async () => {
            const newP = document.getElementById('newStaffPass').value;
            if(!newP || newP.length < 4) return alert("Password too short");
            await setDoc(doc(db, "settings", "staff_config"), { accessPassword: newP }, { merge: true });
            alert("Staff Password Updated"); document.getElementById('newStaffPass').value = "";
            document.getElementById('staffPassChangeModal').classList.add('hidden');
        };

        window.openStaffAccess = () => {
            document.getElementById('staffAccessModal').classList.remove('hidden');
            document.getElementById('staffAccessInput').value = "";
            document.getElementById('staffAccessInput').focus();
        };

        window.verifyStaffAccess = async () => {
            const input = document.getElementById('staffAccessInput').value;
            const snap = await getDoc(doc(db, "settings", "staff_config"));
            let correct = "yaso"; 
            if(snap.exists() && snap.data().accessPassword) correct = snap.data().accessPassword;
            if(input === correct) { document.getElementById('staffAccessModal').classList.add('hidden'); nav('staff'); } 
            else { alert("Access Denied"); }
        };

        window.closeImgModal = () => document.getElementById('imgModal').classList.add('hidden');
        window.closeSellModal = () => document.getElementById('sellModal').classList.add('hidden');
        window.openExpenseModal = () => document.getElementById('expenseModal').classList.remove('hidden');
        window.toggleNotifPanel = () => document.getElementById('notifPanel').classList.toggle('hidden');
        
        window.nav = (page) => {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-blue-900/50','text-blue-400', 'border-blue-800'); b.classList.add('text-gray-400'); });
            const btn = document.getElementById(`nav-${page}`);
            if(btn) { btn.classList.add('bg-blue-900/50','text-blue-400', 'border-blue-800'); btn.classList.remove('text-gray-400'); }
            if(page==='readings') loadMeterReadings();
            if(page==='reports') { document.getElementById('txDate').valueAsDate = new Date(); document.getElementById('bsDate').valueAsDate = new Date(); }
            if(page==='lands') loadLands();
            if(page==='staff') loadStaff();
        };

        window.subTab = (tab) => {
            document.querySelectorAll('.sub-tab').forEach(t => { t.classList.remove('text-slate-800', 'border-blue-800'); t.classList.add('text-gray-400'); });
            document.getElementById(`st-${tab}`).classList.add('text-slate-800', 'border-blue-800');
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        };

        window.switchFinTab = (tab) => {
            document.getElementById('fin-view-entry').classList.toggle('hidden', tab !== 'entry');
            document.getElementById('fin-view-reports').classList.toggle('hidden', tab !== 'reports');
            document.getElementById('ft-entry').className = tab === 'entry' ? "px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 transition" : "px-6 py-3 font-bold text-gray-400 hover:text-slate-600 transition";
            document.getElementById('ft-reports').className = tab === 'reports' ? "px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 transition" : "px-6 py-3 font-bold text-gray-400 hover:text-slate-600 transition";
        };

        async function recordDailyTransaction(desc, amt, type, projName) {
            const today = new Date().toLocaleDateString('en-CA'); 
            await addDoc(collection(db, "daily_transactions"), { date: today, description: desc, amount: amt, type: type, project: projName, timestamp: serverTimestamp() });
            const cat = type === 'income' ? 'Sales' : 'Admin Expense';
            await addDoc(collection(db, "transactions"), { date: today, description: desc, vNo: '', type: type, category: cat, amount: amt, isPetty: false, timestamp: serverTimestamp() });
        }

        window.saveTransaction = async () => {
            const date = document.getElementById('txDate').value; const vNo = document.getElementById('txVno').value;
            const desc = document.getElementById('txDesc').value; const type = document.getElementById('txType').value;
            const category = document.getElementById('txCategory').value; const amount = parseFloat(document.getElementById('txAmount').value);
            const isPetty = document.getElementById('txIsPetty').checked;
            if(!date || !desc || !amount) return alert("Please fill Date, Description and Amount");
            await addDoc(collection(db, "transactions"), { date, vNo, description: desc, type, category, amount, isPetty, timestamp: serverTimestamp() });
            document.getElementById('txDesc').value = ""; document.getElementById('txAmount').value = ""; document.getElementById('txVno').value = ""; alert("Transaction Saved Successfully!");
        };

        window.saveBSItem = async () => {
            const date = document.getElementById('bsDate').value; const name = document.getElementById('bsName').value;
            const type = document.getElementById('bsType').value; const amount = parseFloat(document.getElementById('bsAmount').value);
            if(!date || !name || !amount) return alert("Please fill all Balance Sheet fields");
            await addDoc(collection(db, "bs_items"), { date, name, type, amount, timestamp: serverTimestamp() });
            document.getElementById('bsName').value = ""; document.getElementById('bsAmount').value = ""; alert("Balance Sheet Item Saved!");
        };
        
        window.genReport = async (type) => {
             try {
                const from = document.getElementById('repFrom').value; const to = document.getElementById('repTo').value;
                if(!from || !to) return alert("Please select a Date Range first.");
                
                let html = ""; 
                let q = query(collection(db, "transactions"), where("date", ">=", from), where("date", "<=", to), orderBy("date"));
                const snap = await getDocs(q);

                if(type === 'daybook') {
                    let bal = 0; let totInc = 0; let totExp = 0;
                    html = `<table class="w-full border-collapse"><thead><tr class="bg-gray-200 border-b border-black"><th class="p-2 text-left">Date</th><th class="p-2 text-left">Desc</th><th class="p-2 text-right">Income</th><th class="p-2 text-right">Expense</th><th class="p-2 text-right">Balance</th></tr></thead><tbody>`;
                    snap.forEach(d => { const t = d.data(); let inc = t.type === 'Income' ? t.amount : 0; let exp = t.type === 'Expense' ? t.amount : 0; bal += (inc - exp); totInc += inc; totExp += exp; html += `<tr><td class="p-2 border-b text-xs">${t.date}</td><td class="p-2 border-b text-xs">${t.description}</td><td class="p-2 border-b text-right text-xs text-green-600">${inc>0?inc.toLocaleString():'-'}</td><td class="p-2 border-b text-right text-xs text-red-600">${exp>0?exp.toLocaleString():'-'}</td><td class="p-2 border-b text-right text-xs font-bold">${bal.toLocaleString()}</td></tr>`; });
                    html += `</tbody><tfoot><tr class="font-bold border-t-2 border-black"><td colspan="2" class="p-2 text-right">TOTALS:</td><td class="p-2 text-right">${totInc.toLocaleString()}</td><td class="p-2 text-right">${totExp.toLocaleString()}</td><td class="p-2 text-right">${bal.toLocaleString()}</td></tr></tfoot></table>`;
                } 
                else if (type === 'petty') {
                     let tot = 0; html = `<table class="w-full border-collapse"><thead><tr class="bg-blue-100 border-b border-blue-600"><th class="p-2 text-left">Date</th><th class="p-2 text-left">Description</th><th class="p-2 text-right">Amount</th></tr></thead><tbody>`;
                    snap.forEach(d => { const t = d.data(); if(t.isPetty) { tot += t.amount; html += `<tr><td class="p-2 border-b text-xs">${t.date}</td><td class="p-2 border-b text-xs">${t.description}</td><td class="p-2 border-b text-right text-xs font-bold">${t.amount.toLocaleString()}</td></tr>`; } });
                    html += `</tbody><tfoot><tr class="font-bold border-t border-blue-600"><td colspan="2" class="p-2 text-right">TOTAL:</td><td class="p-2 text-right">${tot.toLocaleString()}</td></tr></tfoot></table>`;
                }
                else if (type === 'pnl') {
                     let cats = {}; snap.forEach(d => { const t = d.data(); if(!cats[t.category]) cats[t.category] = 0; cats[t.category] += t.amount; });
                    const rev = (cats['Sales']||0) + (cats['Other Income']||0); const cogs = cats['Cost of Sales']||0; const gp = rev - cogs;
                    const admin = cats['Admin Expense']||0; const selling = cats['Selling Expense']||0; const fin = cats['Finance Cost']||0; const tax = cats['Tax']||0; const petty = cats['Petty Cash']||0;
                    const totExp = admin + selling + fin + tax + petty; const np = gp - totExp;
                    html = `<table class="w-full text-sm"><tr><td class="p-2 font-bold">Revenue</td><td class="p-2 text-right">${rev.toLocaleString()}</td></tr><tr><td class="p-2 text-red-600">Cost of Sales</td><td class="p-2 text-right text-red-600">(${cogs.toLocaleString()})</td></tr><tr class="border-t border-black bg-gray-100"><td class="p-2 font-bold">GROSS PROFIT</td><td class="p-2 text-right font-bold">${gp.toLocaleString()}</td></tr><tr><td class="p-2 pt-4 font-bold text-gray-500 uppercase">Expenses</td><td></td></tr><tr><td class="p-2 pl-6">Admin Expenses</td><td class="p-2 text-right">${admin.toLocaleString()}</td></tr><tr><td class="p-2 pl-6">Selling & Distribution</td><td class="p-2 text-right">${selling.toLocaleString()}</td></tr><tr><td class="p-2 pl-6">Finance Costs</td><td class="p-2 text-right">${fin.toLocaleString()}</td></tr><tr><td class="p-2 pl-6">Tax</td><td class="p-2 text-right">${tax.toLocaleString()}</td></tr>${petty>0 ? `<tr><td class="p-2 pl-6">Petty Cash Exp</td><td class="p-2 text-right">${petty.toLocaleString()}</td></tr>` : ''}<tr class="border-t border-black"><td class="p-2 font-bold">Total Expenses</td><td class="p-2 text-right">(${totExp.toLocaleString()})</td></tr><tr class="border-t-2 border-double border-black bg-gray-100"><td class="p-2 font-bold text-lg">NET PROFIT</td><td class="p-2 text-right font-bold text-lg">${np.toLocaleString()}</td></tr></table>`;
                }
                else if (type === 'bs') {
                    const bssnap = await getDocs(query(collection(db, "bs_items")));
                    let grp = { 'Non-Current Asset':0, 'Current Asset':0, 'Equity':0, 'Non-Current Liability':0, 'Current Liability':0 }; let items = [];
                    bssnap.forEach(d => { const t = d.data(); if(t.date <= to) { grp[t.type] += t.amount; items.push(t); } });
                    html = `<div class="grid grid-cols-2 gap-8"><div><h4 class="font-bold border-b mb-2">ASSETS</h4><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Non-Current Assets</p>${items.filter(i=>i.type==='Non-Current Asset').map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total</span><span>${grp['Non-Current Asset'].toLocaleString()}</span></div></div><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Current Assets</p>${items.filter(i=>i.type==='Current Asset').map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total</span><span>${grp['Current Asset'].toLocaleString()}</span></div></div><div class="flex justify-between font-bold text-lg border-t-2 border-black p-2"><span>TOTAL ASSETS</span><span>${(grp['Non-Current Asset']+grp['Current Asset']).toLocaleString()}</span></div></div><div><h4 class="font-bold border-b mb-2">EQUITY & LIABILITIES</h4><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Equity</p>${items.filter(i=>i.type==='Equity').map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total Equity</span><span>${grp['Equity'].toLocaleString()}</span></div></div><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Liabilities</p>${items.filter(i=>i.type.includes('Liability')).map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total Liab.</span><span>${(grp['Non-Current Liability']+grp['Current Liability']).toLocaleString()}</span></div></div><div class="flex justify-between font-bold text-lg border-t-2 border-black p-2"><span>TOTAL EQ & LIAB</span><span>${(grp['Equity']+grp['Non-Current Liability']+grp['Current Liability']).toLocaleString()}</span></div></div></div>`;
                }

                document.getElementById('reportContent').innerHTML = html;
            } catch (err) { console.error(err); alert("Report generation error (Check Indexes)"); }
        };

        window.downloadFinancialReport = async () => {
            const inc = document.getElementById('finIncome').innerText; const exp = document.getElementById('finExpense').innerText; const prof = document.getElementById('finProfit').innerText;
            document.getElementById('printContainer').innerHTML = `<h2>Project Summary</h2><table style="width:100%; margin-top:20px; font-size:18px;"><tr><td style="padding:10px;">Total Revenue</td><td style="text-align:right;">${inc}</td></tr><tr><td style="padding:10px;">Total Costs</td><td style="text-align:right; color:red;">${exp}</td></tr><tr style="font-weight:bold; border-top:2px solid black;"><td style="padding:10px;">NET PROFIT</td><td style="text-align:right;">${prof}</td></tr></table>`;
            document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        function loadLands() {
            onSnapshot(collection(db, "company_lands"), (snap) => {
                const grid = document.getElementById('landsGrid');
                grid.innerHTML = "";
                snap.forEach(d => {
                    const l = d.data();
                    const paid = (l.advance || 0) + (l.partPayment || 0);
                    const bal = (l.cost || 0) - paid;
                    const isPaid = bal <= 0;
                    grid.innerHTML += `
                        <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full ${isPaid ? 'bg-green-500' : 'bg-red-500'}"></div>
                            <h3 class="font-bold text-lg ml-3">${l.name}</h3>
                            <p class="text-sm text-gray-500 ml-3 mb-2">Seller: ${l.seller}</p>
                            ${l.linkedProjectId ? '<span class="ml-3 bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded">LINKED TO PROJECT</span>' : '<span class="ml-3 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded">AVAILABLE</span>'}
                            <div class="ml-3 grid grid-cols-2 gap-4 text-sm mt-4">
                                <div><p class="text-xs text-gray-400 font-bold uppercase">Cost</p><p class="font-bold">Rs. ${l.cost.toLocaleString()}</p></div>
                                <div><p class="text-xs text-gray-400 font-bold uppercase">Paid</p><p class="font-bold text-green-600">Rs. ${paid.toLocaleString()}</p></div>
                                <div class="col-span-2 border-t pt-2 flex justify-between items-center">
                                    <span class="text-xs font-bold ${isPaid?'text-green-500':'text-red-500'} uppercase">${isPaid?'Fully Paid':'Balance: Rs. '+bal.toLocaleString()}</span>
                                    ${!isPaid ? `<button onclick="openLandPaymentModal('${d.id}', '${l.name}', ${bal})" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 font-bold border border-blue-200">Add Payment</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }
        
        let activeLandId = null;
        window.openLandPaymentModal = (id, name, bal) => {
            activeLandId = id;
            document.getElementById('landPayInfo').innerText = `${name} (Due: Rs.${bal})`;
            document.getElementById('landPayAmount').value = "";
            document.getElementById('landPaymentModal').classList.remove('hidden');
        };

        window.submitLandPayment = async () => {
            const amt = parseFloat(document.getElementById('landPayAmount').value);
            if(!amt) return;
            const landRef = doc(db, "company_lands", activeLandId);
            const landSnap = await getDoc(landRef);
            const currentPaid = landSnap.data().partPayment || 0;
            
            await updateDoc(landRef, { partPayment: currentPaid + amt });
            await addDoc(collection(db, "transactions"), { date: new Date().toLocaleDateString('en-CA'), description: `Land Part Payment: ${landSnap.data().name}`, amount: amt, type: 'Expense', category: 'Cost of Sales', timestamp: serverTimestamp() });
            
            document.getElementById('landPaymentModal').classList.add('hidden');
            alert("Payment Added!");
        };

        window.calcLandAdvance = () => {
            const cost = parseFloat(document.getElementById('landCost').value) || 0;
            document.getElementById('landAdvance').value = cost * 0.10; // 10%
        };

        window.saveLand = async () => {
            const name = document.getElementById('landName').value;
            const seller = document.getElementById('landSeller').value;
            const cost = parseFloat(document.getElementById('landCost').value);
            const advance = parseFloat(document.getElementById('landAdvance').value);
            if(!name || !cost) return;
            
            await addDoc(collection(db, "company_lands"), {
                name, seller, cost, advance, linkedProjectId: null, createdAt: serverTimestamp()
            });
            await addDoc(collection(db, "transactions"), { date: new Date().toLocaleDateString('en-CA'), description: `Land Advance: ${name}`, amount: advance, type: 'Expense', category: 'Cost of Sales', timestamp: serverTimestamp() });
            
            await addDoc(collection(db, "bs_items"), {
                date: new Date().toLocaleDateString('en-CA'),
                name: `Land Stock: ${name}`,
                type: "Current Asset",
                amount: cost,
                timestamp: serverTimestamp()
            });

            document.getElementById('newLandModal').classList.add('hidden');
            alert("Land Added & Asset Ledger Updated!");
        };

        let currentStaffId = null;
        window.saveStaff = async () => {
            const name = document.getElementById('stfName').value;
            const nic = document.getElementById('stfNIC').value;
            const addr = document.getElementById('stfAddress').value;
            const sal = parseFloat(document.getElementById('stfSalary').value);
            const fuel = parseFloat(document.getElementById('stfFuel').value);
            const file = document.getElementById('stfPhoto').files[0];
            let photoBase64 = null;
            if(file) photoBase64 = await processImage(file);
            await addDoc(collection(db, "staff"), { name, nic, address: addr, salary: sal, fuel, photo: photoBase64, createdAt: serverTimestamp() });
            document.getElementById('newStaffModal').classList.add('hidden'); alert("Staff Added!");
        };

        window.openStaffDetail = async (id) => {
            currentStaffId = id; const sSnap = await getDoc(doc(db, "staff", id)); if(!sSnap.exists()) return; const s = sSnap.data();
            document.getElementById('staffDetailModal').classList.remove('hidden'); document.getElementById('detailStfName').innerText = s.name; document.getElementById('detailStfNIC').innerText = s.nic; document.getElementById('detailStfAddr').innerText = s.address; document.getElementById('detailStfSal').innerText = (s.salary||0).toLocaleString(); document.getElementById('detailStfFuel').innerText = (s.fuel||0).toLocaleString(); document.getElementById('detailStfImg').src = s.photo || 'https://via.placeholder.com/150';
            document.getElementById('editStfName').value = s.name; document.getElementById('editStfNIC').value = s.nic; document.getElementById('editStfAddr').value = s.address; document.getElementById('editStfSal').value = s.salary; document.getElementById('editStfFuel').value = s.fuel;
            document.getElementById('staffViewMode').classList.remove('hidden'); document.getElementById('staffEditMode').classList.add('hidden');
             try {
                const q = query(collectionGroup(db, 'expenses'), where('description', '>=', `Commission: ${s.name}`), where('description', '<=', `Commission: ${s.name}\uf8ff`));
                const commSnap = await getDocs(q); let totalComm = 0; const list = document.getElementById('stfCommList'); list.innerHTML = "";
                commSnap.forEach(d => { const comm = d.data(); totalComm += comm.amount; list.innerHTML += `<div class="flex justify-between border-b border-blue-100 py-1"><span>${comm.date}</span><span>Rs. ${comm.amount.toLocaleString()}</span></div>`; });
                document.getElementById('stfTotalComm').innerText = "Rs. " + totalComm.toLocaleString();
            } catch (e) { document.getElementById('stfCommList').innerHTML = "No commission data."; }
        };

        window.toggleStaffEdit = () => { document.getElementById('staffViewMode').classList.toggle('hidden'); document.getElementById('staffEditMode').classList.toggle('hidden'); };
        window.updateStaffDetails = async () => {
            const name = document.getElementById('editStfName').value; const nic = document.getElementById('editStfNIC').value; const addr = document.getElementById('editStfAddr').value; const sal = parseFloat(document.getElementById('editStfSal').value); const fuel = parseFloat(document.getElementById('editStfFuel').value);
            await updateDoc(doc(db, "staff", currentStaffId), { name, nic, address: addr, salary: sal, fuel }); alert("Updated!"); openStaffDetail(currentStaffId);
        };

        function processImage(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const maxW = 300; const scale = maxW / img.width; canvas.width = maxW; canvas.height = img.height * scale; ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; }; }); }

        window.openApproveModal = async (id, type) => {
            let data = null; let activeApproveId = id;
            if (type === 'meter') { const snap = await getDoc(doc(db, "meter_readings", id)); if (snap.exists()) data = snap.data(); } 
            else { if(projectTasksData[id]) data = projectTasksData[id]; }
            if (!data) return;
            
            // UPDATED: Handle View vs Review
            const isApproved = data.status === 'approved' || data.status === 'completed';
            
            document.getElementById('taskModalHeader').innerText = isApproved ? "Details View" : "Review & Approve"; 
            const photoDiv = document.getElementById('approveTaskPhotos'); photoDiv.innerHTML = "";
            
            // Hide Approve Button if already approved
            const btn = document.getElementById('confirmApproveTaskBtn');
            if(isApproved) btn.classList.add('hidden'); else btn.classList.remove('hidden');

            if (type === 'meter') {
                document.getElementById('approveTaskTitle').innerText = `${data.vehicleNo}`; document.getElementById('approveTaskCost').innerText = "Rs. " + data.totalCost.toLocaleString();
                document.getElementById('approveTaskTimeInfo').innerText = `Hrs: ${data.hours}`;
                photoDiv.innerHTML += `<img src="${data.startPhoto}" class="w-full h-40 rounded" onclick="document.getElementById('imgModalSrc').src='${data.startPhoto}';document.getElementById('imgModal').classList.remove('hidden')">`;
                photoDiv.innerHTML += `<img src="${data.endPhoto}" class="w-full h-40 rounded" onclick="document.getElementById('imgModalSrc').src='${data.endPhoto}';document.getElementById('imgModal').classList.remove('hidden')">`;
                
                btn.onclick = async () => {
                    await updateDoc(doc(db, "meter_readings", activeApproveId), { status: 'approved' });
                    await addDoc(collection(db, `projects/${data.projectId}/expenses`), { description: `Meter: ${data.vehicleNo}`, amount: data.totalCost, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() });
                    document.getElementById('taskApproveModal').classList.add('hidden');
                };
            } else {
                document.getElementById('approveTaskTitle').innerText = data.title; document.getElementById('approveTaskCost').innerText = "Rs. " + data.submittedCost.toLocaleString();
                
                // Show Task Photos (Loop through array)
                if(data.photos && data.photos.length > 0) {
                    data.photos.forEach(img => {
                        photoDiv.innerHTML += `<img src="${img}" class="w-full h-40 rounded object-cover cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${img}';document.getElementById('imgModal').classList.remove('hidden')">`;
                    });
                } else if(data.photo) { // Backward compatibility
                     photoDiv.innerHTML += `<img src="${data.photo}" class="w-full h-40 rounded object-cover cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${data.photo}';document.getElementById('imgModal').classList.remove('hidden')">`;
                }

                btn.onclick = async () => {
                    await updateDoc(doc(db, `projects/${currentProjId}/tasks/${activeApproveId}`), { status: 'completed' });
                    await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `Task: ${data.title}`, amount: data.submittedCost, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() });
                    document.getElementById('taskApproveModal').classList.add('hidden');
                };
            }
            document.getElementById('taskApproveModal').classList.remove('hidden');
        };

        window.toggleProjectView = (type) => {
            const activeDiv = document.getElementById('projectGrid');
            const closedDiv = document.getElementById('closedProjectList');
            const btnActive = document.getElementById('btn-view-active');
            const btnClosed = document.getElementById('btn-view-closed');

            if(type === 'active') {
                activeDiv.classList.remove('hidden');
                closedDiv.classList.add('hidden');
                btnActive.classList.add('bg-white', 'shadow', 'text-slate-800'); btnActive.classList.remove('text-gray-500');
                btnClosed.classList.add('text-gray-500'); btnClosed.classList.remove('bg-white', 'shadow', 'text-slate-800');
            } else {
                activeDiv.classList.add('hidden');
                closedDiv.classList.remove('hidden');
                btnClosed.classList.add('bg-white', 'shadow', 'text-slate-800'); btnClosed.classList.remove('text-gray-500');
                btnActive.classList.add('text-gray-500'); btnActive.classList.remove('bg-white', 'shadow', 'text-slate-800');
            }
        };

        window.loadProjects = () => {
            onSnapshot(query(collection(db, "projects"), orderBy("createdAt", "desc")), (snap) => {
                const grid = document.getElementById('projectGrid'); 
                const closedList = document.getElementById('closedProjectList');
                grid.innerHTML = ""; closedList.innerHTML = "";
                
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const isClosed = d.status === 'closed';
                    
                    const el = document.createElement('div');
                    
                    if(!isClosed) {
                        el.className = "bg-white p-6 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer border border-blue-100 transition relative overflow-hidden group";
                        el.onclick = () => openProject(docSnap.id, d);
                        el.innerHTML = `<div class="absolute top-0 left-0 w-2 h-full bg-slate-900 group-hover:bg-blue-600 transition"></div><h3 class="font-bold text-lg text-slate-900 pl-2">${d.name}</h3><p class="text-sm text-gray-500 pl-2"><i class="fas fa-map-marker-alt mr-1"></i> ${d.area}</p><span class="text-[10px] uppercase font-bold bg-blue-100 px-2 py-1 rounded absolute top-4 right-4 text-gray-500 tracking-wider">${d.status}</span>`;
                        grid.appendChild(el);
                    } else {
                        el.className = "bg-gray-100 p-4 rounded-xl flex justify-between items-center cursor-pointer border border-gray-200 hover:bg-gray-200";
                        el.onclick = () => openProject(docSnap.id, d);
                        el.innerHTML = `<div><h3 class="font-bold text-slate-700">${d.name}</h3><p class="text-xs text-gray-500">${d.area} (Closed)</p></div><i class="fas fa-chevron-right text-gray-400"></i>`;
                        closedList.appendChild(el);
                    }
                });
            });
        }

        window.openProject = (id, data) => {
            currentProjId = id; currentProjName = data.name; nav('detail');
            const isClosed = data.status === 'closed';
            
            document.getElementById('endDevBtn').style.display = (data.status === 'development') ? 'block' : 'none';
            document.getElementById('devPhaseUI').style.display = (data.status === 'development') ? 'grid' : 'none';
            document.getElementById('closeProjBtn').classList.add('hidden'); 

            if(currentProjUnsub) currentProjUnsub(); 
            currentProjUnsub = onSnapshot(doc(db, "projects", id), async (docSnap) => {
                if (docSnap.exists()) {
                    const pData = docSnap.data();
                    document.getElementById('detailName').innerText = pData.name; document.getElementById('detailArea').innerText = pData.area || 'Unknown'; document.getElementById('detailStatus').innerText = pData.status || 'Active';
                    const vList = document.getElementById('vehicleList'); vList.innerHTML = ""; (pData.assignedVehicles || []).forEach(v => vList.innerHTML += `<span class="bg-blue-200 px-2 py-1 rounded text-xs font-bold mr-1">${v}</span>`);
                    
                    if(pData.linkedLandId) {
                        const l = await getDoc(doc(db, "company_lands", pData.linkedLandId));
                        if(l.exists()) document.getElementById('detailLandName').innerText = l.data().name;
                    } else {
                         document.getElementById('detailLandName').innerText = "";
                    }
                }
            });
            loadBlocks(id, data.status === 'development'); loadExpensesAndProfit(id); loadProjectTasks(id);
        }

        window.endDevelopmentPhase = async () => { if(!confirm("End Development Phase?")) return; await updateDoc(doc(db, "projects", currentProjId), { status: 'active' }); alert("Development Phase Ended."); };
        
        window.closeProject = async () => {
             if(!confirm("Are you sure you want to CLOSE this project? This will remove the linked land from Assets.")) return;
             
             const pSnap = await getDoc(doc(db, "projects", currentProjId));
             const pData = pSnap.data();

             await updateDoc(doc(db, "projects", currentProjId), { status: 'closed' });

             if(pData.linkedLandId) {
                 const lSnap = await getDoc(doc(db, "company_lands", pData.linkedLandId));
                 if(lSnap.exists()) {
                     const l = lSnap.data();
                     await addDoc(collection(db, "bs_items"), {
                        date: new Date().toLocaleDateString('en-CA'),
                        name: `Project Closed (Sold): ${l.name}`,
                        type: "Current Asset",
                        amount: -l.cost, 
                        timestamp: serverTimestamp()
                    });
                 }
             }

             alert("Project Closed Successfully.");
             nav('projects');
        };

        window.assignVehicle = async () => { const vNo = document.getElementById('regVehicleNo').value; if(!vNo) return; await updateDoc(doc(db, "projects", currentProjId), { assignedVehicles: arrayUnion(vNo) }); document.getElementById('regVehicleNo').value = ""; };
        document.getElementById('addBlockBtn').addEventListener('click', async () => { const name = document.getElementById('blockName').value; const size = document.getElementById('blockSize').value; const price = document.getElementById('blockPrice').value; const pPrice = document.getElementById('blockPerchPrice').value; if(!name) return; await addDoc(collection(db, `projects/${currentProjId}/blocks`), { name, size, price: parseFloat(price), perchPrice: parseFloat(pPrice), status: "available" }); document.getElementById('blockName').value = ""; document.getElementById('blockPrice').value = ""; });
        
        window.loadProjectTasks = (pid) => {
            onSnapshot(query(collection(db, `projects/${pid}/tasks`), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('adminTaskList'); list.innerHTML = ""; projectTasksData = {}; 
                snap.forEach(d => {
                    const t = d.data(); projectTasksData[d.id] = t; 
                    let statusBadge = ""; let actionBtn = "";
                    
                    // UPDATED: Show View button even for completed tasks
                    if (t.status === 'completed') { 
                        statusBadge = '<span class="text-green-600 font-bold text-xs bg-green-100 px-2 rounded">Paid</span>'; 
                        actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-xs font-bold hover:bg-gray-300">View</button>`;
                    } 
                    else { 
                        statusBadge = '<span class="text-gray-400 text-xs bg-gray-100 px-2 rounded">Pending</span>'; 
                        actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-slate-900 text-white px-4 py-2 rounded text-xs font-bold">Review</button>`; 
                    }
                    
                    // Show Thumbnail if exists
                    let imgHtml = "";
                    if(t.photos && t.photos.length > 0) imgHtml = `<img src="${t.photos[0]}" class="w-16 h-16 rounded object-cover ml-4 border">`;
                    else if(t.photo) imgHtml = `<img src="${t.photo}" class="w-16 h-16 rounded object-cover ml-4 border">`;

                    const el = document.createElement('div'); el.className = "bg-white p-4 rounded-xl border border-blue-100 shadow-sm flex justify-between items-center";
                    el.innerHTML = `<div class="flex items-center"><div><h4 class="font-bold text-slate-800">${t.title}</h4><p class="text-xs text-gray-500">${t.description||'-'}</p><div class="mt-1">${statusBadge} ${t.submittedCost ? `<span class="ml-2 font-bold">Rs. ${t.submittedCost}</span>` : ''}</div></div>${imgHtml}</div>${actionBtn}`;
                    list.appendChild(el);
                });
            });
        }
        
        document.getElementById('saveTaskBtn').addEventListener('click', async () => { 
             const title = document.getElementById('newTaskTitle').value;
             const desc = document.getElementById('newTaskDesc').value;
             const file = document.getElementById('taskPhoto').files[0];
             let photoBase64 = null;
             
             if(file) photoBase64 = await processImage(file);

             await addDoc(collection(db, `projects/${currentProjId}/tasks`), { 
                 title, description: desc, status: 'new', photo: photoBase64, createdAt: serverTimestamp() 
             }); 
             document.getElementById('newTaskModal').classList.add('hidden'); 
        });
        
        window.loadMeterReadings = () => { onSnapshot(query(collection(db, "meter_readings"), orderBy("timestamp", "desc")), (snap) => { const list = document.getElementById('readingsList'); list.innerHTML = ""; snap.forEach(d => { const r = d.data(); const el = document.createElement('div'); el.className = "bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex gap-4"; el.innerHTML = `<div class="flex-1"><h4 class="font-bold text-lg text-slate-800">${r.vehicleNo}</h4><p class="text-lg text-blue-600 font-bold">Rs. ${r.totalCost.toLocaleString()}</p>${r.status!=='approved' ? `<button onclick="openApproveModal('${d.id}', 'meter')" class="mt-2 bg-green-600 text-white px-4 py-1 rounded shadow text-sm font-bold">Review</button>` : `<button onclick="openApproveModal('${d.id}', 'meter')" class="mt-2 bg-gray-200 text-gray-700 px-4 py-1 rounded shadow text-sm font-bold">View</button>`}</div>`; list.appendChild(el); }); }); }

        window.processSale = async (downloadPdf) => {
            const nic = document.getElementById('cusNIC').value; const name = document.getElementById('cusName').value; const phone = document.getElementById('cusPhone').value; const address = document.getElementById('cusAddress').value;
            if(!nic || !name) return alert("Customer Name and NIC are required!");
            let customerId = ""; const q = query(collection(db, "customers"), where("nic", "==", nic)); const snap = await getDocs(q);
            if(!snap.empty) { customerId = snap.docs[0].data().customerId; await updateDoc(snap.docs[0].ref, { name, phone, address }); } 
            else { customerId = "CUS-" + Math.floor(100000 + Math.random() * 900000); await addDoc(collection(db, "customers"), { customerId, name, nic, phone, address, joinedDate: new Date(), projectName: currentProjName, projectId: currentProjId, blockName: selectedBlockData.name, blockId: selectedBlockId }); }
            
            const cus = { customerId, name, address, nic, phone }; const advance = parseFloat(document.getElementById('advancePay').value); const price = parseFloat(document.getElementById('finalPrice').value); const plan = document.getElementById('payPlanType').value; const planFee = parseFloat(document.getElementById('planFee').value) || 0; const deedFee = parseFloat(document.getElementById('deedFee').value) || 0;
            const salesperson = document.getElementById('salesPersonInput').value;
            let ep = {}; let nextD = null; let status = 'sold'; 
            if(plan === 'EP') { const cycle = parseInt(document.getElementById('epCycle').value); const agreeFee = parseFloat(document.getElementById('epAgreeFee').value) || 15000; ep = { rate: document.getElementById('epRate').value, months: document.getElementById('epMonths').value, cycleDays: cycle, totalPayable: parseFloat(document.getElementById('epTotalPayable').innerText), paidAmount: advance, agreementFee: agreeFee }; const d = new Date(); d.setDate(d.getDate() + cycle); nextD = d; } else { if(advance >= price - 10) status = 'sold_finished'; }
            if(salesperson) { const comm = price * 0.0075; await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `Commission: ${salesperson} (Block ${selectedBlockData.name})`, amount: comm, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() }); await recordDailyTransaction(`Commission: ${salesperson}`, comm, 'expense', currentProjName); }
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { status: status, soldPrice: price, customer: cus, soldDate: new Date(), fees: { planFee, deedFee }, payment: { totalPrice: price, advancePaid: advance, planType: plan, epDetails: ep, nextPaymentDate: nextD, history: [{date: new Date(), amount: advance, type: 'Advance'}] } });
            await recordDailyTransaction(`Sale Advance: ${selectedBlockData.name} - ${cus.name}`, advance, 'income', currentProjName);
            closeSellModal();
            if(downloadPdf) {
                 document.getElementById('newPayAmount').value = advance;
                 document.getElementById('newPayDate').valueAsDate = new Date();
                 downloadPaymentReceipt();
            }
        };

        window.openPaymentModal = async (data) => {
            selectedBlockData = data; document.getElementById('paymentModal').classList.remove('hidden');
            const isFin = data.status === 'sold_finished'; const isEP = data.payment.planType === 'EP';
            document.getElementById('addPaymentSection').style.display = isFin ? 'none' : 'block'; document.getElementById('editPlanBtn').style.display = (isFin || !isEP) ? 'none' : 'block'; document.getElementById('resellBtn').classList.toggle('hidden', isFin); document.getElementById('paymentCompleteMsg').classList.toggle('hidden', !isFin);
            document.getElementById('payBlockInfo').innerText = `${data.name} - ${data.customer.name}`; document.getElementById('viewCusId').innerText = data.customer.customerId || "N/A"; document.getElementById('viewCusNIC').innerText = data.customer.nic || "N/A"; document.getElementById('viewCusPhone').innerText = data.customer.phone || "N/A"; document.getElementById('viewCusAddr').innerText = data.customer.address || "N/A";
            let total = 0, paid = 0; if(isEP) { total = data.payment.epDetails.totalPayable; paid = data.payment.epDetails.paidAmount || 0; } else { total = data.soldPrice; paid = (data.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0); }
            document.getElementById('pmTotal').innerText = total.toLocaleString(); document.getElementById('pmPaid').innerText = paid.toLocaleString(); document.getElementById('pmBalance').innerText = (total-paid).toLocaleString();
            
            if(isEP) {
                const rate = parseFloat(data.payment.epDetails.rate);
                const bal = total - paid;
                let tempBal = bal, futureTotal = 0, remMonths = parseInt(data.payment.epDetails.months) || 12;
                const soldDate = data.soldDate.seconds ? new Date(data.soldDate.seconds*1000) : new Date(data.soldDate);
                const today = new Date();
                let elapsed = (today.getFullYear() - soldDate.getFullYear()) * 12 + (today.getMonth() - soldDate.getMonth());
                remMonths = Math.max(1, remMonths - elapsed);
                const monthlyPrincipal = tempBal / remMonths;
                for(let i=0; i<remMonths; i++) {
                    const interest = tempBal * (rate/100/12);
                    futureTotal += (monthlyPrincipal + interest);
                    tempBal -= monthlyPrincipal;
                }
                document.getElementById('epRealtimeFuture').innerText = "Rs. " + futureTotal.toLocaleString(undefined, {maximumFractionDigits: 0});
            } else {
                document.getElementById('epRealtimeFuture').innerText = "N/A";
            }
            
            const tbody = document.getElementById('paymentHistoryList'); tbody.innerHTML = ""; (data.payment.history||[]).forEach(h => { const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date); tbody.innerHTML += `<tr><td class="py-2">${d.toLocaleDateString()}</td><td class="font-bold">Rs.${(h.amount||0).toLocaleString()}</td><td class="text-gray-500">${h.type}</td></tr>`; }); document.getElementById('newPayDate').valueAsDate = new Date(); updateCycleUI(data);
        };

        window.downloadPaymentReceipt = async () => {
             const amt = parseFloat(document.getElementById('newPayAmount').value || 0);
             const date = document.getElementById('newPayDate').value;
             const cus = selectedBlockData.customer;
             const html = `<div class="receipt-box"><div class="receipt-header"><img src="ico.jpeg" class="receipt-logo" onerror="this.src='https://via.placeholder.com/80'"><div style="text-align:right;"><h2 class="receipt-title">OFFICIAL RECEIPT</h2><p>Sithuliya Real Estate</p><p style="font-size:12px;">Kurunegala, Sri Lanka</p></div></div><div style="margin-bottom:20px; font-size:14px;"><p><strong>Date:</strong> ${date}</p><p><strong>Receipt No:</strong> #${Math.floor(10000 + Math.random() * 90000)}</p></div><div style="border-top:2px solid #eee; border-bottom:2px solid #eee; padding:15px 0;"><div class="receipt-row"><span class="receipt-label">Customer Name</span><span class="receipt-value">${cus.name}</span></div><div class="receipt-row"><span class="receipt-label">Customer NIC</span><span class="receipt-value">${cus.nic}</span></div><div class="receipt-row"><span class="receipt-label">Project</span><span class="receipt-value">${selectedBlockData.projectName || currentProjName}</span></div><div class="receipt-row"><span class="receipt-label">Block Number</span><span class="receipt-value">${selectedBlockData.name}</span></div><div class="receipt-row"><span class="receipt-label">Payment Plan</span><span class="receipt-value">${selectedBlockData.payment.planType}</span></div></div><div style="margin-top:20px; background:#f9f9f9; padding:15px;"><div class="receipt-row" style="font-size:18px;"><span class="receipt-label">AMOUNT PAID</span><span class="receipt-value">Rs. ${amt.toLocaleString()}.00</span></div></div><div class="receipt-footer"><div><div class="sign-line">Cashier Signature</div></div><div><div class="sign-line">Customer Signature</div></div></div><p style="text-align:center; font-size:10px; margin-top:20px; color:#888;">Thank you for your business!</p></div>`;
             document.getElementById('printContainer').innerHTML = html;
             document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        window.downloadPaymentHistory = async () => {
            let rows = ""; (selectedBlockData.payment.history || []).forEach(h => { const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date); rows += `<tr><td style="border-bottom:1px solid #ddd; padding:8px;">${d.toLocaleDateString()}</td><td style="border-bottom:1px solid #ddd; padding:8px;">${h.type}</td><td style="border-bottom:1px solid #ddd; padding:8px; text-align:right">Rs. ${h.amount.toLocaleString()}</td></tr>`; });
            document.getElementById('printContainer').innerHTML = `<h2 class="text-center text-xl underline mb-4">PAYMENT HISTORY</h2><table style="width:100%; border-collapse:collapse; margin-top:20px;"><thead><tr style="background:#f2f2f2;"><th>Date</th><th>Type</th><th style="text-align:right">Amount</th></tr></thead><tbody>${rows}</tbody></table>`;
            document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        function updateCycleUI(data) {
            const container = document.getElementById('epCycleSection');
            if (data.payment.planType !== 'EP') { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            
            const fill = document.getElementById('cycleProgressBar');
            const label = document.getElementById('cycleStatusLabel');
            const daysLabel = document.getElementById('cycleDaysLeft');
            
            document.getElementById('dispRate').innerText = (data.payment.epDetails.rate || 0) + "%";
            document.getElementById('dispMonths').innerText = (data.payment.epDetails.months || 0) + " M";

            const nextD = data.payment.nextPaymentDate.seconds ? new Date(data.payment.nextPaymentDate.seconds*1000) : new Date(data.payment.nextPaymentDate);
            const cycleDays = parseInt(data.payment.epDetails.cycleDays || 30);
            const today = new Date();
            const startD = new Date(nextD); startD.setDate(startD.getDate() - cycleDays);

            if (today <= nextD) {
                const totalTime = nextD - startD, elapsed = today - startD;
                const percent = Math.min(100, Math.max(0, (elapsed / totalTime) * 100));
                fill.style.width = percent + "%"; fill.className = "h-full progress-bar-fill bg-blue-500";
                label.innerText = "Cycle Progress"; label.className = "text-[10px] font-bold uppercase text-blue-600";
                daysLabel.innerText = Math.ceil((nextD - today)/(1000*60*60*24)) + " days left";
            } else {
                const diffTime = today - nextD;
                const diffDays = diffTime / (1000*60*60*24);
                const gracePercent = Math.min(100, (diffDays / 5) * 100);
                fill.style.width = gracePercent + "%"; fill.className = "h-full progress-bar-fill bg-red-600";
                label.innerText = "OVERDUE (Grace Period)"; label.className = "text-[10px] font-bold uppercase text-red-600 animate-pulse";
                daysLabel.innerText = "Penalty in " + Math.max(0, Math.ceil(5 - diffDays)) + " days";
                if (diffDays >= 5) applyLatePenalty(data);
            }

            const rate = parseFloat(data.payment.epDetails.rate) || 15;
            const totalMonths = parseFloat(data.payment.epDetails.months) || 60;
            const currentBal = data.payment.epDetails.totalPayable - (data.payment.epDetails.paidAmount || 0);
            const soldDate = data.soldDate.seconds ? new Date(data.soldDate.seconds*1000) : new Date(data.soldDate);
            let monthsPassed = (today.getFullYear() - soldDate.getFullYear()) * 12 + (today.getMonth() - soldDate.getMonth());
            if(monthsPassed <= 0) monthsPassed = 1;
            let remMonths = Math.max(1, totalMonths - monthsPassed);
            const monthlyInt = currentBal * (rate / 100 / 12);
            const monthlyPrin = currentBal / remMonths;
            const totalDueNow = monthlyInt + monthlyPrin;
            document.getElementById('epNextDueAmt').innerText = "Rs. " + totalDueNow.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('epNextDueDetail').innerText = `(Prin: ${monthlyPrin.toFixed(0)} + Int: ${monthlyInt.toFixed(0)})`;
        }
        
        async function applyLatePenalty(data) {
            const lastHist = data.payment.history[data.payment.history.length-1];
            if (lastHist && lastHist.type.includes('Penalty') && new Date(lastHist.date.seconds*1000).toDateString() === new Date().toDateString()) return;

            const bal = data.payment.epDetails.totalPayable - data.payment.epDetails.paidAmount;
            const penalty = bal * 0.04;
            const newTotal = data.payment.epDetails.totalPayable + penalty;
            const newNext = new Date(); newNext.setDate(newNext.getDate() + parseInt(data.payment.epDetails.cycleDays || 30));

            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), {
                "payment.epDetails.totalPayable": newTotal, 
                "payment.nextPaymentDate": newNext,
                "payment.history": arrayUnion({date: new Date(), amount: 0, type: 'Late Penalty (4%)', note: 'Added automatically'})
            });
            await addDoc(collection(db, "notifications"), { title: "Penalty Applied", message: `4% added to ${data.customer.name}`, timestamp: serverTimestamp() });
        }

        window.toggleEditPlan = () => document.getElementById('editPlanSection').classList.toggle('hidden');
        document.getElementById('savePlanChangesBtn').addEventListener('click', async () => {
            const rate = parseFloat(document.getElementById('editNewRate').value); const months = parseFloat(document.getElementById('editNewMonths').value); if(!rate || !months) return alert("Please enter valid Rate and Months");
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { "payment.epDetails.rate": rate, "payment.epDetails.months": months }); alert("Updated!"); document.getElementById('paymentModal').classList.add('hidden');
        });

        document.getElementById('submitPayBtn').addEventListener('click', async () => {
            const amt = parseFloat(document.getElementById('newPayAmount').value); 
            if(!amt) return;
            const b = selectedBlockData;
            let updateData = { "payment.history": arrayUnion({date: new Date(), amount: amt, type: 'Payment'}) };
            let currentPaid = 0, totalDue = 0;

            if (b.payment.planType === 'EP') {
                const rate = parseFloat(b.payment.epDetails.rate)||15;
                const totalMonths = parseFloat(b.payment.epDetails.months)||60;
                const soldDate = b.soldDate.seconds ? new Date(b.soldDate.seconds*1000) : new Date(b.soldDate);
                const today = new Date();
                let monthsPassed = (today.getFullYear() - soldDate.getFullYear()) * 12 + (today.getMonth() - soldDate.getMonth());
                if(monthsPassed <= 0) monthsPassed = 1;
                const principal = b.soldPrice - b.payment.advancePaid;
                const interestForElapsed = principal * (rate / 100 / 12) * monthsPassed;
                const fairTotalPayable = principal + interestForElapsed + b.payment.advancePaid;
                const fairBalance = fairTotalPayable - (b.payment.epDetails.paidAmount || 0);

                if (amt >= (fairBalance - 100)) { 
                     const finalTotal = (b.payment.epDetails.paidAmount || 0) + amt;
                     updateData["payment.epDetails.paidAmount"] = finalTotal;
                     updateData["payment.epDetails.totalPayable"] = finalTotal; 
                     updateData["status"] = "sold_finished";
                     updateData["payment.history"] = arrayUnion({date: new Date(), amount: amt, type: 'Final Settlement'}, {date: new Date(), amount: 0, type: 'Interest Adjustment', note: `Waived future interest. Settled in ${monthsPassed} months.`});
                     await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), updateData);
                     await recordDailyTransaction(`Settlement: ${b.name}`, amt, 'income', currentProjName);
                     document.getElementById('paymentModal').classList.add('hidden');
                     alert("Early Settlement Complete!"); return;
                }
                const cycleDays = parseInt(b.payment.epDetails.cycleDays || 30);
                const initBal = b.soldPrice - b.payment.advancePaid;
                const monthlyIntAvg = initBal * (rate / 100 / 12); 
                const stdInst = (initBal / totalMonths) + monthlyIntAvg;
                const monthsCovered = Math.floor(amt / stdInst);
                let interestRebate = 0, cyclesToPush = 1; 
                if (monthsCovered >= 2) { interestRebate = monthlyIntAvg * (monthsCovered - 1); cyclesToPush = monthsCovered; }
                let newTotalPayable = b.payment.epDetails.totalPayable - interestRebate;
                if(interestRebate > 0) { updateData["payment.history"] = arrayUnion({date: new Date(), amount: amt, type: 'Payment'}, {date: new Date(), amount: 0, type: 'Interest Rebate', note: `Paid ${monthsCovered} months.`}); }
                const newPaid = (b.payment.epDetails.paidAmount||0) + amt;
                const nextD = new Date(b.payment.nextPaymentDate.seconds*1000); 
                const isOverdue = new Date() > nextD;
                let baseDate = isOverdue ? new Date() : nextD;
                baseDate.setDate(baseDate.getDate() + (cycleDays * cyclesToPush));
                updateData["payment.epDetails.paidAmount"] = newPaid;
                updateData["payment.epDetails.totalPayable"] = newTotalPayable;
                updateData["payment.nextPaymentDate"] = baseDate;
                totalDue = newTotalPayable; currentPaid = newPaid;
            } else {
                totalDue = b.soldPrice;
                const prevPaid = (b.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0);
                currentPaid = prevPaid + amt;
            }

            if (currentPaid >= totalDue - 10) updateData["status"] = "sold_finished";
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), updateData);
            await recordDailyTransaction(`Payment: ${b.name}`, amt, 'income', currentProjName);
            document.getElementById('paymentModal').classList.add('hidden');
            alert("Payment Added!");
        });

        window.processResell = async () => { if(!confirm("Cancel sale?")) return; const b = selectedBlockData; const paid = b.payment.epDetails ? b.payment.epDetails.paidAmount : b.soldPrice; await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `REFUND: ${b.name}`, amount: paid, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() }); await recordDailyTransaction(`REFUND: ${b.name}`, paid, 'expense', currentProjName); await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { status: 'available', customer: null, payment: null, soldPrice: null, soldDate: null }); alert("Cancelled!"); document.getElementById('paymentModal').classList.add('hidden'); };
        document.getElementById('saveExpenseBtn').addEventListener('click', async () => { const amt = parseFloat(document.getElementById('expAmount').value); const desc = document.getElementById('expDesc').value; await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: desc, amount: amt, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() }); await recordDailyTransaction(`Expense: ${desc}`, amt, 'expense', currentProjName); document.getElementById('expenseModal').classList.add('hidden'); });
        async function checkOverduePayments() { const blocksQ = query(collectionGroup(db, 'blocks'), where('status', '==', 'sold')); const snap = await getDocs(blocksQ); const list = document.getElementById('notifList'); list.innerHTML = ""; let count = 0; snap.forEach(d => { const b = d.data(); if(b.payment && b.payment.planType === 'EP' && b.payment.nextPaymentDate) { const nextD = b.payment.nextPaymentDate.seconds ? new Date(b.payment.nextPaymentDate.seconds*1000) : new Date(b.payment.nextPaymentDate); if(nextD < new Date()) { count++; list.innerHTML += `<div class="p-3 border-b bg-red-50"><p class="font-bold text-xs">${b.name}</p><p class="text-[10px] text-red-500">Overdue: ${nextD.toLocaleDateString()}</p></div>`; } } }); if(count > 0) { document.getElementById('notifBadge').innerText = count; document.getElementById('notifBadge').classList.remove('hidden'); } }
        window.calcBlockPrice = () => { document.getElementById('blockPrice').value = (parseFloat(document.getElementById('blockSize').value)||0) * (parseFloat(document.getElementById('blockPerchPrice').value)||0); };
        window.toggleEPFields = () => { const isEP = document.getElementById('payPlanType').value === 'EP'; document.getElementById('epFields').classList.toggle('hidden', !isEP); if(isEP) window.calculateEP(); };
        window.calculateEP = () => { 
            const price = parseFloat(document.getElementById('finalPrice').value)||0; const advance = parseFloat(document.getElementById('advancePay').value)||0; const deedFee = (price * 0.05) - 1000; document.getElementById('deedFee').value = deedFee > 0 ? deedFee : 0;
            const rate = parseFloat(document.getElementById('epRate').value)||15, months = parseFloat(document.getElementById('epMonths').value)||60; const balance = price - advance; if(balance < 0) return; const totalInterestSimple = balance * (rate/100) * (months/12); document.getElementById('epTotalPayable').innerText = (balance + totalInterestSimple).toFixed(2); document.getElementById('epMonthlyInst').innerText = ((balance/months) + (balance*(rate/100/12))).toFixed(2) + " (1st Mo)"; 
        };
        
        function loadExpensesAndProfit(pid) { 
            const container = document.getElementById('blocksContainer');
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { 
                let inc = 0; 
                let allSold = true;
                
                snap.forEach(d => { 
                    const b = d.data(); 
                    if(b.status.includes('sold')) inc += (b.soldPrice || 0); 
                    if(b.status === 'available') allSold = false;
                }); 
                
                document.getElementById('finIncome').innerText = "Rs. " + inc.toLocaleString(); 
                updateNet(inc, null); 
                
                // Show/Hide Close Project Button
                const closeBtn = document.getElementById('closeProjBtn');
                if(allSold && snap.size > 0 && document.getElementById('detailStatus').innerText !== 'closed') {
                    closeBtn.classList.remove('hidden');
                } else {
                    closeBtn.classList.add('hidden');
                }
            }); 
            
            onSnapshot(query(collection(db, `projects/${pid}/expenses`), orderBy("date","desc")), (snap) => { 
                let exp = 0; const list = document.getElementById('expenseList'); list.innerHTML = ""; 
                snap.forEach(d => { const e = d.data(); exp += e.amount; list.innerHTML += `<tr class="border-b"><td class="p-3 text-gray-500">${e.date}</td><td class="p-3 font-bold">${e.description}</td><td class="p-3 text-right text-red-600">-${e.amount.toLocaleString()}</td></tr>`; }); 
                document.getElementById('finExpense').innerText = "Rs. " + exp.toLocaleString(); updateNet(null, exp); 
            }); 
        }
        let cInc=0, cExp=0; function updateNet(i,e) { if(i!==null) cInc=i; if(e!==null) cExp=e; const net = cInc-cExp; document.getElementById('finProfit').innerText = "Rs. " + net.toLocaleString(); document.getElementById('finProfit').className = `text-3xl font-bold relative z-10 ${net>=0?'text-slate-800':'text-red-600'}`; }
        function loadBlocks(pid, isDevMode) { const container = document.getElementById('blocksContainer'); onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { container.innerHTML = ""; snap.forEach(d => { const b = d.data(); const isSold = b.status === 'sold', isFin = b.status === 'sold_finished'; const bg = isFin ? 'bg-slate-800 text-white' : (isSold ? 'bg-red-50 border-red-200' : 'bg-white border-blue-100 hover:border-blue-400'); const el = document.createElement('div'); el.className = `p-4 border-2 rounded-xl text-center cursor-pointer relative overflow-hidden ${bg}`; el.innerHTML = `<h4 class="font-bold text-xl">${b.name}</h4><p class="text-xs ${isFin?'text-gray-400':'text-gray-500'}">${b.size}P</p><p class="font-bold mt-2 ${isFin?'text-green-400':(isSold?'text-red-600':'text-blue-600')}">${isFin?'CLOSED':(isSold?'SOLD':`Rs.${b.price.toLocaleString()}`)}</p>`; el.onclick = () => { selectedBlockId = d.id; selectedBlockData = b; if(isSold||isFin) openPaymentModal(b); else openSellModal(); }; container.appendChild(el); }); }); }
        function openSellModal() { document.getElementById('sellModal').classList.remove('hidden'); document.getElementById('sellBlockName').innerText = selectedBlockData.name; document.getElementById('finalPrice').value = selectedBlockData.price; document.getElementById('payPlanType').value = "Cash"; toggleEPFields(); }
        
        function initApp() { loadProjects(); checkOverduePayments(); }
        window.initApp = initApp;
    </script>
</body>
</html>

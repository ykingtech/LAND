<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sithuliya Admin Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .luxury-font { font-family: 'Playfair Display', serif; }
        .glass-dark { background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #pdfPreviewOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 10000; overflow-y: auto; padding: 40px; display: none;
        }
        .print-container {
            max-width: 210mm; margin: 0 auto; background: white; padding: 20px; color: black; font-family: 'Times New Roman', serif;
        }
        /* New Transition for Progress Bar */
        .progress-bar-fill { transition: width 0.8s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">

    <div id="pdfPreviewOverlay">
        <div class="print-container">
            <div class="text-center mb-8 border-b-2 border-black pb-4">
                <h1 class="text-4xl font-bold uppercase tracking-widest mb-2">Sithuliya Real Estate</h1>
                <p class="text-sm">No. 85, Ihala Kadigamuwa | 077-2338929</p>
                <h2 id="overlayPrintTitle" class="text-2xl font-bold mt-4 underline decoration-double">REPORT</h2>
                <p id="overlayPrintDate" class="text-sm mt-1"></p>
            </div>
            <div id="overlayPrintContent" class="w-full text-lg"></div>
            <div class="mt-16 flex justify-between text-sm pt-8">
                <div class="text-center w-48 border-t border-black pt-2">Prepared By</div>
                <div class="text-center w-48 border-t border-black pt-2">Authorized By</div>
            </div>
        </div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 cursor-pointer backdrop-blur-sm" onclick="closeImgModal()">
        <img id="imgModalSrc" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl border border-gray-600">
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1600596542815-2a429b08e695?q=80&w=2070&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="relative z-10 glass-dark p-10 rounded-3xl shadow-2xl w-96 text-center border border-white/10">
            <div class="mb-8">
                <i class="fas fa-gem text-5xl text-amber-500 mb-4 drop-shadow-lg"></i>
                <h1 class="text-4xl text-white luxury-font tracking-wide">Sithuliya</h1>
                <p class="text-amber-500/90 text-xs uppercase tracking-[0.4em] mt-2">Exclusive Real Estate</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="loginPass" class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-400 focus:outline-none focus:border-amber-500 text-center tracking-widest" placeholder="Password">
                <button onclick="attemptLogin()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg shadow-lg transition">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden flex h-full">
        <div class="w-64 bg-slate-900 text-white shadow-2xl flex flex-col z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-800">
                <h2 class="text-2xl luxury-font text-amber-500">Sithuliya <span class="text-[10px] font-sans text-slate-500 block tracking-widest mt-1">ADMIN CONSOLE</span></h2>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="nav('projects')" id="nav-projects" class="nav-btn w-full text-left p-3 rounded-xl bg-amber-600/20 text-amber-500 font-bold border border-amber-600/30"><i class="fas fa-map-marked-alt mr-3"></i> Projects</button>
                <button onclick="nav('readings')" id="nav-readings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tachometer-alt mr-3"></i> Meter Approvals</button>
                <button onclick="nav('reports')" id="nav-reports" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-file-invoice-dollar mr-3"></i> Financial Center</button>
                <div class="pt-8 border-t border-slate-800 mt-8">
                    <button onclick="nav('settings')" id="nav-settings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-cog mr-3"></i> Settings</button>
                </div>
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 px-8 border-b">
                <div class="relative w-96 group">
                    <input type="text" id="projSearch" placeholder="Search Customer ID, Name, Phone..." class="w-full pl-10 pr-4 py-2 border-none bg-gray-100 rounded-full focus:ring-2 focus:ring-amber-500 transition text-sm group-hover:bg-gray-200">
                    <i class="fas fa-search absolute left-4 top-2.5 text-gray-400"></i>
                    <div id="searchResults" class="hidden absolute top-12 left-0 w-full bg-white shadow-2xl rounded-xl border border-gray-100 max-h-96 overflow-y-auto p-2 z-50"></div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="relative cursor-pointer" onclick="toggleNotifPanel()">
                        <div class="relative">
                            <i id="bellIcon" class="fas fa-bell text-gray-400 text-xl hover:text-slate-800 transition"></i>
                            <span id="notifBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">0</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('newProjectModal').classList.remove('hidden')" class="bg-slate-900 text-white px-5 py-2 rounded-full hover:bg-slate-800 shadow-lg shadow-slate-900/20 text-sm font-bold transition transform hover:scale-105"><i class="fas fa-plus mr-2"></i> New Project</button>
                </div>
            </header>

            <div id="notifPanel" class="hidden absolute top-20 right-8 w-96 bg-white shadow-2xl rounded-xl border border-gray-100 z-50 overflow-hidden animate-fade-in-down">
                <div class="bg-slate-900 p-3 text-white text-sm font-bold flex justify-between items-center">
                    <span><i class="fas fa-exclamation-circle mr-2"></i>Notifications</span>
                    <button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
                </div>
                <div id="notifList" class="max-h-80 overflow-y-auto bg-gray-50"></div>
            </div>

            <main class="flex-1 overflow-auto p-8">
                
                <div id="page-projects">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Active Developments</h2>
                    <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="page-detail" class="hidden pb-20">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <button onclick="nav('projects')" class="text-gray-400 hover:text-slate-800 mb-2 font-bold text-xs uppercase tracking-wide"><i class="fas fa-arrow-left mr-2"></i> Back to Dashboard</button>
                            <h1 id="detailName" class="text-4xl font-bold text-slate-900 luxury-font">Project Name</h1>
                            <p class="text-gray-500 flex items-center mt-1 text-sm"><i class="fas fa-map-marker-alt mr-2 text-amber-500"></i> <span id="detailArea">Area</span></p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span id="detailStatus" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-amber-100 text-amber-800 border border-amber-200">Development</span>
                            <button id="endDevBtn" onclick="endDevelopmentPhase()" class="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200 font-bold">End Development Phase</button>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto hide-scrollbar">
                        <button onclick="subTab('overview')" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-slate-800 sub-tab whitespace-nowrap" id="st-overview">Overview & Blocks</button>
                        <button onclick="subTab('tasks')" class="px-6 py-3 font-bold text-gray-400 hover:text-slate-600 sub-tab whitespace-nowrap" id="st-tasks">Site Tasks & Costs</button>
                        <button onclick="subTab('finance')" class="px-6 py-3 font-bold text-gray-400 hover:text-slate-600 sub-tab whitespace-nowrap" id="st-finance">Financials</button>
                    </div>

                    <div id="view-overview">
                        <div id="devPhaseUI" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Add Land Blocks</h3>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input type="text" id="blockName" placeholder="No (e.g. A1)" class="p-2 border rounded w-20 text-sm">
                                    <input type="number" id="blockSize" placeholder="Perches" class="p-2 border rounded w-24 text-sm" oninput="calcBlockPrice()">
                                    <input type="number" id="blockPerchPrice" placeholder="Price/Perch" class="p-2 border rounded w-32 text-sm" oninput="calcBlockPrice()">
                                    <input type="number" id="blockPrice" placeholder="Total Price" class="p-2 border rounded flex-1 bg-gray-50 font-bold text-slate-700 text-sm" readonly>
                                    <button id="addBlockBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 shadow"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Assigned Vehicles</h3>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="regVehicleNo" placeholder="Vehicle Number (e.g. WP-1234)" class="p-2 border rounded w-full uppercase text-sm">
                                    <button id="regVehicleBtn" onclick="assignVehicle()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900 shadow">Assign</button>
                                </div>
                                <div id="vehicleList" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-slate-700">Land Blocks Map</h3>
                        <div id="blocksContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>

                    <div id="view-tasks" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Site Operations</h3>
                            <button onclick="document.getElementById('newTaskModal').classList.remove('hidden')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900"><i class="fas fa-plus mr-2"></i> Assign Task</button>
                        </div>
                        <div id="adminTaskList" class="space-y-4"></div>
                    </div>

                    <div id="view-finance" class="hidden">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-2xl text-slate-800 luxury-font">Profit Analysis</h3>
                                <div class="flex gap-2">
                                    <button onclick="downloadFinancialReport()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold border hover:bg-slate-800 transition"><i class="fas fa-file-download mr-2"></i> Report</button>
                                    <button onclick="openExpenseModal()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 transition"><i class="fas fa-receipt mr-2"></i> Add Misc Expense</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="p-6 rounded-xl bg-green-50 border border-green-100">
                                    <p class="text-xs text-green-600 uppercase font-bold tracking-widest mb-2">Revenue (Sold)</p>
                                    <h4 id="finIncome" class="text-3xl font-bold text-green-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-red-50 border border-red-100">
                                    <p class="text-xs text-red-600 uppercase font-bold tracking-widest mb-2">Cost (Exp + Tasks)</p>
                                    <h4 id="finExpense" class="text-3xl font-bold text-red-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-slate-50 border border-slate-200 relative overflow-hidden">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent"></div>
                                    <p class="text-xs text-slate-600 uppercase font-bold tracking-widest mb-2 relative z-10">Net Profit</p>
                                    <h4 id="finProfit" class="text-3xl font-bold text-slate-800 relative z-10">Rs. 0.00</h4>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Expense Ledger</h3>
                        <table class="w-full text-sm text-left bg-white rounded-lg overflow-hidden shadow-sm"><tbody id="expenseList"></tbody></table>
                    </div>
                </div>

                <div id="page-readings" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">Meter Approvals</h2>
                    <div id="readingsList" class="space-y-4"></div>
                </div>

                <div id="page-reports" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Financial Center</h2>
                    <div class="flex border-b border-gray-200 mb-6">
                        <button onclick="switchFinTab('entry')" id="ft-entry" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-slate-800 transition">Data Entry</button>
                        <button onclick="switchFinTab('reports')" id="ft-reports" class="px-6 py-3 font-bold text-gray-400 hover:text-slate-600 transition">View Reports</button>
                    </div>

                    <div id="fin-view-entry">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-coins text-amber-500 mr-2"></i> Transaction Entry</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="txDate" class="w-full p-2 border rounded bg-gray-50"></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Voucher No</label><input type="text" id="txVno" class="w-full p-2 border rounded bg-gray-50"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Description</label><input type="text" id="txDesc" class="w-full p-2 border rounded bg-gray-50"></div>
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="txType" class="w-full p-2 border rounded bg-gray-50"><option value="Expense">Expense</option><option value="Income">Income</option></select></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Amount</label><input type="number" id="txAmount" class="w-full p-2 border rounded bg-gray-50 font-bold"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Category</label><select id="txCategory" class="w-full p-2 border rounded bg-gray-50"><optgroup label="Income"><option value="Sales">Revenue</option><option value="Other Income">Other</option></optgroup><optgroup label="Expenses"><option value="Admin Expense">Admin</option><option value="Petty Cash">Petty Cash</option></optgroup></select></div>
                                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="txIsPetty" class="w-4 h-4 text-amber-500 rounded"><label for="txIsPetty" class="text-sm font-bold text-slate-700">Petty Cash Record</label></div>
                                    <button onclick="saveTransaction()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 mt-4 shadow-lg">SAVE TRANSACTION</button>
                                </div>
                            </div>
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 h-fit">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-balance-scale text-blue-500 mr-2"></i> Balance Sheet Entry</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="bsDate" class="w-full p-2 border rounded bg-gray-50"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Account</label><input type="text" id="bsName" class="w-full p-2 border rounded bg-gray-50"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="bsType" class="w-full p-2 border rounded bg-gray-50"><option value="Non-Current Asset">Asset (Fixed)</option><option value="Current Asset">Asset (Current)</option><option value="Equity">Equity</option><option value="Current Liability">Liability</option></select></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Value</label><input type="number" id="bsAmount" class="w-full p-2 border rounded bg-gray-50 font-bold"></div>
                                    <button onclick="saveBSItem()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 mt-4 shadow-lg">SAVE ITEM</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="fin-view-reports" class="hidden">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-wrap gap-4 items-center mb-6">
                            <input type="date" id="repFrom" class="p-2 border rounded bg-gray-50 text-sm"> <input type="date" id="repTo" class="p-2 border rounded bg-gray-50 text-sm">
                            <button onclick="genReport('daybook')" class="px-4 py-2 bg-slate-100 text-slate-800 rounded text-sm font-bold">Day Book</button>
                            <button onclick="genReport('petty')" class="px-4 py-2 bg-amber-50 text-amber-700 rounded text-sm font-bold">Petty Cash</button>
                            <button onclick="genReport('pnl')" class="px-4 py-2 bg-green-50 text-green-700 rounded text-sm font-bold">P & L</button>
                            <button onclick="genReport('bs')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Balance Sheet</button>
                        </div>
                        <div id="reportOutputArea" class="bg-white p-8 rounded-2xl shadow border border-gray-100 min-h-[400px]">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-400 uppercase tracking-widest text-sm">Report Preview</h3><button onclick="triggerPDFDownload()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold">Download PDF</button></div>
                            <div id="reportContent" class="overflow-x-auto border rounded-lg p-4 bg-gray-50 text-sm"><p class="text-center text-gray-400 py-10">Select date range & type.</p></div>
                        </div>
                    </div>
                </div>

                <div id="page-settings" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 max-w-md">
                        <h3 class="font-bold text-lg mb-4 text-amber-600">Change Admin Password</h3>
                        <input type="password" id="newAdminPass" placeholder="New Password" class="w-full p-3 border rounded-lg mb-4">
                        <button onclick="updatePassword()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800">Update Password</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="newProjectModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-xl font-bold mb-6 text-slate-800">New Project</h2>
            <input type="text" id="newProjName" placeholder="Project Name" class="w-full p-3 border rounded-lg mb-3 bg-gray-50">
            <input type="text" id="newProjArea" placeholder="Location" class="w-full p-3 border rounded-lg mb-6 bg-gray-50">
            <div class="flex justify-end gap-3"><button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button id="createProjBtn" class="px-6 py-2 bg-slate-900 text-white rounded-lg">Create</button></div>
        </div>
    </div>
    
    <div id="newTaskModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Assign Site Task</h2>
            <input type="text" id="newTaskTitle" placeholder="Title" class="w-full p-3 border rounded-lg mb-3">
            <textarea id="newTaskDesc" placeholder="Instructions" class="w-full p-3 border rounded-lg mb-6 h-24"></textarea>
            <div class="flex justify-end gap-3"><button onclick="document.getElementById('newTaskModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button id="saveTaskBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Assign</button></div>
        </div>
    </div>

    <div id="taskApproveModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50"><h2 class="text-xl font-bold text-slate-800" id="taskModalHeader">Review Task</h2><button onclick="document.getElementById('taskApproveModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button></div>
            <div class="p-6 overflow-y-auto flex-1"><h3 id="approveTaskTitle" class="text-2xl font-bold text-slate-800 mb-2"></h3><p class="text-lg mb-4">Cost: <span id="approveTaskCost" class="font-bold text-green-600 text-2xl"></span></p><div id="approveTaskPhotos" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
            <div class="p-6 border-t bg-gray-50 flex justify-end"><button id="confirmApproveTaskBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700">APPROVE & PAY</button></div>
        </div>
    </div>

    <div id="sellModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-8 rounded-2xl w-full max-w-4xl my-10 shadow-2xl relative">
            <button onclick="closeSellModal()" class="absolute top-6 right-6 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="border-b pb-4 mb-6"><h2 class="text-3xl font-bold text-slate-800 luxury-font">Sales Agreement</h2><p class="text-amber-600 font-bold mt-1">Block: <span id="sellBlockName"></span></p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1">Customer Details</h3>
                    <div id="newCusIdDisplay" class="hidden bg-blue-50 text-blue-700 p-2 rounded text-sm font-bold border border-blue-200 text-center">New Customer ID will be generated</div>
                    <input type="text" id="cusName" placeholder="Full Name" class="w-full p-3 border rounded-lg bg-gray-50">
                    <textarea id="cusAddress" placeholder="Address" class="w-full p-3 border rounded-lg h-20 bg-gray-50"></textarea>
                    <div class="flex gap-3"><input type="text" id="cusNIC" placeholder="NIC (Required for ID)" class="w-full p-3 border rounded-lg bg-gray-50"><input type="text" id="cusPhone" placeholder="Phone" class="w-full p-3 border rounded-lg bg-gray-50"></div>
                </div>
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1">Payment Plan</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-gray-500">PRICE</label><input type="number" id="finalPrice" class="w-full p-3 border rounded-lg font-bold text-slate-800 text-lg" oninput="calculateEP()"></div>
                        <div><label class="text-[10px] font-bold text-gray-500">ADVANCE</label><input type="number" id="advancePay" class="w-full p-3 border rounded-lg font-bold text-green-700 text-lg" oninput="calculateEP()"></div>
                    </div>
                    <select id="payPlanType" class="w-full p-3 border rounded-lg bg-slate-800 text-white font-bold" onchange="toggleEPFields()"><option value="Cash">Cash Sale</option><option value="EP">Easy Payment</option></select>
                    <div id="epFields" class="hidden bg-blue-50/50 p-4 rounded-xl border border-blue-100 space-y-3">
                        <div class="flex gap-3"><div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">RATE %</label><input type="number" id="epRate" value="15" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div><div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">MONTHS</label><input type="number" id="epMonths" value="60" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div><div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">CYCLE</label><input type="number" id="epCycle" value="30" class="w-full p-2 border rounded text-center font-bold text-blue-600"></div></div>
                        <div class="flex justify-between items-center pt-2 border-t border-blue-200"><span class="text-sm font-bold text-blue-900">Monthly:</span><span id="epMonthlyInst" class="text-xl font-bold text-blue-700">0.00</span></div><div class="hidden"><span id="epTotalPayable"></span></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4 pt-6 border-t">
                <button onclick="processSale(true)" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-lg shadow-lg hover:bg-slate-800 flex items-center gap-2"><i class="fas fa-file-pdf"></i> Save & Download Receipt</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl relative">
            <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="flex justify-between items-start mb-4 border-b pb-4">
                <div><h2 class="text-2xl font-bold text-slate-800">Payment Record</h2><p id="payBlockInfo" class="text-amber-600 font-bold text-sm"></p></div>
                <div class="flex flex-col items-end gap-1"><button id="editPlanBtn" class="text-xs text-blue-600 underline font-bold" onclick="toggleEditPlan()">Edit Interest/Plan</button><button id="resellBtn" class="hidden text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200" onclick="processResell()">CANCEL & RESELL</button></div>
            </div>
            
            <div id="epCycleSection" class="hidden mb-6">
                <div class="flex justify-between items-end mb-1">
                    <span id="cycleStatusLabel" class="text-[10px] font-bold uppercase tracking-wider text-blue-600">Cycle Progress</span>
                    <span id="cycleDaysLeft" class="text-[10px] font-bold text-gray-500"></span>
                </div>
                <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden relative">
                    <div id="cycleProgressBar" class="h-full progress-bar-fill bg-blue-500" style="width: 0%"></div>
                </div>
                <div class="flex gap-2 mt-2">
                     <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase block">Current Rate</span><span id="dispRate" class="text-xs font-bold text-blue-700"></span></div>
                     <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase block">Plan Period</span><span id="dispMonths" class="text-xs font-bold text-blue-700"></span></div>
                </div>
                <div class="mt-3 bg-indigo-50 p-2 rounded-lg border border-indigo-100 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-indigo-400 uppercase">This Month Payable</p>
                        <p class="text-xs text-indigo-500" id="epNextDueDetail">...</p>
                    </div>
                    <p class="text-xl font-bold text-indigo-700" id="epNextDueAmt">Rs. 0.00</p>
                </div>
            </div>

            <div id="cusDetailsSection" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4 text-sm">
                <h4 class="font-bold text-gray-400 text-xs uppercase mb-2">Customer Details</h4>
                <div class="grid grid-cols-2 gap-2">
                    <p><i class="fas fa-id-badge mr-2 text-amber-500"></i> <span id="viewCusId" class="font-bold text-slate-800"></span></p>
                    <p><i class="fas fa-id-card mr-2 text-gray-400"></i> <span id="viewCusNIC" class="font-medium"></span></p>
                    <p><i class="fas fa-phone mr-2 text-gray-400"></i> <span id="viewCusPhone" class="font-medium"></span></p>
                    <p class="col-span-2"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> <span id="viewCusAddr" class="font-medium text-gray-600"></span></p>
                </div>
            </div>
            <div id="editPlanSection" class="hidden bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4">
                <h4 class="text-xs font-bold text-yellow-700 uppercase mb-2">Adjust Plan</h4>
                <div class="flex gap-2 mb-2"><input type="number" id="editNewRate" placeholder="Rate %" class="p-2 border rounded w-1/3 text-sm"><input type="number" id="editNewMonths" placeholder="Months" class="p-2 border rounded w-1/3 text-sm"><button id="savePlanChangesBtn" class="bg-yellow-600 text-white px-3 rounded text-sm font-bold w-1/3 hover:bg-yellow-700">Update</button></div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-3 bg-slate-100 rounded-lg"><p class="text-[10px] uppercase font-bold text-gray-500">Payable</p><p id="pmTotal" class="font-bold text-slate-800 text-lg">0.00</p></div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-100"><p class="text-[10px] uppercase font-bold text-green-600">Paid</p><p id="pmPaid" class="font-bold text-green-700 text-lg">0.00</p></div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Balance</p><p id="pmBalance" class="font-bold text-red-700 text-lg">0.00</p></div>
            </div>
            <div id="addPaymentSection" class="bg-slate-50 p-4 rounded-xl mb-6 border border-gray-200"><div class="flex gap-3 mb-2"><input type="date" id="newPayDate" class="w-1/3 p-2 border rounded text-sm"><input type="number" id="newPayAmount" placeholder="Amount" class="w-1/3 p-2 border rounded text-sm font-bold text-slate-800"><button id="submitPayBtn" class="w-1/3 bg-green-600 text-white rounded font-bold text-sm shadow hover:bg-green-700">ADD PAYMENT</button></div></div>
            <div id="paymentCompleteMsg" class="hidden bg-green-100 text-green-800 p-4 rounded-xl text-center font-bold mb-6 border border-green-200"><i class="fas fa-check-circle mr-2"></i> FULLY PAID & CLOSED</div>
            <h3 class="font-bold text-xs text-gray-400 uppercase mb-2">History</h3>
            <div class="overflow-y-auto max-h-40 border rounded-lg"><table class="w-full text-xs text-left"><tbody id="paymentHistoryList" class="divide-y"></tbody></table></div>
        </div>
    </div>
    
    <div id="expenseModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
            <h2 class="text-lg font-bold mb-4 text-red-600">Add Expense</h2>
            <input type="text" id="expDesc" placeholder="Description" class="w-full p-2 border rounded mb-2">
            <input type="number" id="expAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4 font-bold">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('expenseModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button id="saveExpenseBtn" class="px-4 py-2 bg-red-600 text-white rounded font-bold">Save</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, collectionGroup, addDoc, deleteDoc, onSnapshot, query, where, orderBy, doc, updateDoc, arrayUnion, getDoc, getDocs, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlhMTQ-_sorFg_0ULpjf9kvjuIAWQkDVY",
            authDomain: "land-4d291.firebaseapp.com",
            projectId: "land-4d291",
            storageBucket: "land-4d291.firebasestorage.app",
            messagingSenderId: "1002505362762",
            appId: "1:1002505362762:web:f30e7ba82d8a344670f5b3",
            measurementId: "G-2EEQPP29VR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- AUTH & SETTINGS ---
        window.attemptLogin = async () => {
            const pwd = document.getElementById('loginPass').value;
            const settingsRef = doc(db, "settings", "config");
            const snap = await getDoc(settingsRef);
            let correct = "Sandeep@1116"; 
            if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword;

            if(pwd === correct) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initApp();
            } else { alert("Incorrect Password"); }
        };

        window.updatePassword = async () => {
            const newP = document.getElementById('newAdminPass').value;
            if(!newP || newP.length < 4) return alert("Password too short");
            await setDoc(doc(db, "settings", "config"), { adminPassword: newP }, { merge: true });
            alert("Password Updated"); document.getElementById('newAdminPass').value = "";
        };

        // --- UI NAVIGATION & SEARCH ---
        window.closeImgModal = () => document.getElementById('imgModal').classList.add('hidden');
        window.closeSellModal = () => document.getElementById('sellModal').classList.add('hidden');
        window.openExpenseModal = () => document.getElementById('expenseModal').classList.remove('hidden');
        window.toggleNotifPanel = () => document.getElementById('notifPanel').classList.toggle('hidden');
        
        window.nav = (page) => {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-amber-600/20','text-amber-500'); b.classList.add('text-gray-400'); });
            const btn = document.getElementById(`nav-${page}`);
            if(btn) { btn.classList.add('bg-amber-600/20','text-amber-500'); btn.classList.remove('text-gray-400'); }
            if(page==='readings') loadMeterReadings();
            if(page==='reports') { document.getElementById('txDate').valueAsDate = new Date(); document.getElementById('bsDate').valueAsDate = new Date(); }
        };

        window.subTab = (tab) => {
            document.querySelectorAll('.sub-tab').forEach(t => { t.classList.remove('text-slate-800', 'border-slate-800'); t.classList.add('text-gray-400'); });
            document.getElementById(`st-${tab}`).classList.add('text-slate-800', 'border-slate-800');
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        };

        window.switchFinTab = (tab) => {
            document.getElementById('fin-view-entry').classList.toggle('hidden', tab !== 'entry');
            document.getElementById('fin-view-reports').classList.toggle('hidden', tab !== 'reports');
            document.getElementById('ft-entry').className = tab === 'entry' ? "px-6 py-3 font-bold text-slate-800 border-b-2 border-slate-800 transition" : "px-6 py-3 font-bold text-gray-400 hover:text-slate-600 transition";
            document.getElementById('ft-reports').className = tab === 'reports' ? "px-6 py-3 font-bold text-slate-800 border-b-2 border-slate-800 transition" : "px-6 py-3 font-bold text-gray-400 hover:text-slate-600 transition";
        };

        // --- DEEP SEARCH (Now supports Customer ID) ---
        document.getElementById('projSearch').addEventListener('input', async (e) => {
            const term = e.target.value.toLowerCase();
            const resDiv = document.getElementById('searchResults');
            resDiv.innerHTML = "";
            if(term.length < 2) { resDiv.classList.add('hidden'); return; }

            // 1. Search Projects
            const projQ = query(collection(db, "projects"));
            const projSnap = await getDocs(projQ);
            let results = [];
            projSnap.forEach(d => { if(d.data().name.toLowerCase().includes(term)) results.push({type:'Project', name:d.data().name, id:d.id, data: d.data()}); });

            // 2. Search Customers
            const cusQ = query(collection(db, "customers")); 
            const cusSnap = await getDocs(cusQ);
            cusSnap.forEach(d => {
                const c = d.data();
                const cid = (c.customerId || "").toLowerCase();
                const cname = (c.name || "").toLowerCase();
                const cnic = (c.nic || "").toLowerCase();
                const cphone = (c.phone || "").toLowerCase();

                if(cid.includes(term) || cname.includes(term) || cnic.includes(term) || cphone.includes(term)) {
                    results.push({type:'Customer', name: c.name, detail: `ID: ${c.customerId || '-'} | Block: ${c.blockName} (${c.projectName})`, ref: d.ref, blockId: c.blockId, projId: c.projectId});
                }
            });

            if(results.length > 0) {
                resDiv.classList.remove('hidden');
                results.forEach(r => {
                    const div = document.createElement('div');
                    div.className = "p-2 hover:bg-gray-50 cursor-pointer border-b text-sm";
                    div.innerHTML = `<span class="font-bold text-slate-800">${r.name}</span> <span class="text-xs text-gray-500 uppercase ml-2 bg-gray-200 px-1 rounded">${r.type}</span><div class="text-xs text-gray-400">${r.detail || ''}</div>`;
                    
                    div.onclick = async () => {
                        resDiv.classList.add('hidden');
                        document.getElementById('projSearch').value = "";
                        
                        if(r.type === 'Project') { 
                            openProject(r.id, r.data); 
                        }
                        else { 
                            const projSnap = await getDoc(doc(db, "projects", r.projId));
                            if(projSnap.exists()) {
                                openProject(r.projId, projSnap.data()); 
                                const blockSnap = await getDoc(doc(db, `projects/${r.projId}/blocks/${r.blockId}`));
                                if(blockSnap.exists()) {
                                    setTimeout(() => {
                                        selectedBlockId = r.blockId; 
                                        openPaymentModal(blockSnap.data()); 
                                    }, 500);
                                }
                            }
                        }
                    };
                    resDiv.appendChild(div);
                });
            } else { resDiv.innerHTML = "<div class='p-2 text-sm text-gray-400'>No matches found.</div>"; resDiv.classList.remove('hidden'); }
        });


        // --- CORE DATA ---
        let currentProjId = null; let currentProjName = ""; let selectedBlockId = null; let selectedBlockData = null;
        let currentProjUnsub = null;

        function initApp() { loadProjects(); checkOverduePayments(); }

        async function recordDailyTransaction(desc, amt, type, projName) {
            const today = new Date().toLocaleDateString('en-CA'); 
            await addDoc(collection(db, "daily_transactions"), { date: today, description: desc, amount: amt, type: type, project: projName, timestamp: serverTimestamp() });
            const cat = type === 'income' ? 'Sales' : 'Admin Expense';
            await addDoc(collection(db, "transactions"), { date: today, description: desc, vNo: '', type: type, category: cat, amount: amt, isPetty: false, timestamp: serverTimestamp() });
        }

        window.saveTransaction = async () => {
            const date = document.getElementById('txDate').value; const vNo = document.getElementById('txVno').value;
            const desc = document.getElementById('txDesc').value; const type = document.getElementById('txType').value;
            const category = document.getElementById('txCategory').value; const amount = parseFloat(document.getElementById('txAmount').value);
            const isPetty = document.getElementById('txIsPetty').checked;
            if(!date || !desc || !amount) return alert("Please fill Date, Description and Amount");
            await addDoc(collection(db, "transactions"), { date, vNo, description: desc, type, category, amount, isPetty, timestamp: serverTimestamp() });
            document.getElementById('txDesc').value = ""; document.getElementById('txAmount').value = ""; document.getElementById('txVno').value = ""; alert("Transaction Saved Successfully!");
        };

        window.saveBSItem = async () => {
            const date = document.getElementById('bsDate').value; const name = document.getElementById('bsName').value;
            const type = document.getElementById('bsType').value; const amount = parseFloat(document.getElementById('bsAmount').value);
            if(!date || !name || !amount) return alert("Please fill all Balance Sheet fields");
            await addDoc(collection(db, "bs_items"), { date, name, type, amount, timestamp: serverTimestamp() });
            document.getElementById('bsName').value = ""; document.getElementById('bsAmount').value = ""; alert("Balance Sheet Item Saved!");
        };

        window.genReport = async (type) => {
            const from = document.getElementById('repFrom').value; const to = document.getElementById('repTo').value;
            if(!from || !to) return alert("Please select a Date Range first.");
            document.getElementById('overlayPrintTitle').innerText = type.toUpperCase() + " REPORT"; document.getElementById('overlayPrintDate').innerText = `${from} to ${to}`;
            let html = ""; let q = query(collection(db, "transactions"), where("date", ">=", from), where("date", "<=", to), orderBy("date"));
            const snap = await getDocs(q);

            if(type === 'daybook') {
                let bal = 0; let totInc = 0; let totExp = 0;
                html = `<table class="w-full border-collapse"><thead><tr class="bg-gray-200 border-b border-black"><th class="p-2 text-left">Date</th><th class="p-2 text-left">Desc</th><th class="p-2 text-left">V.No</th><th class="p-2 text-right">Income</th><th class="p-2 text-right">Expense</th><th class="p-2 text-right">Balance</th></tr></thead><tbody>`;
                snap.forEach(d => { const t = d.data(); let inc = t.type === 'Income' ? t.amount : 0; let exp = t.type === 'Expense' ? t.amount : 0; bal += (inc - exp); totInc += inc; totExp += exp; html += `<tr><td class="p-2 border-b text-xs">${t.date}</td><td class="p-2 border-b text-xs">${t.description}</td><td class="p-2 border-b text-xs">${t.vNo||'-'}</td><td class="p-2 border-b text-right text-xs text-green-600">${inc>0?inc.toLocaleString():'-'}</td><td class="p-2 border-b text-right text-xs text-red-600">${exp>0?exp.toLocaleString():'-'}</td><td class="p-2 border-b text-right text-xs font-bold">${bal.toLocaleString()}</td></tr>`; });
                html += `</tbody><tfoot><tr class="font-bold border-t-2 border-black"><td colspan="3" class="p-2 text-right">TOTALS:</td><td class="p-2 text-right">${totInc.toLocaleString()}</td><td class="p-2 text-right">${totExp.toLocaleString()}</td><td class="p-2 text-right">${bal.toLocaleString()}</td></tr></tfoot></table>`;
            } 
            else if (type === 'petty') {
                let tot = 0; html = `<table class="w-full border-collapse"><thead><tr class="bg-amber-100 border-b border-amber-600"><th class="p-2 text-left">Date</th><th class="p-2 text-left">Description</th><th class="p-2 text-left">V.No</th><th class="p-2 text-right">Amount</th></tr></thead><tbody>`;
                snap.forEach(d => { const t = d.data(); if(t.isPetty) { tot += t.amount; html += `<tr><td class="p-2 border-b text-xs">${t.date}</td><td class="p-2 border-b text-xs">${t.description}</td><td class="p-2 border-b text-xs">${t.vNo||'-'}</td><td class="p-2 border-b text-right text-xs font-bold">${t.amount.toLocaleString()}</td></tr>`; } });
                html += `</tbody><tfoot><tr class="font-bold border-t border-amber-600"><td colspan="3" class="p-2 text-right">TOTAL PETTY CASH:</td><td class="p-2 text-right">${tot.toLocaleString()}</td></tr></tfoot></table>`;
            }
            else if (type === 'pnl') {
                let cats = {}; snap.forEach(d => { const t = d.data(); if(!cats[t.category]) cats[t.category] = 0; cats[t.category] += t.amount; });
                const rev = (cats['Sales']||0) + (cats['Other Income']||0); const cogs = cats['Cost of Sales']||0; const gp = rev - cogs;
                const admin = cats['Admin Expense']||0; const selling = cats['Selling Expense']||0; const fin = cats['Finance Cost']||0; const tax = cats['Tax']||0; const petty = cats['Petty Cash']||0;
                const totExp = admin + selling + fin + tax + petty; const np = gp - totExp;
                html = `<table class="w-full text-sm"><tr><td class="p-2 font-bold">Revenue</td><td class="p-2 text-right">${rev.toLocaleString()}</td></tr><tr><td class="p-2 text-red-600">Cost of Sales</td><td class="p-2 text-right text-red-600">(${cogs.toLocaleString()})</td></tr><tr class="border-t border-black bg-gray-100"><td class="p-2 font-bold">GROSS PROFIT</td><td class="p-2 text-right font-bold">${gp.toLocaleString()}</td></tr><tr><td class="p-2 pt-4 font-bold text-gray-500 uppercase">Expenses</td><td></td></tr><tr><td class="p-2 pl-6">Admin Expenses</td><td class="p-2 text-right">${admin.toLocaleString()}</td></tr><tr><td class="p-2 pl-6">Selling & Distribution</td><td class="p-2 text-right">${selling.toLocaleString()}</td></tr><tr><td class="p-2 pl-6">Finance Costs</td><td class="p-2 text-right">${fin.toLocaleString()}</td></tr><tr><td class="p-2 pl-6">Tax</td><td class="p-2 text-right">${tax.toLocaleString()}</td></tr>${petty>0 ? `<tr><td class="p-2 pl-6">Petty Cash Exp</td><td class="p-2 text-right">${petty.toLocaleString()}</td></tr>` : ''}<tr class="border-t border-black"><td class="p-2 font-bold">Total Expenses</td><td class="p-2 text-right">(${totExp.toLocaleString()})</td></tr><tr class="border-t-2 border-double border-black bg-gray-200"><td class="p-2 font-bold text-lg">NET PROFIT</td><td class="p-2 text-right font-bold text-lg">${np.toLocaleString()}</td></tr></table>`;
            }
            else if (type === 'bs') {
                const snap = await getDocs(query(collection(db, "bs_items")));
                let grp = { 'Non-Current Asset':0, 'Current Asset':0, 'Equity':0, 'Non-Current Liability':0, 'Current Liability':0 }; let items = [];
                snap.forEach(d => { const t = d.data(); if(t.date <= to) { grp[t.type] += t.amount; items.push(t); } });
                html = `<div class="grid grid-cols-2 gap-8"><div><h4 class="font-bold border-b mb-2">ASSETS</h4><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Non-Current Assets</p>${items.filter(i=>i.type==='Non-Current Asset').map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total</span><span>${grp['Non-Current Asset'].toLocaleString()}</span></div></div><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Current Assets</p>${items.filter(i=>i.type==='Current Asset').map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total</span><span>${grp['Current Asset'].toLocaleString()}</span></div></div><div class="flex justify-between font-bold text-lg border-t-2 border-black p-2"><span>TOTAL ASSETS</span><span>${(grp['Non-Current Asset']+grp['Current Asset']).toLocaleString()}</span></div></div><div><h4 class="font-bold border-b mb-2">EQUITY & LIABILITIES</h4><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Equity</p>${items.filter(i=>i.type==='Equity').map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total Equity</span><span>${grp['Equity'].toLocaleString()}</span></div></div><div class="mb-4"><p class="font-bold text-xs text-gray-500 uppercase">Liabilities</p>${items.filter(i=>i.type.includes('Liability')).map(i=>`<div class="flex justify-between text-xs p-1"><span>${i.name}</span><span>${i.amount.toLocaleString()}</span></div>`).join('')}<div class="flex justify-between font-bold border-t mt-1 p-1 bg-gray-50"><span>Total Liab.</span><span>${(grp['Non-Current Liability']+grp['Current Liability']).toLocaleString()}</span></div></div><div class="flex justify-between font-bold text-lg border-t-2 border-black p-2"><span>TOTAL EQ & LIAB</span><span>${(grp['Equity']+grp['Non-Current Liability']+grp['Current Liability']).toLocaleString()}</span></div></div></div>`;
            }

            document.getElementById('overlayPrintContent').innerHTML = html; document.getElementById('reportContent').innerHTML = html;
        };

        window.triggerPDFDownload = async () => {
            const content = document.getElementById('overlayPrintContent').innerHTML; if(!content) return alert("Generate Report first."); await downloadPDF();
        };
        window.downloadFinancialReport = async () => {
            const inc = document.getElementById('finIncome').innerText; const exp = document.getElementById('finExpense').innerText; const prof = document.getElementById('finProfit').innerText;
            document.getElementById('overlayPrintTitle').innerText = "Financial Report: " + currentProjName; document.getElementById('overlayPrintDate').innerText = new Date().toLocaleDateString();
            document.getElementById('overlayPrintContent').innerHTML = `<h2>Project Summary</h2><table style="width:100%; margin-top:20px; font-size:18px;"><tr><td style="padding:10px;">Total Revenue</td><td style="text-align:right;">${inc}</td></tr><tr><td style="padding:10px;">Total Costs</td><td style="text-align:right; color:red;">${exp}</td></tr><tr style="font-weight:bold; border-top:2px solid black;"><td style="padding:10px;">NET PROFIT</td><td style="text-align:right;">${prof}</td></tr></table>`;
            await downloadPDF();
        };

        function loadProjects() {
            onSnapshot(query(collection(db, "projects"), orderBy("createdAt", "desc")), (snap) => {
                const grid = document.getElementById('projectGrid'); grid.innerHTML = "";
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-6 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer border border-gray-100 transition relative overflow-hidden group";
                    el.onclick = () => openProject(docSnap.id, d);
                    el.innerHTML = `<div class="absolute top-0 left-0 w-2 h-full bg-slate-900 group-hover:bg-amber-500 transition"></div><h3 class="font-bold text-lg text-slate-900 pl-2">${d.name}</h3><p class="text-sm text-gray-500 pl-2"><i class="fas fa-map-marker-alt mr-1"></i> ${d.area}</p><span class="text-[10px] uppercase font-bold bg-gray-100 px-2 py-1 rounded absolute top-4 right-4 text-gray-500 tracking-wider">${d.status}</span>`;
                    grid.appendChild(el);
                });
            });
        }

        document.getElementById('createProjBtn').addEventListener('click', async () => {
            const name = document.getElementById('newProjName').value; const area = document.getElementById('newProjArea').value; if(!name) return;
            await addDoc(collection(db, "projects"), { name, area, status: 'development', createdAt: new Date() });
            document.getElementById('newProjectModal').classList.add('hidden');
        });

        function openProject(id, data) {
            currentProjId = id; currentProjName = data.name;
            nav('detail');
            
            if(currentProjUnsub) currentProjUnsub(); 
            currentProjUnsub = onSnapshot(doc(db, "projects", id), (docSnap) => {
                if (docSnap.exists()) {
                    const pData = docSnap.data();
                    document.getElementById('detailName').innerText = pData.name; 
                    document.getElementById('detailArea').innerText = pData.area || 'Unknown';
                    document.getElementById('detailStatus').innerText = pData.status || 'Active';
                    
                    const isDev = pData.status === 'development';
                    document.getElementById('devPhaseUI').style.display = isDev ? 'grid' : 'none';
                    document.getElementById('endDevBtn').style.display = isDev ? 'block' : 'none';

                    const vList = document.getElementById('vehicleList'); 
                    vList.innerHTML = "";
                    (pData.assignedVehicles || []).forEach(v => vList.innerHTML += `<span class="bg-gray-200 px-2 py-1 rounded text-xs font-bold mr-1">${v}</span>`);
                }
            });

            window.endDevelopmentPhase = async () => {
                if(!confirm("Are you sure you want to end Development Phase?\nThis will hide development tools and mark project as Active.")) return;
                await updateDoc(doc(db, "projects", currentProjId), { status: 'active' });
                alert("Development Phase Ended. Project is now Active.");
            };
            
            window.assignVehicle = async () => {
                const vNo = document.getElementById('regVehicleNo').value;
                if(!vNo) return;
                await updateDoc(doc(db, "projects", currentProjId), { assignedVehicles: arrayUnion(vNo) });
                document.getElementById('regVehicleNo').value = "";
            };

            loadBlocks(id, data.status === 'development'); loadExpensesAndProfit(id); loadProjectTasks(id);
        }

        document.getElementById('addBlockBtn').addEventListener('click', async () => {
            const name = document.getElementById('blockName').value; const size = document.getElementById('blockSize').value;
            const price = document.getElementById('blockPrice').value; const pPrice = document.getElementById('blockPerchPrice').value; if(!name) return;
            await addDoc(collection(db, `projects/${currentProjId}/blocks`), { name, size, price: parseFloat(price), perchPrice: parseFloat(pPrice), status: "available" });
            document.getElementById('blockName').value = ""; document.getElementById('blockPrice').value = "";
        });

        let projectTasksData = {}; 
        function loadProjectTasks(pid) {
            onSnapshot(query(collection(db, `projects/${pid}/tasks`), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('adminTaskList'); list.innerHTML = ""; projectTasksData = {}; 
                snap.forEach(d => {
                    const t = d.data(); projectTasksData[d.id] = t; 
                    let statusBadge = ""; let actionBtn = "";
                    if (t.status === 'completed') { statusBadge = '<span class="text-green-600 font-bold text-xs bg-green-100 px-2 rounded">Paid</span>'; actionBtn = `<button onclick="openApproveModal('${d.id}', true)" class="bg-slate-200 text-slate-800 px-4 py-2 rounded text-xs font-bold hover:bg-slate-300">View</button>`; } 
                    else if (t.status === 'pending_approval') { statusBadge = '<span class="text-yellow-600 font-bold text-xs bg-yellow-100 px-2 rounded animate-pulse">Needs Review</span>'; actionBtn = `<button onclick="openApproveModal('${d.id}', false)" class="bg-slate-900 text-white px-4 py-2 rounded text-xs font-bold">Review</button>`; } 
                    else { statusBadge = '<span class="text-gray-400 text-xs bg-gray-100 px-2 rounded">Pending</span>'; }
                    const el = document.createElement('div'); el.className = "bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center";
                    el.innerHTML = `<div><h4 class="font-bold text-slate-800">${t.title}</h4><p class="text-xs text-gray-500">${t.description||'-'}</p><div class="mt-1">${statusBadge} ${t.submittedCost ? `<span class="ml-2 font-bold">Rs. ${t.submittedCost}</span>` : ''}</div></div>${actionBtn}`;
                    list.appendChild(el);
                });
            });
        }
        document.getElementById('saveTaskBtn').addEventListener('click', async () => {
            await addDoc(collection(db, `projects/${currentProjId}/tasks`), { title: document.getElementById('newTaskTitle').value, description: document.getElementById('newTaskDesc').value, status: 'new', createdAt: serverTimestamp() });
            document.getElementById('newTaskModal').classList.add('hidden');
        });
        
        let activeApproveId = null; let activeApproveCost = 0;
        window.openApproveModal = (id, readOnly) => {
            const task = projectTasksData[id]; if(!task) return alert("Error");
            activeApproveId = id; activeApproveCost = task.submittedCost;
            document.getElementById('approveTaskTitle').innerText = task.title; document.getElementById('approveTaskCost').innerText = "Rs. " + (task.submittedCost || 0).toLocaleString();
            document.getElementById('taskModalHeader').innerText = readOnly ? "Task Details" : "Review Task"; document.getElementById('confirmApproveTaskBtn').style.display = readOnly ? 'none' : 'block';
            const div = document.getElementById('approveTaskPhotos'); div.innerHTML = "";
            if(task.photos && task.photos.length > 0) { task.photos.forEach(src => div.innerHTML += `<img src="${src}" class="w-full h-32 object-cover rounded border cursor-pointer hover:opacity-90 transition" onclick="document.getElementById('imgModalSrc').src='${src}';document.getElementById('imgModal').classList.remove('hidden')">`); } 
            else { div.innerHTML = "<p class='text-xs text-gray-400'>No photos.</p>"; }
            document.getElementById('taskApproveModal').classList.remove('hidden');
        };
        document.getElementById('confirmApproveTaskBtn').addEventListener('click', async () => {
            const title = document.getElementById('approveTaskTitle').innerText;
            await updateDoc(doc(db, `projects/${currentProjId}/tasks/${activeApproveId}`), { status: 'completed' });
            await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `Task: ${title}`, amount: activeApproveCost, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() });
            await recordDailyTransaction(`Site Task: ${title}`, activeApproveCost, 'expense', currentProjName);
            document.getElementById('taskApproveModal').classList.add('hidden');
        });

        // --- SALES & PAYMENTS & CUSTOMER ID ---
        window.processSale = async (downloadPdf) => {
            const nic = document.getElementById('cusNIC').value;
            const name = document.getElementById('cusName').value;
            const phone = document.getElementById('cusPhone').value;
            const address = document.getElementById('cusAddress').value;

            if(!nic || !name) return alert("Customer Name and NIC are required!");

            let customerId = "";
            const q = query(collection(db, "customers"), where("nic", "==", nic));
            const snap = await getDocs(q);

            if(!snap.empty) {
                customerId = snap.docs[0].data().customerId;
                await updateDoc(snap.docs[0].ref, { name, phone, address });
            } else {
                customerId = "CUS-" + Math.floor(100000 + Math.random() * 900000);
                await addDoc(collection(db, "customers"), { customerId, name, nic, phone, address, joinedDate: new Date() });
            }

            const cus = { customerId, name, address, nic, phone };
            const advance = parseFloat(document.getElementById('advancePay').value);
            const price = parseFloat(document.getElementById('finalPrice').value);
            const plan = document.getElementById('payPlanType').value;
            
            let ep = {}; let nextD = null;
            let status = 'sold'; 

            if(plan === 'EP') {
                const cycle = parseInt(document.getElementById('epCycle').value);
                ep = { rate: document.getElementById('epRate').value, months: document.getElementById('epMonths').value, cycleDays: cycle, totalPayable: parseFloat(document.getElementById('epTotalPayable').innerText), paidAmount: advance };
                const d = new Date(); d.setDate(d.getDate() + cycle); nextD = d;
            } else {
                if(advance >= price - 10) status = 'sold_finished';
            }
            
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), {
                status: status, soldPrice: price, customer: cus, soldDate: new Date(),
                payment: { totalPrice: price, advancePaid: advance, planType: plan, epDetails: ep, nextPaymentDate: nextD, history: [{date: new Date(), amount: advance, type: 'Advance'}] }
            });

            await recordDailyTransaction(`Sale Advance: ${selectedBlockData.name} - ${cus.name}`, advance, 'income', currentProjName);
            
            if(downloadPdf) {
                document.getElementById('overlayPrintTitle').innerText = "OFFICIAL RECEIPT";
                document.getElementById('overlayPrintDate').innerText = new Date().toLocaleDateString();
                document.getElementById('overlayPrintContent').innerHTML = `<div style="margin-top:30px; line-height:1.8;"><p><strong>Customer ID:</strong> ${customerId}</p><p><strong>Received From:</strong> ${cus.name}</p><p><strong>Amount:</strong> Rs. ${advance.toLocaleString()}</p><hr class="my-6 border-gray-400"><p><strong>Project:</strong> ${currentProjName}</p><p><strong>Block:</strong> ${selectedBlockData.name}</p><p><strong>Payment Plan:</strong> ${plan === 'EP' ? 'Easy Payment (Installment)' : 'Cash / Outright'}</p></div>`;
                await downloadPDF();
            }
            closeSellModal();
        };

        // --- UPDATED PAYMENT MODAL LOGIC FOR EP BAR & PENALTY ---
        window.openPaymentModal = async (data) => {
            selectedBlockData = data; 
            document.getElementById('paymentModal').classList.remove('hidden');
            const isFin = data.status === 'sold_finished';
            const isEP = data.payment.planType === 'EP';
            
            document.getElementById('addPaymentSection').style.display = isFin ? 'none' : 'block';
            document.getElementById('editPlanBtn').style.display = (isFin || !isEP) ? 'none' : 'block';
            document.getElementById('resellBtn').classList.toggle('hidden', isFin); 
            document.getElementById('paymentCompleteMsg').classList.toggle('hidden', !isFin);
            document.getElementById('payBlockInfo').innerText = `${data.name} - ${data.customer.name}`;
            
            document.getElementById('viewCusId').innerText = data.customer.customerId || "N/A";
            document.getElementById('viewCusNIC').innerText = data.customer.nic || "N/A";
            document.getElementById('viewCusPhone').innerText = data.customer.phone || "N/A";
            document.getElementById('viewCusAddr').innerText = data.customer.address || "N/A";

            let total = 0; let paid = 0;
            if(isEP) { total = data.payment.epDetails.totalPayable; paid = data.payment.epDetails.paidAmount || 0; } 
            else { total = data.soldPrice; paid = (data.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0); }
            
            document.getElementById('pmTotal').innerText = total.toLocaleString(); 
            document.getElementById('pmPaid').innerText = paid.toLocaleString(); 
            document.getElementById('pmBalance').innerText = (total-paid).toLocaleString();
            
            const tbody = document.getElementById('paymentHistoryList'); tbody.innerHTML = "";
            (data.payment.history||[]).forEach(h => {
                const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date);
                tbody.innerHTML += `<tr><td class="py-2">${d.toLocaleDateString()}</td><td class="font-bold">Rs.${(h.amount||0).toLocaleString()}</td><td class="text-gray-500">${h.type} ${h.note?`(${h.note})`:''}</td></tr>`;
            });
            document.getElementById('newPayDate').valueAsDate = new Date();

            // CALL NEW UI UPDATE FUNCTION
            updateCycleUI(data);
        };

        // --- NEW FUNCTION: UPDATE CYCLE UI ---
        function updateCycleUI(data) {
            const container = document.getElementById('epCycleSection');
            if (data.payment.planType !== 'EP') { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            
            const fill = document.getElementById('cycleProgressBar');
            const label = document.getElementById('cycleStatusLabel');
            const daysLabel = document.getElementById('cycleDaysLeft');
            
            // Show Plan Info
            document.getElementById('dispRate').innerText = (data.payment.epDetails.rate || 0) + "%";
            document.getElementById('dispMonths').innerText = (data.payment.epDetails.months || 0) + " M";

            const nextD = data.payment.nextPaymentDate.seconds ? new Date(data.payment.nextPaymentDate.seconds*1000) : new Date(data.payment.nextPaymentDate);
            const cycleDays = parseInt(data.payment.epDetails.cycleDays || 30);
            const today = new Date();
            
            // Logic: Start date is (NextDate - CycleDays)
            const startD = new Date(nextD); startD.setDate(startD.getDate() - cycleDays);

            if (today <= nextD) {
                // NORMAL CYCLE (BLUE)
                const totalTime = nextD - startD; const elapsed = today - startD;
                const percent = Math.min(100, Math.max(0, (elapsed / totalTime) * 100));
                fill.style.width = percent + "%"; fill.className = "h-full progress-bar-fill bg-blue-500";
                label.innerText = "Cycle Progress"; label.className = "text-[10px] font-bold uppercase text-blue-600";
                daysLabel.innerText = Math.ceil((nextD - today)/(1000*60*60*24)) + " days left";
            } else {
                // GRACE PERIOD (RED)
                const diffTime = today - nextD;
                const diffDays = diffTime / (1000*60*60*24);
                const gracePercent = Math.min(100, (diffDays / 5) * 100);
                
                fill.style.width = gracePercent + "%"; fill.className = "h-full progress-bar-fill bg-red-600";
                label.innerText = "OVERDUE (Grace Period)"; label.className = "text-[10px] font-bold uppercase text-red-600 animate-pulse";
                daysLabel.innerText = "Penalty in " + Math.max(0, Math.ceil(5 - diffDays)) + " days";
                
                if (diffDays >= 5) applyLatePenalty(data);
            }

            // --- CALCULATE DYNAMIC MONTHLY INSTALLMENT (REDUCING BALANCE LOGIC) ---
            // Formula: (Current Balance / Remaining Months) + (Current Balance * AnnualRate/12/100)
            
            const rate = parseFloat(data.payment.epDetails.rate) || 15;
            const totalMonths = parseFloat(data.payment.epDetails.months) || 60;
            const currentBal = data.payment.epDetails.totalPayable - (data.payment.epDetails.paidAmount || 0);

            // Estimate Remaining Months: Total - (Elapsed Time / 30 days)
            // Or better: Use Sold Date vs Now
            const soldDate = data.soldDate.seconds ? new Date(data.soldDate.seconds*1000) : new Date(data.soldDate);
            let monthsPassed = (today.getFullYear() - soldDate.getFullYear()) * 12;
            monthsPassed -= soldDate.getMonth();
            monthsPassed += today.getMonth();
            if(monthsPassed < 0) monthsPassed = 0;
            
            let remMonths = totalMonths - monthsPassed;
            if(remMonths < 1) remMonths = 1; // Minimum 1 to avoid division by zero

            // Interest for this month
            const monthlyInt = currentBal * (rate / 100 / 12);
            // Principal for this month
            const monthlyPrin = currentBal / remMonths;
            
            const totalDueNow = monthlyInt + monthlyPrin;

            document.getElementById('epNextDueAmt').innerText = "Rs. " + totalDueNow.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('epNextDueDetail').innerText = `(Prin: ${monthlyPrin.toFixed(0)} + Int: ${monthlyInt.toFixed(0)})`;
        }

        // --- NEW FUNCTION: APPLY PENALTY ---
        async function applyLatePenalty(data) {
            const lastHist = data.payment.history[data.payment.history.length-1];
            if (lastHist && lastHist.type.includes('Penalty') && new Date(lastHist.date.seconds*1000).toDateString() === new Date().toDateString()) return;

            const bal = data.payment.epDetails.totalPayable - data.payment.epDetails.paidAmount;
            const penalty = bal * 0.04;
            const newTotal = data.payment.epDetails.totalPayable + penalty;
            
            // Reset next date to allow new cycle
            const newNext = new Date(); newNext.setDate(newNext.getDate() + parseInt(data.payment.epDetails.cycleDays || 30));

            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), {
                "payment.epDetails.totalPayable": newTotal, 
                "payment.nextPaymentDate": newNext,
                "payment.history": arrayUnion({date: new Date(), amount: 0, type: 'Late Penalty (4%)', note: 'Added automatically'})
            });

            // Send Notification
            await addDoc(collection(db, "notifications"), { title: "Penalty Applied", message: `4% added to ${data.customer.name} (Block ${data.name})`, timestamp: serverTimestamp() });
            
            alert(`Penalty Applied! 4% added to ${data.customer.name}.`);
        }

        window.toggleEditPlan = () => document.getElementById('editPlanSection').classList.toggle('hidden');
        
        document.getElementById('savePlanChangesBtn').addEventListener('click', async () => {
            const rate = parseFloat(document.getElementById('editNewRate').value);
            const months = parseFloat(document.getElementById('editNewMonths').value);
            if(!rate || !months) return alert("Please enter valid Rate and Months");
            const b = selectedBlockData; if(!b || !b.payment || b.payment.planType !== 'EP') return alert("Invalid");
            const bal = b.soldPrice - b.payment.advancePaid; const newInt = bal * (rate/100) * (months/12); const newTot = bal + newInt + b.payment.advancePaid;
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { "payment.epDetails.rate": rate, "payment.epDetails.months": months, "payment.epDetails.totalPayable": newTot });
            alert("Updated!"); document.getElementById('paymentModal').classList.add('hidden'); openProject(currentProjId, {name: currentProjName, area: '...'});
        });

        // --- UPDATED PAYMENT SUBMIT (RESET LOGIC) ---
        document.getElementById('submitPayBtn').addEventListener('click', async () => {
            const amt = parseFloat(document.getElementById('newPayAmount').value); 
            if(!amt) return;
            const b = selectedBlockData;
            
            let updateData = { "payment.history": arrayUnion({date: new Date(), amount: amt, type: 'Payment'}) };
            let totalDue = 0; let currentPaid = 0;

            if (b.payment.planType === 'EP') {
                const newPaid = (b.payment.epDetails.paidAmount||0) + amt;
                
                // RESET LOGIC: Set next payment date to Today + CycleDays
                const nextD = new Date(); nextD.setDate(nextD.getDate() + (b.payment.epDetails.cycleDays || 30));
                
                updateData["payment.epDetails.paidAmount"] = newPaid;
                updateData["payment.nextPaymentDate"] = nextD;
                
                totalDue = b.payment.epDetails.totalPayable; currentPaid = newPaid;
            } else {
                totalDue = b.soldPrice;
                const prevPaid = (b.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0);
                currentPaid = prevPaid + amt;
            }

            if (currentPaid >= totalDue - 10) updateData["status"] = "sold_finished";

            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), updateData);
            await recordDailyTransaction(`Payment: ${b.name} (${b.customer.name})`, amt, 'income', currentProjName);
            document.getElementById('paymentModal').classList.add('hidden');
            alert("Payment Added & Cycle Reset!");
        });

        window.processResell = async () => {
            if(!confirm("Cancel sale?")) return; const b = selectedBlockData; const paid = b.payment.epDetails ? b.payment.epDetails.paidAmount : b.soldPrice;
            await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `REFUND: Cancelled Sale ${b.name} (${b.customer.name})`, amount: paid, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() });
            await recordDailyTransaction(`REFUND: ${b.name}`, paid, 'expense', currentProjName);
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { status: 'available', customer: null, payment: null, soldPrice: null, soldDate: null });
            alert("Cancelled!"); document.getElementById('paymentModal').classList.add('hidden');
        };
        document.getElementById('saveExpenseBtn').addEventListener('click', async () => {
            const amt = parseFloat(document.getElementById('expAmount').value); const desc = document.getElementById('expDesc').value;
            await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: desc, amount: amt, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() });
            await recordDailyTransaction(`Expense: ${desc}`, amt, 'expense', currentProjName); document.getElementById('expenseModal').classList.add('hidden');
        });
        
        async function checkOverduePayments() {
            // Updated to fetch from new Notification collection if preferred, or keep logic
            const blocksQ = query(collectionGroup(db, 'blocks'), where('status', '==', 'sold')); const snap = await getDocs(blocksQ);
            const list = document.getElementById('notifList'); list.innerHTML = ""; let count = 0;
            
            // 1. Check Blocks
            snap.forEach(d => { const b = d.data(); if(b.payment && b.payment.planType === 'EP' && b.payment.nextPaymentDate) {
                    const nextD = b.payment.nextPaymentDate.seconds ? new Date(b.payment.nextPaymentDate.seconds*1000) : new Date(b.payment.nextPaymentDate);
                    if(nextD < new Date()) { count++; const div = document.createElement('div'); div.className = "p-3 border-b hover:bg-red-50 cursor-pointer"; div.innerHTML = `<p class="font-bold text-slate-800 text-xs">${b.name} - ${b.customer.name}</p><p class="text-[10px] text-red-500 font-bold">Due: ${nextD.toLocaleDateString()}</p>`;
                        div.onclick = async () => { const pid = d.ref.parent.parent.id; const pSnap = await getDoc(doc(db, "projects", pid)); openProject(pid, pSnap.data()); setTimeout(()=> { selectedBlockId=d.id; openPaymentModal(b); }, 1000); };
                        list.appendChild(div); } } });
            
            // 2. Check Notification Collection (For Penalties)
            const notifQ = query(collection(db, "notifications"), orderBy("timestamp", "desc"));
            const notifSnap = await getDocs(notifQ);
            notifSnap.forEach(d => {
                 count++;
                 list.innerHTML += `<div class="p-3 border-b bg-yellow-50"><p class="font-bold text-xs">${d.data().title}</p><p class="text-[10px]">${d.data().message}</p></div>`;
            });

            if(count > 0) { document.getElementById('notifBadge').innerText = count; document.getElementById('notifBadge').classList.remove('hidden'); document.getElementById('bellIcon').classList.add('text-red-500', 'animate-pulse'); }
        }
        
        window.calcBlockPrice = () => { document.getElementById('blockPrice').value = (parseFloat(document.getElementById('blockSize').value)||0) * (parseFloat(document.getElementById('blockPerchPrice').value)||0); };
        window.toggleEPFields = () => { const isEP = document.getElementById('payPlanType').value === 'EP'; document.getElementById('epFields').classList.toggle('hidden', !isEP); if(isEP) window.calculateEP(); };
        
        // --- UPDATED CALCULATE EP (NEW SALE) ---
        window.calculateEP = () => { 
            const price = parseFloat(document.getElementById('finalPrice').value)||0; 
            const advance = parseFloat(document.getElementById('advancePay').value)||0; 
            const rate = parseFloat(document.getElementById('epRate').value)||15; 
            const months = parseFloat(document.getElementById('epMonths').value)||60; 
            
            const balance = price - advance; 
            if(balance < 0) return; 

            // Logic: Balance + Total Interest (Simple Approx for Total Payable record)
            // But monthly installment shows FIRST MONTH Max Payment (Prin + Int)
            const monthlyRate = rate / 100 / 12;
            const monthlyPrin = balance / months;
            const firstMonthInt = balance * monthlyRate;
            const firstMonthTotal = monthlyPrin + firstMonthInt;

            // Total Payable for record (Standard Flat or Approx Reducing)
            // Let's use Simple Interest Total for the record to be safe, actual math happens monthly
            const totalInterestSimple = balance * (rate/100) * (months/12);
            const totalPayable = balance + totalInterestSimple;

            document.getElementById('epTotalPayable').innerText = totalPayable.toFixed(2); 
            document.getElementById('epMonthlyInst').innerText = firstMonthTotal.toFixed(2) + " (1st Mo)"; 
        };
        
        window.downloadPDF = async () => { const overlay = document.getElementById('pdfPreviewOverlay'); overlay.style.display = 'block'; await new Promise(r => setTimeout(r, 500)); try { await html2pdf().set({ margin: 10, filename: 'Report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(overlay.querySelector('.print-container')).save(); } catch (err) { console.error(err); alert("Error"); } finally { setTimeout(() => { overlay.style.display = 'none'; }, 1000); } };
        function loadExpensesAndProfit(pid) { let inc = 0; onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { inc = 0; snap.forEach(d => { const b = d.data(); if(b.status.includes('sold')) inc += b.soldPrice; }); document.getElementById('finIncome').innerText = "Rs. " + inc.toLocaleString(); updateNet(inc, null); }); onSnapshot(query(collection(db, `projects/${pid}/expenses`), orderBy("date","desc")), (snap) => { let exp = 0; const list = document.getElementById('expenseList'); list.innerHTML = ""; snap.forEach(d => { const e = d.data(); exp += e.amount; list.innerHTML += `<tr class="border-b"><td class="p-3 text-gray-500">${e.date}</td><td class="p-3 font-bold">${e.description}</td><td class="p-3 text-right text-red-600">-${e.amount.toLocaleString()}</td></tr>`; }); document.getElementById('finExpense').innerText = "Rs. " + exp.toLocaleString(); updateNet(null, exp); }); }
        let cInc=0, cExp=0; function updateNet(i,e) { if(i!==null) cInc=i; if(e!==null) cExp=e; const net = cInc-cExp; document.getElementById('finProfit').innerText = "Rs. " + net.toLocaleString(); document.getElementById('finProfit').className = `text-3xl font-bold relative z-10 ${net>=0?'text-slate-800':'text-red-600'}`; }
        function loadMeterReadings() { onSnapshot(query(collection(db, "meter_readings"), orderBy("timestamp", "desc")), (snap) => { const list = document.getElementById('readingsList'); list.innerHTML = ""; snap.forEach(d => { const r = d.data(); const el = document.createElement('div'); el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4"; el.innerHTML = `<img src="${r.imageBase64}" onclick="document.getElementById('imgModalSrc').src='${r.imageBase64}';document.getElementById('imgModal').classList.remove('hidden')" class="w-24 h-24 object-cover rounded-lg cursor-pointer"><div class="flex-1"><h4 class="font-bold text-lg text-slate-800">${r.vehicleNo} <span class="text-sm text-gray-500 font-normal">(${r.projectName})</span></h4><p class="text-sm text-gray-600 font-bold mt-1">Worked: ${r.hours} hrs @ Rs. ${r.rate}/hr</p><p class="text-lg text-blue-600 font-bold">Total: Rs. ${r.totalCost.toLocaleString()}</p>${r.status!=='approved' ? `<button onclick="approveReading('${d.id}')" class="mt-2 bg-green-600 text-white px-4 py-1 rounded shadow text-sm font-bold">Approve</button>` : '<span class="text-green-600 font-bold text-xs border border-green-200 px-2 rounded">Approved</span>'}</div>`; list.appendChild(el); }); }); }
        window.approveReading = async (id) => { await updateDoc(doc(db, "meter_readings", id), { status: 'approved' }); };
        function loadBlocks(pid, isDevMode) { const container = document.getElementById('blocksContainer'); onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { container.innerHTML = ""; snap.forEach(d => { const b = d.data(); const isSold = b.status === 'sold'; const isFin = b.status === 'sold_finished'; const el = document.createElement('div'); const bg = isFin ? 'bg-slate-800 text-white' : (isSold ? 'bg-red-50 border-red-200' : 'bg-white border-blue-100 hover:border-blue-400'); el.className = `p-4 border-2 rounded-xl text-center cursor-pointer relative overflow-hidden ${bg}`; el.innerHTML = `<h4 class="font-bold text-xl">${b.name}</h4><p class="text-xs ${isFin?'text-gray-400':'text-gray-500'}">${b.size}P</p><p class="font-bold mt-2 ${isFin?'text-green-400':(isSold?'text-red-600':'text-blue-600')}">${isFin?'CLOSED':(isSold?'SOLD':`Rs.${b.price.toLocaleString()}`)}</p>`; el.onclick = () => { selectedBlockId = d.id; selectedBlockData = b; if(isSold||isFin) openPaymentModal(b); else openSellModal(); }; container.appendChild(el); }); }); }
        function openSellModal() { document.getElementById('sellModal').classList.remove('hidden'); document.getElementById('sellBlockName').innerText = selectedBlockData.name; document.getElementById('finalPrice').value = selectedBlockData.price; document.getElementById('payPlanType').value = "Cash"; toggleEPFields(); }
    </script>
</body>
</html>

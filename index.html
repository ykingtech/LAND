<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sithuliya Admin Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .luxury-font { font-family: 'Playfair Display', serif; }
        .glass-dark { background: rgba(0, 0, 0, 0.65); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* PDF Preview Overlay Style */
        #pdfPreviewOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000; /* Highest priority */
            overflow-y: auto;
            padding: 40px;
            display: none; /* Hidden by default */
        }
        
        /* Print Content Styling */
        .print-container {
            max-width: 210mm; /* A4 Width */
            margin: 0 auto;
            background: white;
            padding: 20px;
            color: black;
            font-family: 'Times New Roman', serif;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">

    <div id="pdfPreviewOverlay">
        <div class="print-container">
            <div class="text-center mb-8 border-b-2 border-black pb-4">
                <h1 class="text-4xl font-bold uppercase tracking-widest mb-2">Sithuliya Real Estate</h1>
                <p class="text-sm">No. 85, Ihala Kadigamuwa | 077-2338929</p>
                <h2 id="overlayPrintTitle" class="text-2xl font-bold mt-4 underline decoration-double">REPORT</h2>
                <p id="overlayPrintDate" class="text-sm mt-1"></p>
            </div>
            <div id="overlayPrintContent" class="w-full text-lg"></div>
            <div class="mt-16 flex justify-between text-sm pt-8">
                <div class="text-center w-48 border-t border-black pt-2">Prepared By</div>
                <div class="text-center w-48 border-t border-black pt-2">Authorized By</div>
            </div>
        </div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 cursor-pointer backdrop-blur-sm" onclick="closeImgModal()">
        <img id="imgModalSrc" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl border border-gray-600">
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1600596542815-2a429b08e695?q=80&w=2070&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="relative z-10 glass-dark p-10 rounded-3xl shadow-2xl w-96 text-center border border-white/10 animate-fade-in-up">
            <div class="mb-8">
                <i class="fas fa-gem text-5xl text-amber-500 mb-4 drop-shadow-lg"></i>
                <h1 class="text-4xl text-white luxury-font tracking-wide">Sithuliya</h1>
                <p class="text-amber-500/90 text-xs uppercase tracking-[0.4em] mt-2">Exclusive Real Estate</p>
            </div>
            <input type="password" id="pinInput" readonly class="w-full bg-transparent border-b border-white/20 text-white text-center text-4xl tracking-[1em] mb-8 py-2 focus:outline-none placeholder-white/10" placeholder="••••">
            <div class="grid grid-cols-3 gap-4 mb-6 max-w-[240px] mx-auto" id="pinPad"></div>
        </div>
    </div>

    <div id="mainApp" class="hidden flex h-full">
        <div class="w-64 bg-slate-900 text-white shadow-2xl flex flex-col z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-800">
                <h2 class="text-2xl luxury-font text-amber-500">Sithuliya <span class="text-[10px] font-sans text-slate-500 block tracking-widest mt-1">ADMIN CONSOLE</span></h2>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="nav('projects')" id="nav-projects" class="nav-btn w-full text-left p-3 rounded-xl bg-amber-600/20 text-amber-500 font-bold border border-amber-600/30"><i class="fas fa-map-marked-alt mr-3"></i> Projects</button>
                <button onclick="nav('readings')" id="nav-readings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tachometer-alt mr-3"></i> Meter Approvals</button>
                <button onclick="nav('reports')" id="nav-reports" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-chart-line mr-3"></i> Reports Center</button>
            </nav>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 px-8 border-b">
                <div class="relative w-96 group">
                    <input type="text" id="projSearch" placeholder="Search Projects or Customers..." class="w-full pl-10 pr-4 py-2 border-none bg-gray-100 rounded-full focus:ring-2 focus:ring-amber-500 transition text-sm group-hover:bg-gray-200">
                    <i class="fas fa-search absolute left-4 top-2.5 text-gray-400"></i>
                    <div id="searchResults" class="hidden absolute top-12 left-0 w-full bg-white shadow-2xl rounded-xl border border-gray-100 max-h-96 overflow-y-auto p-2 z-50"></div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="relative cursor-pointer" onclick="toggleNotifPanel()">
                        <div class="relative">
                            <i id="bellIcon" class="fas fa-bell text-gray-400 text-xl hover:text-slate-800 transition"></i>
                            <span id="notifBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">0</span>
                        </div>
                    </div>
                    <button onclick="document.getElementById('newProjectModal').classList.remove('hidden')" class="bg-slate-900 text-white px-5 py-2 rounded-full hover:bg-slate-800 shadow-lg shadow-slate-900/20 text-sm font-bold transition transform hover:scale-105"><i class="fas fa-plus mr-2"></i> New Project</button>
                </div>
            </header>

            <div id="notifPanel" class="hidden absolute top-20 right-8 w-80 bg-white shadow-2xl rounded-xl border border-gray-100 z-50 overflow-hidden animate-fade-in-down">
                <div class="bg-slate-900 p-3 text-white text-sm font-bold flex justify-between items-center">
                    <span><i class="fas fa-exclamation-circle mr-2"></i>Overdue Payments</span>
                    <button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
                </div>
                <div id="notifList" class="max-h-80 overflow-y-auto bg-gray-50"></div>
            </div>

            <main class="flex-1 overflow-auto p-8">
                
                <div id="page-projects">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Active Developments</h2>
                    <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="page-detail" class="hidden pb-20">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <button onclick="nav('projects')" class="text-gray-400 hover:text-slate-800 mb-2 font-bold text-xs uppercase tracking-wide"><i class="fas fa-arrow-left mr-2"></i> Back to Dashboard</button>
                            <h1 id="detailName" class="text-4xl font-bold text-slate-900 luxury-font">Project Name</h1>
                            <p class="text-gray-500 flex items-center mt-1 text-sm"><i class="fas fa-map-marker-alt mr-2 text-amber-500"></i> <span id="detailArea">Area</span></p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span id="detailStatus" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-amber-100 text-amber-800 border border-amber-200">Development</span>
                            <button id="endDevBtn" class="text-xs text-red-500 hover:underline font-bold">End Development Phase</button>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto hide-scrollbar">
                        <button onclick="subTab('overview')" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-slate-800 sub-tab whitespace-nowrap" id="st-overview">Overview & Blocks</button>
                        <button onclick="subTab('tasks')" class="px-6 py-3 font-bold text-gray-400 hover:text-slate-600 sub-tab whitespace-nowrap" id="st-tasks">Site Tasks & Costs</button>
                        <button onclick="subTab('finance')" class="px-6 py-3 font-bold text-gray-400 hover:text-slate-600 sub-tab whitespace-nowrap" id="st-finance">Financials</button>
                    </div>

                    <div id="view-overview">
                        <div id="devPhaseUI" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Add Land Blocks</h3>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input type="text" id="blockName" placeholder="No (e.g. A1)" class="p-2 border rounded w-20 text-sm">
                                    <input type="number" id="blockSize" placeholder="Perches" class="p-2 border rounded w-24 text-sm" oninput="calcBlockPrice()">
                                    <input type="number" id="blockPerchPrice" placeholder="Price/Perch" class="p-2 border rounded w-32 text-sm" oninput="calcBlockPrice()">
                                    <input type="number" id="blockPrice" placeholder="Total Price" class="p-2 border rounded flex-1 bg-gray-50 font-bold text-slate-700 text-sm" readonly>
                                    <button id="addBlockBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 shadow"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Assigned Vehicles</h3>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="regVehicleNo" placeholder="Vehicle Number (e.g. WP-1234)" class="p-2 border rounded w-full uppercase text-sm">
                                    <button id="regVehicleBtn" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900 shadow">Assign</button>
                                </div>
                                <div id="vehicleList" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-slate-700">Land Blocks Map</h3>
                        <div id="blocksContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>

                    <div id="view-tasks" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Site Operations</h3>
                            <button onclick="document.getElementById('newTaskModal').classList.remove('hidden')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900"><i class="fas fa-plus mr-2"></i> Assign Task</button>
                        </div>
                        <div id="adminTaskList" class="space-y-4"></div>
                    </div>

                    <div id="view-finance" class="hidden">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-2xl text-slate-800 luxury-font">Profit Analysis</h3>
                                <button onclick="openExpenseModal()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 transition"><i class="fas fa-receipt mr-2"></i> Add Misc Expense</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="p-6 rounded-xl bg-green-50 border border-green-100">
                                    <p class="text-xs text-green-600 uppercase font-bold tracking-widest mb-2">Revenue (Sold)</p>
                                    <h4 id="finIncome" class="text-3xl font-bold text-green-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-red-50 border border-red-100">
                                    <p class="text-xs text-red-600 uppercase font-bold tracking-widest mb-2">Cost (Exp + Tasks)</p>
                                    <h4 id="finExpense" class="text-3xl font-bold text-red-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-slate-50 border border-slate-200 relative overflow-hidden">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent"></div>
                                    <p class="text-xs text-slate-600 uppercase font-bold tracking-widest mb-2 relative z-10">Net Profit</p>
                                    <h4 id="finProfit" class="text-3xl font-bold text-slate-800 relative z-10">Rs. 0.00</h4>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Expense Ledger</h3>
                        <table class="w-full text-sm text-left bg-white rounded-lg overflow-hidden shadow-sm"><tbody id="expenseList"></tbody></table>
                    </div>
                </div>

                <div id="page-readings" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">Meter Approvals</h2>
                    <div id="readingsList" class="space-y-4"></div>
                </div>

                <div id="page-reports" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Financial Reports Center</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div onclick="openReportGen('cost')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-lg cursor-pointer border border-gray-100 transition group">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-4 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition"><i class="fas fa-project-diagram text-xl"></i></div>
                            <h3 class="font-bold text-lg text-slate-800">Project Cost Breakdown</h3>
                            <p class="text-xs text-gray-500 mt-2">Generate cost analysis per project.</p>
                        </div>
                        <div onclick="openReportGen('petty')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-lg cursor-pointer border border-gray-100 transition group">
                            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mb-4 text-amber-600 group-hover:bg-amber-600 group-hover:text-white transition"><i class="fas fa-coins text-xl"></i></div>
                            <h3 class="font-bold text-lg text-slate-800">Petty Cash</h3>
                            <p class="text-xs text-gray-500 mt-2">Daily cash flow statements.</p>
                        </div>
                        <div onclick="openReportGen('pl')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-lg cursor-pointer border border-gray-100 transition group">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-4 text-green-600 group-hover:bg-green-600 group-hover:text-white transition"><i class="fas fa-chart-pie text-xl"></i></div>
                            <h3 class="font-bold text-lg text-slate-800">Profit & Loss</h3>
                            <p class="text-xs text-gray-500 mt-2">Income vs Expense statements.</p>
                        </div>
                        <div onclick="openReportGen('bs')" class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-lg cursor-pointer border border-gray-100 transition group">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-4 text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition"><i class="fas fa-balance-scale text-xl"></i></div>
                            <h3 class="font-bold text-lg text-slate-800">Balance Sheet</h3>
                            <p class="text-xs text-gray-500 mt-2">Assets, Liabilities & Equity.</p>
                        </div>
                    </div>

                    <div id="reportGenArea" class="mt-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100 hidden">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 id="reportTitle" class="text-xl font-bold text-slate-800">Generate Report</h3>
                            <button onclick="document.getElementById('reportGenArea').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <div id="reportProjectSelect" class="mb-6 hidden">
                            <label class="text-xs font-bold uppercase text-gray-500">Select Project</label>
                            <select id="repProjDropdown" class="w-full md:w-1/3 p-2 border rounded mt-1 bg-gray-50"></select>
                            <button onclick="generateProjectCostReport()" class="bg-blue-600 text-white px-4 py-2 rounded ml-2 text-sm font-bold">Load Data</button>
                        </div>

                        <div id="reportInputTable" class="hidden mb-6">
                            <table class="w-full text-sm text-left border rounded">
                                <thead class="bg-gray-100"><tr><th class="p-2">Description</th><th class="p-2 text-right">Amount</th><th class="p-2 w-10"></th></tr></thead>
                                <tbody id="reportRows"></tbody>
                            </table>
                            <button onclick="addReportRow()" class="mt-2 text-blue-600 text-xs font-bold">+ Add Line Item</button>
                        </div>

                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="saveCurrentReport()" class="bg-amber-500 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-amber-600 flex items-center gap-2">
                                <i class="fas fa-save"></i> Save to History
                            </button>
                            <button onclick="downloadPDF()" class="bg-slate-900 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-slate-800 flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i> Download PDF
                            </button>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-slate-700 mb-4">Saved Reports History</h3>
                        <div id="savedReportsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="newProjectModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-xl font-bold mb-6 text-slate-800">New Project</h2>
            <input type="text" id="newProjName" placeholder="Project Name" class="w-full p-3 border rounded-lg mb-3 bg-gray-50">
            <input type="text" id="newProjArea" placeholder="Location" class="w-full p-3 border rounded-lg mb-6 bg-gray-50">
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button>
                <button id="createProjBtn" class="px-6 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800">Create</button>
            </div>
        </div>
    </div>

    <div id="newTaskModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <h2 class="text-xl font-bold mb-4 text-slate-800">Assign Site Task</h2>
            <input type="text" id="newTaskTitle" placeholder="Title (e.g. Build Wall)" class="w-full p-3 border rounded-lg mb-3">
            <textarea id="newTaskDesc" placeholder="Instructions" class="w-full p-3 border rounded-lg mb-6 h-24"></textarea>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('newTaskModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button>
                <button id="saveTaskBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Assign</button>
            </div>
        </div>
    </div>

    <div id="taskApproveModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold text-slate-800">Review Task</h2>
                <button onclick="document.getElementById('taskApproveModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <h3 id="approveTaskTitle" class="text-2xl font-bold text-slate-800 mb-2">Title</h3>
                <p class="text-lg mb-4">Submitted Cost: <span id="approveTaskCost" class="font-bold text-green-600 text-2xl"></span></p>
                <div id="approveTaskPhotos" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end">
                <button id="confirmApproveTaskBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700">APPROVE & PAY</button>
            </div>
        </div>
    </div>

    <div id="sellModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-8 rounded-2xl w-full max-w-4xl my-10 shadow-2xl relative">
            <button onclick="closeSellModal()" class="absolute top-6 right-6 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="border-b pb-4 mb-6"><h2 class="text-3xl font-bold text-slate-800 luxury-font">Sales Agreement</h2><p class="text-amber-600 font-bold mt-1">Block: <span id="sellBlockName"></span></p></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1">Customer Details</h3>
                    <input type="text" id="cusName" placeholder="Full Name" class="w-full p-3 border rounded-lg bg-gray-50">
                    <textarea id="cusAddress" placeholder="Address" class="w-full p-3 border rounded-lg h-20 bg-gray-50"></textarea>
                    <div class="flex gap-3"><input type="text" id="cusNIC" placeholder="NIC" class="w-full p-3 border rounded-lg bg-gray-50"><input type="text" id="cusPhone" placeholder="Phone" class="w-full p-3 border rounded-lg bg-gray-50"></div>
                </div>
                <div class="space-y-4">
                    <h3 class="font-bold text-gray-400 text-xs uppercase tracking-widest border-b pb-1">Payment Plan</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-[10px] font-bold text-gray-500">PRICE</label><input type="number" id="finalPrice" class="w-full p-3 border rounded-lg font-bold text-slate-800 text-lg" oninput="calculateEP()"></div>
                        <div><label class="text-[10px] font-bold text-gray-500">ADVANCE</label><input type="number" id="advancePay" class="w-full p-3 border rounded-lg font-bold text-green-700 text-lg" oninput="calculateEP()"></div>
                    </div>
                    <select id="payPlanType" class="w-full p-3 border rounded-lg bg-slate-800 text-white font-bold" onchange="toggleEPFields()"><option value="Cash">Cash Sale</option><option value="EP">Easy Payment</option></select>
                    <div id="epFields" class="hidden bg-blue-50/50 p-4 rounded-xl border border-blue-100 space-y-3">
                        <div class="flex gap-3">
                            <div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">RATE %</label><input type="number" id="epRate" value="15" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div>
                            <div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">MONTHS</label><input type="number" id="epMonths" value="60" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div>
                            <div class="w-1/3"><label class="text-[10px] font-bold text-blue-800">CYCLE (DAYS)</label><input type="number" id="epCycle" value="30" class="w-full p-2 border rounded text-center font-bold text-blue-600"></div>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-blue-200"><span class="text-sm font-bold text-blue-900">Monthly:</span><span id="epMonthlyInst" class="text-xl font-bold text-blue-700">0.00</span></div>
                        <div class="hidden"><span id="epTotalPayable"></span></div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-4 pt-6 border-t">
                <button onclick="processSale(true)" class="px-6 py-3 bg-slate-900 text-white font-bold rounded-lg shadow-lg hover:bg-slate-800 flex items-center gap-2"><i class="fas fa-file-pdf"></i> Save & Download Receipt</button>
            </div>
        </div>
    </div>

    <div id="paymentModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl relative">
            <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="flex justify-between items-start mb-6 border-b pb-4"><div><h2 class="text-2xl font-bold text-slate-800">Payment Record</h2><p id="payBlockInfo" class="text-amber-600 font-bold text-sm"></p></div><button id="editPlanBtn" class="text-xs text-blue-600 underline font-bold" onclick="toggleEditPlan()">Edit Interest/Plan</button></div>
            <div id="editPlanSection" class="hidden bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4"><h4 class="text-xs font-bold text-yellow-700 uppercase mb-2">Adjust Plan</h4><div class="flex gap-2 mb-2"><input type="number" id="editNewRate" placeholder="New Rate %" class="p-2 border rounded w-1/3 text-sm"><input type="number" id="editNewMonths" placeholder="New Months" class="p-2 border rounded w-1/3 text-sm"><button id="savePlanChangesBtn" class="bg-yellow-600 text-white px-3 rounded text-sm font-bold w-1/3 hover:bg-yellow-700">Update</button></div></div>
            <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-3 bg-slate-100 rounded-lg"><p class="text-[10px] uppercase font-bold text-gray-500">Payable</p><p id="pmTotal" class="font-bold text-slate-800 text-lg">0.00</p></div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-100"><p class="text-[10px] uppercase font-bold text-green-600">Paid</p><p id="pmPaid" class="font-bold text-green-700 text-lg">0.00</p></div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Balance</p><p id="pmBalance" class="font-bold text-red-700 text-lg">0.00</p></div>
            </div>
            <div id="addPaymentSection" class="bg-slate-50 p-4 rounded-xl mb-6 border border-gray-200">
                <div class="flex gap-3 mb-2"><input type="date" id="newPayDate" class="w-1/3 p-2 border rounded text-sm"><input type="number" id="newPayAmount" placeholder="Amount" class="w-1/3 p-2 border rounded text-sm font-bold text-slate-800"><button id="submitPayBtn" class="w-1/3 bg-green-600 text-white rounded font-bold text-sm shadow hover:bg-green-700">ADD PAYMENT</button></div>
            </div>
            <div id="paymentCompleteMsg" class="hidden bg-green-100 text-green-800 p-4 rounded-xl text-center font-bold mb-6 border border-green-200"><i class="fas fa-check-circle mr-2"></i> FULLY PAID & CLOSED</div>
            <h3 class="font-bold text-xs text-gray-400 uppercase mb-2">History</h3>
            <div class="overflow-y-auto max-h-40 border rounded-lg"><table class="w-full text-xs text-left"><tbody id="paymentHistoryList" class="divide-y"></tbody></table></div>
        </div>
    </div>

    <div id="expenseModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-96 shadow-xl">
            <h2 class="text-lg font-bold mb-4 text-red-600">Add Expense</h2>
            <input type="text" id="expDesc" placeholder="Description" class="w-full p-2 border rounded mb-2">
            <input type="number" id="expAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4 font-bold">
            <div class="flex justify-end gap-2"><button onclick="document.getElementById('expenseModal').classList.add('hidden')" class="px-4 py-2 text-gray-500">Cancel</button><button id="saveExpenseBtn" class="px-4 py-2 bg-red-600 text-white rounded font-bold">Save</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, collectionGroup, addDoc, deleteDoc, onSnapshot, query, where, orderBy, doc, updateDoc, arrayUnion, getDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlhMTQ-_sorFg_0ULpjf9kvjuIAWQkDVY",
            authDomain: "land-4d291.firebaseapp.com",
            projectId: "land-4d291",
            storageBucket: "land-4d291.firebasestorage.app",
            messagingSenderId: "1002505362762",
            appId: "1:1002505362762:web:f30e7ba82d8a344670f5b3",
            measurementId: "G-2EEQPP29VR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LOGIN ---
        const pinPad = document.getElementById('pinPad'); const pinInput = document.getElementById('pinInput');
        [1,2,3,4,5,6,7,8,9,0].forEach(num => {
            const btn = document.createElement('button'); 
            btn.className = "h-16 w-16 rounded-full text-xl font-bold bg-white/10 hover:bg-amber-500/20 text-white border border-white/20 transition transform active:scale-95"; 
            btn.innerText = num;
            btn.onclick = () => { if(pinInput.value.length < 4) pinInput.value += num; }; 
            pinPad.appendChild(btn);
        });
        const goBtn = document.createElement('button'); 
        goBtn.innerHTML = "<i class='fas fa-arrow-right'></i>"; 
        goBtn.className="h-16 w-16 bg-amber-500 text-white rounded-full font-bold shadow-[0_0_15px_#f59e0b] hover:bg-amber-600 transition";
        goBtn.onclick = () => { if(pinInput.value==="1234"){ document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); initApp(); } }; 
        pinPad.appendChild(goBtn);

        // --- NAVIGATION & UI ---
        window.closeImgModal = () => document.getElementById('imgModal').classList.add('hidden');
        window.closeSellModal = () => document.getElementById('sellModal').classList.add('hidden');
        window.openExpenseModal = () => document.getElementById('expenseModal').classList.remove('hidden');
        window.toggleNotifPanel = () => document.getElementById('notifPanel').classList.toggle('hidden');
        
        window.nav = (page) => {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('bg-amber-600/20','text-amber-500'); b.classList.add('text-gray-400'); });
            const btn = document.getElementById(`nav-${page}`);
            if(btn) { btn.classList.add('bg-amber-600/20','text-amber-500'); btn.classList.remove('text-gray-400'); }
            if(page==='readings') loadMeterReadings();
            if(page==='reports') loadSavedReports();
        };

        window.subTab = (tab) => {
            document.querySelectorAll('.sub-tab').forEach(t => { t.classList.remove('text-slate-800', 'border-slate-800'); t.classList.add('text-gray-400'); });
            document.getElementById(`st-${tab}`).classList.add('text-slate-800', 'border-slate-800');
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        };

        window.calcBlockPrice = () => {
            const size = parseFloat(document.getElementById('blockSize').value) || 0;
            const price = parseFloat(document.getElementById('blockPerchPrice').value) || 0;
            document.getElementById('blockPrice').value = size * price;
        };

        window.toggleEPFields = () => {
            const isEP = document.getElementById('payPlanType').value === 'EP';
            document.getElementById('epFields').classList.toggle('hidden', !isEP);
            if(isEP) window.calculateEP();
        };

        window.calculateEP = () => {
            const price = parseFloat(document.getElementById('finalPrice').value) || 0;
            const advance = parseFloat(document.getElementById('advancePay').value) || 0;
            const rate = parseFloat(document.getElementById('epRate').value) || 15;
            const months = parseFloat(document.getElementById('epMonths').value) || 60;
            const balance = price - advance;
            if(balance < 0) return;
            const totalInterest = balance * (rate / 100) * (months/12);
            const totalPayable = balance + totalInterest;
            document.getElementById('epTotalPayable').innerText = totalPayable.toFixed(2);
            document.getElementById('epMonthlyInst').innerText = (totalPayable / months).toFixed(2);
        };

        // --- DATA LOGIC ---
        let currentProjId = null; let currentProjName = ""; let selectedBlockId = null; let selectedBlockData = null;

        function initApp() { loadProjects(); listenForOverduePayments(); }

        // --- DEEP SEARCH ---
        document.getElementById('projSearch').addEventListener('input', async (e) => {
            const term = e.target.value.toLowerCase();
            const resDiv = document.getElementById('searchResults');
            resDiv.innerHTML = "";
            if(term.length < 2) { resDiv.classList.add('hidden'); return; }

            const projQ = query(collection(db, "projects"));
            const projSnap = await getDocs(projQ);
            let results = [];
            projSnap.forEach(d => { if(d.data().name.toLowerCase().includes(term)) results.push({type:'Project', name:d.data().name, id:d.id}); });

            const blocksQ = query(collectionGroup(db, 'blocks'), where('status', 'in', ['sold', 'sold_finished']));
            const blocksSnap = await getDocs(blocksQ);
            blocksSnap.forEach(d => {
                const b = d.data();
                if(b.customer && b.customer.name.toLowerCase().includes(term)) {
                    results.push({type:'Customer', name: b.customer.name, detail: `Block: ${b.name}`, ref: d.ref});
                }
            });

            if(results.length > 0) {
                resDiv.classList.remove('hidden');
                results.forEach(r => {
                    const div = document.createElement('div');
                    div.className = "p-2 hover:bg-gray-50 cursor-pointer border-b text-sm";
                    div.innerHTML = `<span class="font-bold text-slate-800">${r.name}</span> <span class="text-xs text-gray-500 uppercase ml-2 bg-gray-200 px-1 rounded">${r.type}</span><div class="text-xs text-gray-400">${r.detail || ''}</div>`;
                    div.onclick = async () => {
                        resDiv.classList.add('hidden');
                        if(r.type === 'Project') { openProject(r.id, {name:r.name, area:'...'}); }
                        else { alert("Navigate to project containing this block to view details."); }
                    };
                    resDiv.appendChild(div);
                });
            } else { resDiv.innerHTML = "<div class='p-2 text-sm text-gray-400'>No matches found.</div>"; resDiv.classList.remove('hidden'); }
        });

        // --- PROJECTS ---
        function loadProjects() {
            onSnapshot(query(collection(db, "projects"), orderBy("createdAt", "desc")), (snap) => {
                const grid = document.getElementById('projectGrid'); grid.innerHTML = "";
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-6 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer border border-gray-100 transition relative overflow-hidden group";
                    el.onclick = () => openProject(docSnap.id, d);
                    el.innerHTML = `
                        <div class="absolute top-0 left-0 w-2 h-full bg-slate-900 group-hover:bg-amber-500 transition"></div>
                        <h3 class="font-bold text-lg text-slate-900 pl-2">${d.name}</h3>
                        <p class="text-sm text-gray-500 pl-2"><i class="fas fa-map-marker-alt mr-1"></i> ${d.area}</p>
                        <span class="text-[10px] uppercase font-bold bg-gray-100 px-2 py-1 rounded absolute top-4 right-4 text-gray-500 tracking-wider">${d.status}</span>
                    `;
                    grid.appendChild(el);
                });
            });
        }

        document.getElementById('createProjBtn').addEventListener('click', async () => {
            const name = document.getElementById('newProjName').value; const area = document.getElementById('newProjArea').value;
            if(!name) return;
            await addDoc(collection(db, "projects"), { name, area, status: 'development', createdAt: new Date() });
            document.getElementById('newProjectModal').classList.add('hidden');
        });

        function openProject(id, data) {
            currentProjId = id; currentProjName = data.name;
            nav('detail');
            document.getElementById('detailName').innerText = data.name; document.getElementById('detailArea').innerText = data.area || 'Unknown';
            document.getElementById('detailStatus').innerText = data.status || 'Active';
            
            const isDev = data.status === 'development';
            document.getElementById('devPhaseUI').style.display = isDev ? 'grid' : 'none';
            document.getElementById('endDevBtn').style.display = isDev ? 'block' : 'none';

            const vList = document.getElementById('vehicleList'); vList.innerHTML = "";
            (data.assignedVehicles || []).forEach(v => vList.innerHTML += `<span class="bg-gray-200 px-2 py-1 rounded text-xs font-bold mr-1">${v}</span>`);

            loadBlocks(id, isDev);
            loadExpensesAndProfit(id);
            loadProjectTasks(id);
        }

        document.getElementById('addBlockBtn').addEventListener('click', async () => {
            const name = document.getElementById('blockName').value; const size = document.getElementById('blockSize').value;
            const price = document.getElementById('blockPrice').value; const pPrice = document.getElementById('blockPerchPrice').value;
            if(!name) return;
            await addDoc(collection(db, `projects/${currentProjId}/blocks`), { name, size, price: parseFloat(price), perchPrice: parseFloat(pPrice), status: "available" });
            document.getElementById('blockName').value = ""; document.getElementById('blockPrice').value = "";
        });

        document.getElementById('regVehicleBtn').addEventListener('click', async () => {
            const vNo = document.getElementById('regVehicleNo').value.toUpperCase(); if(!vNo) return;
            await updateDoc(doc(db, "projects", currentProjId), { assignedVehicles: arrayUnion(vNo) });
            document.getElementById('regVehicleNo').value = "";
        });

        document.getElementById('endDevBtn').addEventListener('click', async () => {
            if(confirm("End Development?")) { await updateDoc(doc(db, "projects", currentProjId), { status: "sales" }); openProject(currentProjId, {name:currentProjName, area:'...', status:'sales'}); }
        });

        // --- TASKS (ADMIN) ---
        function loadProjectTasks(pid) {
            onSnapshot(query(collection(db, `projects/${pid}/tasks`), orderBy("createdAt", "desc")), (snap) => {
                const list = document.getElementById('adminTaskList'); list.innerHTML = "";
                snap.forEach(d => {
                    const t = d.data();
                    let statusBadge = t.status === 'completed' ? '<span class="text-green-600 font-bold text-xs bg-green-100 px-2 rounded">Paid</span>' : (t.status === 'pending_approval' ? '<span class="text-yellow-600 font-bold text-xs bg-yellow-100 px-2 rounded animate-pulse">Needs Review</span>' : '<span class="text-gray-400 text-xs bg-gray-100 px-2 rounded">Pending</span>');
                    
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center";
                    el.innerHTML = `
                        <div><h4 class="font-bold text-slate-800">${t.title}</h4><p class="text-xs text-gray-500">${t.description||'-'}</p><div class="mt-1">${statusBadge} ${t.submittedCost ? `<span class="ml-2 font-bold">Rs. ${t.submittedCost}</span>` : ''}</div></div>
                        ${t.status === 'pending_approval' ? `<button onclick="openApproveModal('${d.id}', '${t.title}', ${t.submittedCost}, '${t.photos.join(',')}')" class="bg-slate-900 text-white px-4 py-2 rounded text-xs font-bold">Review</button>` : ''}
                    `;
                    list.appendChild(el);
                });
            });
        }
        document.getElementById('saveTaskBtn').addEventListener('click', async () => {
            await addDoc(collection(db, `projects/${currentProjId}/tasks`), { title: document.getElementById('newTaskTitle').value, description: document.getElementById('newTaskDesc').value, status: 'new', createdAt: serverTimestamp() });
            document.getElementById('newTaskModal').classList.add('hidden');
        });
        
        let activeApproveId = null; let activeApproveCost = 0;
        window.openApproveModal = (id, title, cost, photosStr) => {
            activeApproveId = id; activeApproveCost = cost;
            document.getElementById('approveTaskTitle').innerText = title; document.getElementById('approveTaskCost').innerText = "Rs. " + cost.toLocaleString();
            const div = document.getElementById('approveTaskPhotos'); div.innerHTML = "";
            photosStr.split(',').forEach(src => div.innerHTML += `<img src="${src}" class="w-full h-32 object-cover rounded border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${src}';document.getElementById('imgModal').classList.remove('hidden')">`);
            document.getElementById('taskApproveModal').classList.remove('hidden');
        };
        document.getElementById('confirmApproveTaskBtn').addEventListener('click', async () => {
            await updateDoc(doc(db, `projects/${currentProjId}/tasks/${activeApproveId}`), { status: 'completed' });
            await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `Task: ${document.getElementById('approveTaskTitle').innerText}`, amount: activeApproveCost, date: new Date().toISOString().split('T')[0], createdAt: serverTimestamp() });
            document.getElementById('taskApproveModal').classList.add('hidden');
        });

        // --- BLOCKS & SALES ---
        function loadBlocks(pid, isDevMode) {
            const container = document.getElementById('blocksContainer');
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => {
                container.innerHTML = "";
                snap.forEach(d => {
                    const b = d.data(); const isSold = b.status === 'sold'; const isFin = b.status === 'sold_finished';
                    const el = document.createElement('div');
                    const bg = isFin ? 'bg-slate-800 text-white' : (isSold ? 'bg-red-50 border-red-200' : 'bg-white border-blue-100 hover:border-blue-400');
                    el.className = `p-4 border-2 rounded-xl text-center cursor-pointer relative overflow-hidden ${bg}`;
                    el.innerHTML = `<h4 class="font-bold text-xl">${b.name}</h4><p class="text-xs ${isFin?'text-gray-400':'text-gray-500'}">${b.size}P</p><p class="font-bold mt-2 ${isFin?'text-green-400':(isSold?'text-red-600':'text-blue-600')}">${isFin?'CLOSED':(isSold?'SOLD':`Rs.${b.price.toLocaleString()}`)}</p>`;
                    if(!isDevMode) el.onclick = () => { selectedBlockId = d.id; selectedBlockData = b; if(isSold||isFin) openPaymentModal(b); else openSellModal(); };
                    container.appendChild(el);
                });
            });
        }

        function openSellModal() {
            document.getElementById('sellModal').classList.remove('hidden');
            document.getElementById('sellBlockName').innerText = selectedBlockData.name;
            document.getElementById('finalPrice').value = selectedBlockData.price;
            document.getElementById('payPlanType').value = "Cash"; toggleEPFields();
        }

        window.processSale = async (downloadPdf) => {
            const cus = { name: document.getElementById('cusName').value, address: document.getElementById('cusAddress').value, nic: document.getElementById('cusNIC').value, phone: document.getElementById('cusPhone').value };
            const advance = parseFloat(document.getElementById('advancePay').value);
            const price = parseFloat(document.getElementById('finalPrice').value);
            const plan = document.getElementById('payPlanType').value;
            
            let ep = {}; let nextD = null;
            if(plan === 'EP') {
                const cycle = parseInt(document.getElementById('epCycle').value);
                ep = { rate: document.getElementById('epRate').value, months: document.getElementById('epMonths').value, cycleDays: cycle, totalPayable: parseFloat(document.getElementById('epTotalPayable').innerText), paidAmount: advance };
                const d = new Date(); d.setDate(d.getDate() + cycle); nextD = d;
            }

            if(!cus.name || !advance) return alert("Missing Info");

            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), {
                status: 'sold', soldPrice: price, customer: cus, soldDate: new Date(),
                payment: { totalPrice: price, advancePaid: advance, planType: plan, epDetails: ep, nextPaymentDate: nextD, history: [{date: new Date(), amount: advance, type: 'Advance'}] }
            });

            if(downloadPdf) {
                document.getElementById('overlayPrintTitle').innerText = "OFFICIAL RECEIPT";
                document.getElementById('overlayPrintDate').innerText = new Date().toLocaleDateString();
                document.getElementById('overlayPrintContent').innerHTML = `
                    <div style="margin-top:30px; line-height:1.8;">
                        <p><strong>Received From:</strong> ${cus.name}</p>
                        <p><strong>Amount:</strong> Rs. ${advance.toLocaleString()}</p>
                        <hr class="my-6 border-gray-400">
                        <p><strong>Project:</strong> ${currentProjName}</p>
                        <p><strong>Block:</strong> ${selectedBlockData.name}</p>
                        <p><strong>Payment Plan:</strong> ${plan === 'EP' ? 'Easy Payment (Installment)' : 'Cash / Outright'}</p>
                    </div>
                `;
                await downloadPDF();
            }
            closeSellModal();
        };

        // --- PAYMENTS & AUTO-LOCK ---
        window.openPaymentModal = (data) => {
            document.getElementById('paymentModal').classList.remove('hidden');
            const isFin = data.status === 'sold_finished';
            document.getElementById('addPaymentSection').style.display = isFin ? 'none' : 'block';
            document.getElementById('editPlanBtn').style.display = (isFin || data.payment.planType !== 'EP') ? 'none' : 'block';
            document.getElementById('paymentCompleteMsg').classList.toggle('hidden', !isFin);
            document.getElementById('payBlockInfo').innerText = `${data.name} - ${data.customer.name}`;
            
            let total = data.soldPrice; let paid = data.soldPrice;
            if(data.payment.planType === 'EP') { total = data.payment.epDetails.totalPayable; paid = data.payment.epDetails.paidAmount || 0; }
            document.getElementById('pmTotal').innerText = total.toLocaleString(); document.getElementById('pmPaid').innerText = paid.toLocaleString(); document.getElementById('pmBalance').innerText = (total-paid).toLocaleString();
            
            const tbody = document.getElementById('paymentHistoryList'); tbody.innerHTML = "";
            (data.payment.history||[]).forEach(h => {
                const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date);
                tbody.innerHTML += `<tr><td class="py-2">${d.toLocaleDateString()}</td><td class="font-bold">Rs.${h.amount.toLocaleString()}</td><td class="text-gray-500">${h.type}</td></tr>`;
            });
            document.getElementById('newPayDate').valueAsDate = new Date();
        };

        document.getElementById('submitPayBtn').addEventListener('click', async () => {
            const amt = parseFloat(document.getElementById('newPayAmount').value);
            if(!amt) return;
            const b = selectedBlockData;
            
            if(b.payment.planType === 'EP') {
                const newPaid = (b.payment.epDetails.paidAmount||0) + amt;
                const nextD = new Date(); nextD.setDate(nextD.getDate() + (b.payment.epDetails.cycleDays || 30));
                let up = { "payment.epDetails.paidAmount": newPaid, "payment.nextPaymentDate": nextD, "payment.history": arrayUnion({date:new Date(), amount:amt, type:'Installment'}) };
                if(newPaid >= b.payment.epDetails.totalPayable - 100) up["status"] = "sold_finished"; // Auto Lock
                await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), up);
            }
            document.getElementById('paymentModal').classList.add('hidden');
        });

        window.toggleEditPlan = () => document.getElementById('editPlanSection').classList.toggle('hidden');
        document.getElementById('savePlanChangesBtn').addEventListener('click', async () => {
            const rate = parseFloat(document.getElementById('editNewRate').value);
            const months = parseFloat(document.getElementById('editNewMonths').value);
            const b = selectedBlockData;
            const bal = b.soldPrice - b.payment.advancePaid; 
            const newInt = bal * (rate/100) * (months/12);
            const newTot = bal + newInt + b.payment.advancePaid;
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { "payment.epDetails.rate": rate, "payment.epDetails.months": months, "payment.epDetails.totalPayable": newTot });
            alert("Updated"); document.getElementById('paymentModal').classList.add('hidden');
        });

        // --- PROFIT & EXPENSES ---
        document.getElementById('saveExpenseBtn').addEventListener('click', async () => {
            await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: document.getElementById('expDesc').value, amount: parseFloat(document.getElementById('expAmount').value), date: new Date().toISOString().split('T')[0], createdAt: serverTimestamp() });
            document.getElementById('expenseModal').classList.add('hidden');
        });

        function loadExpensesAndProfit(pid) {
            let inc = 0;
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => {
                inc = 0; snap.forEach(d => { const b = d.data(); if(b.status.includes('sold')) inc += b.soldPrice; });
                document.getElementById('finIncome').innerText = "Rs. " + inc.toLocaleString(); updateNet(inc, null);
            });
            onSnapshot(query(collection(db, `projects/${pid}/expenses`), orderBy("date","desc")), (snap) => {
                let exp = 0; const list = document.getElementById('expenseList'); list.innerHTML = "";
                snap.forEach(d => { 
                    const e = d.data(); exp += e.amount;
                    list.innerHTML += `<tr class="border-b"><td class="p-3 text-gray-500">${e.date}</td><td class="p-3 font-bold">${e.description}</td><td class="p-3 text-right text-red-600">-${e.amount.toLocaleString()}</td></tr>`;
                });
                document.getElementById('finExpense').innerText = "Rs. " + exp.toLocaleString(); updateNet(null, exp);
            });
        }
        let cInc=0, cExp=0; 
        function updateNet(i,e) { 
            if(i!==null) cInc=i; if(e!==null) cExp=e; 
            const net = cInc-cExp; 
            document.getElementById('finProfit').innerText = "Rs. " + net.toLocaleString(); 
            document.getElementById('finProfit').className = `text-3xl font-bold relative z-10 ${net>=0?'text-slate-800':'text-red-600'}`;
        }

        // --- METER APPROVALS ---
        function loadMeterReadings() {
            onSnapshot(query(collection(db, "meter_readings"), orderBy("timestamp", "desc")), (snap) => {
                const list = document.getElementById('readingsList'); list.innerHTML = "";
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div'); el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4";
                    el.innerHTML = `
                        <img src="${r.imageBase64}" onclick="document.getElementById('imgModalSrc').src='${r.imageBase64}';document.getElementById('imgModal').classList.remove('hidden')" class="w-24 h-24 object-cover rounded-lg cursor-pointer">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg text-slate-800">${r.vehicleNo} <span class="text-sm text-gray-500 font-normal">(${r.projectName})</span></h4>
                            <p class="text-sm text-gray-600 font-bold mt-1">Worked: ${r.hours} hrs @ Rs. ${r.rate}/hr</p>
                            <p class="text-lg text-blue-600 font-bold">Total: Rs. ${r.totalCost.toLocaleString()}</p>
                            ${r.status!=='approved' ? `<button onclick="approveReading('${d.id}')" class="mt-2 bg-green-600 text-white px-4 py-1 rounded shadow text-sm font-bold">Approve</button>` : '<span class="text-green-600 font-bold text-xs border border-green-200 px-2 rounded">Approved</span>'}
                        </div>
                    `;
                    list.appendChild(el);
                });
            });
        }
        window.approveReading = async (id) => { await updateDoc(doc(db, "meter_readings", id), { status: 'approved' }); };

        function listenForOverduePayments() { /* Logic intact */ }

        // --- REPORTS & PDF DOWNLOAD ---
        let currentReportType = "";
        
        window.openReportGen = async (type) => {
            currentReportType = type;
            document.getElementById('reportGenArea').classList.remove('hidden');
            document.getElementById('reportInputTable').classList.remove('hidden');
            document.getElementById('reportRows').innerHTML = ""; 
            
            const titles = { 'cost': 'Project Cost Breakdown', 'petty': 'Petty Cash Statement', 'pl': 'Profit & Loss Statement', 'bs': 'Balance Sheet' };
            document.getElementById('reportTitle').innerText = titles[type];
            document.getElementById('overlayPrintTitle').innerText = titles[type];
            document.getElementById('overlayPrintDate').innerText = `Generated: ${new Date().toLocaleDateString()}`;

            const projSel = document.getElementById('reportProjectSelect');
            if(type === 'cost') {
                projSel.classList.remove('hidden');
                const dd = document.getElementById('repProjDropdown');
                dd.innerHTML = "<option>Loading Projects...</option>";
                try {
                    const q = query(collection(db, "projects"), orderBy("name"));
                    const snap = await getDocs(q);
                    dd.innerHTML = "";
                    if(snap.empty) dd.innerHTML = "<option>No Projects Found</option>";
                    else snap.forEach(d => dd.innerHTML += `<option value="${d.id}">${d.data().name}</option>`);
                } catch (error) {
                    console.error("Error loading projects:", error);
                    dd.innerHTML = "<option>Error</option>";
                }
            } else {
                projSel.classList.add('hidden');
                if(type === 'pl') { addRow('Revenue (Sales)', 0); addRow('Cost of Sales', 0); addRow('Admin Expenses', 0); }
                else if (type === 'bs') { addRow('Current Assets', 0); addRow('Non-current Assets', 0); addRow('Liabilities', 0); addRow('Equity', 0); }
                else { addRow('Balance Brought Forward', 0); }
            }
        };

        // UX Improved Add Row: Selects text on focus, clear 0 if value is 0
        window.addReportRow = () => addRow("", 0);
        function addRow(desc, amt) {
            const tr = document.createElement('tr');
            // Logic: if amt is 0, show empty string in value, but keep logic
            const valStr = amt === 0 ? '' : amt;
            tr.innerHTML = `<td><input type="text" class="w-full p-1 border rounded" value="${desc}" placeholder="Item Description"></td><td><input type="number" class="w-full p-1 border rounded text-right" value="${valStr}" placeholder="0" onfocus="this.select()"></td><td><button onclick="this.closest('tr').remove(); updatePrintPreview()" class="text-red-500"><i class="fas fa-trash"></i></button></td>`;
            document.getElementById('reportRows').appendChild(tr);
            updatePrintPreview();
        }

        window.generateProjectCostReport = async () => {
            const pid = document.getElementById('repProjDropdown').value;
            const pname = document.getElementById('repProjDropdown').options[document.getElementById('repProjDropdown').selectedIndex].text;
            const expSnap = await getDocs(collection(db, `projects/${pid}/expenses`));
            let items = [];
            expSnap.forEach(d => items.push({ desc: d.data().description, amt: d.data().amount }));
            document.getElementById('reportRows').innerHTML = "";
            items.forEach(i => addRow(i.desc, i.amt));
            document.getElementById('overlayPrintTitle').innerText = `Project Cost: ${pname}`;
        };

        function updatePrintPreview() {
            const rows = document.querySelectorAll('#reportRows tr');
            let html = '<table style="width:100%; border-collapse: collapse; margin-top: 20px;"><thead><tr style="border-bottom: 2px solid black;"><th style="text-align:left; padding:8px;">Description</th><th style="text-align:right; padding:8px;">Amount (Rs)</th></tr></thead><tbody>';
            let total = 0;
            rows.forEach(r => {
                const inputs = r.querySelectorAll('input');
                const val = parseFloat(inputs[1].value) || 0;
                total += val;
                html += `<tr><td style="padding:8px; border-bottom:1px solid #ddd;">${inputs[0].value}</td><td style="text-align:right; padding:8px; border-bottom:1px solid #ddd;">${val.toLocaleString()}</td></tr>`;
            });
            html += `<tr style="font-weight:bold; font-size:1.2em;"><td style="padding:15px 8px; text-align:right;">TOTAL</td><td style="padding:15px 8px; text-align:right;">Rs. ${total.toLocaleString()}</td></tr></tbody></table>`;
            document.getElementById('overlayPrintContent').innerHTML = html;
        }
        document.getElementById('reportRows').addEventListener('input', updatePrintPreview);

        // --- SAVE REPORT LOGIC ---
        window.saveCurrentReport = async () => {
            const rows = document.querySelectorAll('#reportRows tr');
            const items = [];
            let total = 0;
            rows.forEach(r => {
                const inputs = r.querySelectorAll('input');
                const val = parseFloat(inputs[1].value) || 0;
                items.push({ description: inputs[0].value, amount: val });
                total += val;
            });
            
            const title = document.getElementById('overlayPrintTitle').innerText;
            
            try {
                await addDoc(collection(db, "saved_reports"), {
                    type: currentReportType,
                    title: title,
                    date: new Date().toLocaleDateString(),
                    timestamp: serverTimestamp(),
                    items: items,
                    total: total
                });
                alert("Report saved to history successfully!");
                loadSavedReports(); // Refresh list
            } catch (e) {
                console.error(e);
                alert("Error saving report.");
            }
        };

        function loadSavedReports() {
            const container = document.getElementById('savedReportsList');
            if(!container) return;
            container.innerHTML = "<p>Loading...</p>";
            
            onSnapshot(query(collection(db, "saved_reports"), orderBy("timestamp", "desc")), (snap) => {
                container.innerHTML = "";
                if(snap.empty) { container.innerHTML = "<p class='text-gray-400'>No saved reports.</p>"; return; }
                
                snap.forEach(d => {
                    const r = d.data();
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center";
                    el.innerHTML = `
                        <div>
                            <h4 class="font-bold text-slate-800">${r.title}</h4>
                            <p class="text-xs text-gray-500">${r.date}</p>
                            <p class="text-sm font-bold text-blue-600 mt-1">Total: Rs. ${r.total.toLocaleString()}</p>
                        </div>
                        <button onclick="viewSavedReport('${d.id}')" class="text-slate-800 hover:text-blue-600"><i class="fas fa-eye"></i></button>
                    `;
                    // Storing data in element to avoid re-fetching for viewing
                    el.dataset.report = JSON.stringify(r);
                    container.appendChild(el);
                });
            });
        }

        window.viewSavedReport = async (id) => {
            // Find the report data from the already loaded list (optimization)
            // Or fetch single doc if preferred. Since we have realtime listener, finding in DOM or array is easier.
            // Let's just fetch doc for reliability in this snippet
            const docSnap = await getDoc(doc(db, "saved_reports", id));
            if(!docSnap.exists()) return;
            const r = docSnap.data();
            
            // Open Gen Area
            document.getElementById('reportGenArea').classList.remove('hidden');
            document.getElementById('reportInputTable').classList.remove('hidden');
            document.getElementById('reportProjectSelect').classList.add('hidden'); // Hide project selector for saved ones
            
            document.getElementById('reportTitle').innerText = "View: " + r.title;
            document.getElementById('overlayPrintTitle').innerText = r.title;
            document.getElementById('overlayPrintDate').innerText = "Date: " + r.date;
            
            document.getElementById('reportRows').innerHTML = "";
            r.items.forEach(i => addRow(i.description, i.amount));
        };

        window.downloadPDF = async () => {
            const overlay = document.getElementById('pdfPreviewOverlay');
            overlay.style.display = 'block'; 
            const element = overlay.querySelector('.print-container'); 
            const opt = {
                margin: 10,
                filename: 'Report_' + new Date().toISOString().split('T')[0] + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            try { await html2pdf().set(opt).from(element).save(); } catch (err) { console.error(err); alert("Error"); } 
            finally { setTimeout(() => { overlay.style.display = 'none'; }, 1000); }
        };

    </script>
</body>
</html>

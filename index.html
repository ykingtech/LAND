<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sithuliya Admin Pro - Ultimate Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .luxury-font { font-family: 'Playfair Display', serif; }
        .glass-dark { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #pdfPreviewOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #525659; z-index: 10000; overflow-y: auto; display: none;
        }
        .pdf-container-flex { display: flex; justify-content: center; padding: 40px 0; background: #525659; min-height: 100%; }
        /* Adjusted for A4 alignment */
        .print-paper { 
            width: 210mm; min-height: 297mm; background: white; padding: 15mm; 
            color: black; font-family: 'Times New Roman', serif; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); box-sizing: border-box; margin: 0 auto; 
        }
        @media (max-width: 768px) { .print-paper { width: 95%; padding: 10mm; zoom: 0.6; } }
        
        .receipt-box { border: 2px solid #333; padding: 20px; position: relative; }
        .receipt-header { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; text-align: center; }
        .receipt-title { font-size: 24px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .receipt-label { font-weight: bold; color: #555; }
        .receipt-value { font-weight: bold; color: #000; }
        .receipt-footer { margin-top: 40px; display: flex; justify-content: space-between; text-align: center; font-size: 12px; }
        .sign-line { border-top: 1px dotted #000; width: 150px; margin-top: 40px; padding-top: 5px; }

        .report-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; margin-bottom: 15px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 4px 8px; vertical-align: middle; }
        .report-table th { background-color: #f0f0f0; text-align: left; font-weight: bold; }
        .report-header-bg { background-color: #e0e0e0; font-weight: bold; text-transform: uppercase; padding: 5px; border: 1px solid #000; font-size: 13px; margin-top: 15px; }
        
        .modal-content-scroll { max-height: 85vh; overflow-y: auto; }
        .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 100%; overflow: auto; border: 1px solid #ddd; z-index: 50; max-height: 150px; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dropdown-content div { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; }
        .dropdown-content div:hover {background-color: #f3f4f6;}
        .show {display: block;}
        
        .prose h3 { font-weight: bold; margin-top: 1em; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; }

        /* Custom Input for Data Modal to show numbers clearly */
        .input-number-clear {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #1e3a8a;
        }
        
        /* New Styles for Excel-like Form */
        .excel-like-row { display: flex; border-bottom: 1px solid #e5e7eb; padding: 4px 0; align-items: center; }
        .excel-like-label { width: 200px; flex-shrink: 0; font-size: 12px; font-weight: bold; color: #374151; padding-right: 10px; }
        .excel-like-input { flex-grow: 1; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; }
        .excel-like-input:focus { outline: none; border-color: #2563eb; ring: 1px; }
        .excel-section-header { background-color: #f3f4f6; padding: 8px; font-weight: bold; font-size: 13px; color: #111827; border-top: 2px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; margin-top: 15px; text-transform: uppercase; }
        .excel-sub-row { margin-left: 20px; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">

    <div id="pdfPreviewOverlay">
        <div class="sticky top-0 w-full bg-slate-800 p-4 flex justify-between items-center z-50 shadow-md">
            <h2 class="text-white font-bold">Document Preview</h2>
            <div class="flex gap-4">
                <button onclick="document.getElementById('pdfPreviewOverlay').style.display='none'" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow font-bold text-sm">Close</button>
                <button onclick="downloadPDFActual()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow font-bold text-sm"><i class="fas fa-download mr-2"></i> Download PDF</button>
            </div>
        </div>
        <div class="pdf-container-flex">
            <div id="printContainer" class="print-paper"></div>
        </div>
    </div>
    
    <div id="aiAnalysisModal" class="hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl relative modal-content-scroll max-h-[85vh]">
            <button onclick="document.getElementById('aiAnalysisModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold text-blue-900 mb-4 flex items-center"><i class="fas fa-robot mr-2 text-purple-600"></i> AI Project Analyst</h2>
            <div id="aiLoading" class="text-center py-10">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500 animate-pulse">Analyzing financial data...</p>
            </div>
            <div id="aiContent" class="hidden prose text-sm text-slate-700"></div>
        </div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 cursor-pointer backdrop-blur-sm" onclick="closeImgModal()">
        <img id="imgModalSrc" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl border border-gray-600">
    </div>

    <div id="staffAccessModal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm mx-4 shadow-2xl text-center">
            <h3 class="text-lg font-bold mb-4 text-slate-800">Staff Access Required</h3>
            <input type="password" id="staffAccessInput" placeholder="Enter Access Code" class="w-full p-3 border rounded-lg mb-4 text-center bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex gap-2">
                <button onclick="document.getElementById('staffAccessModal').classList.add('hidden')" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-600 font-bold">Cancel</button>
                <button onclick="verifyStaffAccess()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold shadow hover:bg-blue-700">Access</button>
            </div>
        </div>
    </div>
    
    <div id="sellModal" class="hidden fixed inset-0 z-50 bg-black/70 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-xl text-slate-800">New Booking: <span id="sellBlockName" class="text-blue-600"></span></h3>
                <button onclick="closeSellModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Customer Details</h4>
                    <input type="text" id="cusNIC" placeholder="NIC Number" class="w-full p-3 border rounded-lg mb-3 bg-gray-50">
                    <input type="text" id="cusName" placeholder="Full Name" class="w-full p-3 border rounded-lg mb-3 bg-gray-50">
                    <input type="text" id="cusPhone" placeholder="Phone Number" class="w-full p-3 border rounded-lg mb-3 bg-gray-50">
                    <textarea id="cusAddress" placeholder="Address" class="w-full p-3 border rounded-lg mb-3 bg-gray-50" rows="2"></textarea>
                    
                    <div class="relative">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Sales Person (for 0.75% Comm)</label>
                        <input type="text" placeholder="Select Staff..." id="salesPersonInput" onkeyup="filterSalesFunction()" onclick="toggleSalesDropdown()" class="w-full p-3 border rounded-lg bg-white">
                        <div id="salesDropdown" class="dropdown-content"></div>
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                    <h4 class="text-sm font-bold text-blue-800 uppercase tracking-widest mb-4">Payment Structure</h4>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Final Agreed Price</label>
                        <input type="number" id="finalPrice" class="w-full p-3 border-2 border-blue-200 rounded-lg text-lg font-bold text-blue-900" oninput="calculateEP()">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Plan Type</label>
                        <select id="payPlanType" class="w-full p-3 border rounded-lg font-bold" onchange="toggleEPFields()">
                            <option value="Cash">Cash Sale (Full)</option>
                            <option value="EP">Easy Payment (Installment)</option>
                        </select>
                    </div>

                    <div id="cashFields">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Advance Payment</label>
                        <input type="number" id="cashAdvancePay" class="w-full p-3 border rounded-lg font-bold text-green-700">
                    </div>

                    <div id="epFields" class="hidden space-y-3">
                        <div class="flex gap-2">
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Down Payment %</label><input type="number" id="downPayPct" value="40" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div>
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Amount</label><input type="number" id="downPayAmount" class="w-full p-2 border rounded bg-gray-200 font-bold" readonly></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-gray-500 uppercase">Initial Booking Fee</label><input type="number" id="bookingFee" class="w-full p-2 border rounded font-bold text-blue-700" oninput="calculateEP()"></div>
                        <div class="text-xs text-red-500 font-bold text-right">Balance DP: <span id="downPayBalanceDisp">0.00</span></div>
                        
                        <div class="border-t border-blue-200 my-2 pt-2"></div>
                        <div class="flex gap-2">
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Interest Rate %</label><input type="number" id="epRate" value="15" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div>
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Months</label><input type="number" id="epMonths" value="60" class="w-full p-2 border rounded text-center" oninput="calculateEP()"></div>
                            <div class="flex-1"><label class="text-[10px] font-bold text-gray-500 uppercase">Cycle (Days)</label><input type="number" id="epCycle" value="30" class="w-full p-2 border rounded text-center"></div>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <div class="flex justify-between text-xs mb-1"><span>Loan Amount:</span><input id="loanAmount" class="text-right font-bold w-24 border-none" readonly></div>
                            <div class="flex justify-between text-xs mb-1"><span>Total Payable (Reducing Bal):</span><span id="epTotalPayable" class="font-bold">0.00</span></div>
                            <div class="flex justify-between text-sm font-bold text-blue-800 mt-2"><span>Monthly (EMI):</span><span id="epMonthlyInst">0.00</span></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-2 gap-2">
                        <div><label class="text-[10px] font-bold text-gray-500">Plan Fee</label><input type="number" id="planFee" class="w-full p-2 border rounded text-xs"></div>
                        <div><label class="text-[10px] font-bold text-gray-500">Deed Fee</label><input type="number" id="deedFee" class="w-full p-2 border rounded text-xs"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="processSale(false)" class="px-6 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 shadow">Complete Sale</button>
                <button onclick="processSale(true)" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow"><i class="fas fa-print mr-2"></i> Save & Print</button>
            </div>
        </div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1600596542815-2a429b08e695?q=80&w=2070&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-blue-900/60"></div>
        <div class="relative z-10 glass-dark p-10 rounded-3xl shadow-2xl w-11/12 max-w-md text-center border border-blue-400/30">
            <div class="mb-8">
                <div class="flex justify-center mb-4">
                    <img src="ico.jpeg" class="w-32 h-32 rounded-full border-4 border-blue-500 shadow-xl object-cover" onerror="this.src='https://via.placeholder.com/150'">
                </div>
                <h1 class="text-4xl text-white luxury-font tracking-wide">Sithuliya</h1>
                <p class="text-blue-300 text-xs uppercase tracking-[0.4em] mt-2">Exclusive Real Estate</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="loginPass" class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-300 focus:outline-none focus:border-blue-500 text-center tracking-widest transition" placeholder="Password">
                <button onclick="attemptLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-105">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden flex h-full">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-slate-900 text-white shadow-2xl flex flex-col z-40 fixed md:relative h-full transition-transform transform -translate-x-full md:translate-x-0">
            <div class="p-6 border-b border-slate-800 flex flex-col items-center relative">
                <button onclick="toggleSidebar()" class="absolute top-4 right-4 md:hidden text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <img src="ico.jpeg" class="w-16 h-16 rounded-full border-2 border-blue-500 mb-3 object-cover shadow-lg" onerror="this.src='https://via.placeholder.com/150'">
                <h2 class="text-2xl luxury-font text-blue-400">Sithuliya <span class="text-[10px] font-sans text-slate-500 block tracking-widest mt-1 text-center">ADMIN CONSOLE</span></h2>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="nav('projects')" id="nav-projects" class="nav-btn w-full text-left p-3 rounded-xl bg-blue-900/50 text-blue-400 font-bold border border-blue-800"><i class="fas fa-map-marked-alt mr-3"></i> Projects</button>
                <button onclick="nav('lands')" id="nav-lands" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tree mr-3"></i> Lands</button>
                <button onclick="openStaffAccess()" id="nav-staff" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-users mr-3"></i> Staff</button>
                <button onclick="nav('readings')" id="nav-readings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tachometer-alt mr-3"></i> Meter Approvals</button>
                <button onclick="nav('reports')" id="nav-reports" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-file-invoice-dollar mr-3"></i> Financial Center</button>
                <div class="pt-8 border-t border-slate-800 mt-8">
                    <button onclick="nav('settings')" id="nav-settings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-cog mr-3"></i> Settings</button>
                </div>
            </nav>
        </div>

        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 px-4 md:px-8 border-b border-blue-100">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-800 text-xl mr-4"><i class="fas fa-bars"></i></button>
                
                <!-- FIXED SEARCH BAR -->
                <div class="relative w-full max-w-sm group">
                    <input type="text" id="projSearch" placeholder="Search Projects / Customers..." class="w-full pl-10 pr-4 py-2 border-none bg-blue-50 rounded-full focus:ring-2 focus:ring-blue-500 transition text-sm group-hover:bg-blue-100 text-blue-900" onkeyup="handleGlobalSearch()" onfocus="handleGlobalSearch()">
                    <i class="fas fa-search absolute left-4 top-2.5 text-blue-400"></i>
                    <div id="searchResults" class="hidden absolute top-12 left-0 w-full bg-white shadow-2xl rounded-xl border border-blue-100 max-h-96 overflow-y-auto z-50"></div>
                </div>
                
                <div class="flex items-center gap-4 md:gap-6 ml-4">
                    <div class="relative cursor-pointer" onclick="toggleNotifPanel()">
                        <div class="relative">
                            <i id="bellIcon" class="fas fa-bell text-gray-400 text-xl hover:text-blue-800 transition"></i>
                            <span id="notifBadge" class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">0</span>
                        </div>
                    </div>
                    <button onclick="openNewProjectModal()" class="bg-blue-900 text-white px-3 md:px-5 py-2 rounded-full hover:bg-blue-800 shadow-lg shadow-blue-900/20 text-xs md:text-sm font-bold transition transform hover:scale-105 whitespace-nowrap"><i class="fas fa-plus mr-1 md:mr-2"></i> <span class="hidden md:inline">New Project</span><span class="md:hidden">New</span></button>
                </div>
            </header>

            <div id="notifPanel" class="hidden absolute top-20 right-4 md:right-8 w-80 md:w-96 bg-white shadow-2xl rounded-xl border border-gray-100 z-50 overflow-hidden animate-fade-in-down">
                <div class="bg-slate-900 p-3 text-white text-sm font-bold flex justify-between items-center">
                    <span><i class="fas fa-exclamation-circle mr-2"></i>Notifications</span>
                    <button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
                </div>
                <div id="notifList" class="max-h-80 overflow-y-auto bg-gray-50"></div>
            </div>

            <main class="flex-1 overflow-auto p-4 md:p-8" id="mainScrollContainer">
                <div id="page-projects">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Active Developments</h2>
                        <div class="flex bg-gray-200 rounded-lg p-1">
                             <button onclick="toggleProjectView('active')" id="btn-view-active" class="px-4 py-1 rounded-md text-sm font-bold bg-white shadow text-slate-800">Active</button>
                             <button onclick="toggleProjectView('closed')" id="btn-view-closed" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-slate-800">Closed</button>
                        </div>
                    </div>
                    <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="closedProjectList" class="hidden space-y-4"></div>
                </div>

                <div id="page-lands" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Land Acquisition</h2>
                        <button onclick="document.getElementById('newLandModal').classList.remove('hidden')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 text-sm md:text-base"><i class="fas fa-plus mr-2"></i> Add New Land</button>
                    </div>
                    <div id="landsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                </div>

                <div id="page-staff" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Staff Management</h2>
                        <div class="flex flex-col md:flex-row gap-4 items-center w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <input type="text" id="staffSearchInput" onkeyup="filterStaffGrid()" placeholder="Search Staff..." class="w-full pl-8 pr-4 py-2 border rounded-full text-sm focus:ring-blue-500 bg-white">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="document.getElementById('staffPassChangeModal').classList.remove('hidden')" class="flex-1 md:flex-none bg-yellow-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-yellow-600 text-xs">Password</button>
                                <button onclick="document.getElementById('newStaffModal').classList.remove('hidden'); document.getElementById('staffMode').value='new'; document.getElementById('newStaffBtnText').innerText='Save Member';" class="flex-1 md:flex-none bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 text-xs"><i class="fas fa-user-plus mr-2"></i> Add Staff</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col xl:flex-row gap-6">
                        <div id="staffGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1"></div>
                        <div class="w-full xl:w-80 bg-white border border-blue-100 rounded-xl shadow-sm p-4 h-fit">
                            <h3 class="font-bold text-blue-900 mb-3 border-b pb-2 flex justify-between items-center">
                                <span><i class="fas fa-piggy-bank mr-2"></i>Staff Welfare (0.25%)</span>
                            </h3>
                            <div id="staffPoolList" class="max-h-[500px] overflow-y-auto space-y-2 text-xs"></div>
                            <div class="border-t mt-3 pt-2 flex justify-between font-bold text-sm">
                                <span>Total Pool:</span>
                                <span class="text-green-600" id="staffPoolTotal">Rs. 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-detail" class="hidden pb-20">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
                        <div>
                            <button onclick="nav('projects')" class="text-gray-400 hover:text-blue-800 mb-2 font-bold text-xs uppercase tracking-wide"><i class="fas fa-arrow-left mr-2"></i> Back to Dashboard</button>
                            <h1 id="detailName" class="text-3xl md:text-4xl font-bold text-blue-900 luxury-font">Project Name</h1>
                            <p class="text-gray-500 flex items-center mt-1 text-sm"><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> <span id="detailArea">Area</span> | <span id="detailLandName" class="ml-2 font-bold text-slate-800"></span></p>
                        </div>
                        <div class="flex flex-col items-end gap-2 w-full md:w-auto">
                            <span id="detailStatus" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-blue-100 text-blue-800 border border-blue-200">Development</span>
                            <div class="flex gap-2 flex-wrap justify-end">
                                <button onclick="openReportDataModal()" class="text-xs bg-slate-100 text-slate-700 px-3 py-1 rounded font-bold border hover:bg-slate-200"><i class="fas fa-edit mr-1"></i> Data</button>
                                <button onclick="generateProjectMasterReport()" class="text-xs bg-slate-800 text-white px-3 py-1 rounded font-bold hover:bg-slate-900"><i class="fas fa-print mr-1"></i> Report</button>
                                <button id="endDevBtn" onclick="endDevelopmentPhase()" class="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200 font-bold">End Dev</button>
                                <button id="closeProjBtn" onclick="closeProject()" class="hidden text-xs bg-red-600 text-white px-3 py-1 rounded shadow hover:bg-red-700 font-bold"><i class="fas fa-lock mr-1"></i> Close</button>
                                <button id="deleteProjBtn" onclick="deleteProject()" class="text-xs bg-red-800 text-white px-3 py-1 rounded shadow hover:bg-red-900 font-bold"><i class="fas fa-trash mr-1"></i> Delete</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto hide-scrollbar">
                        <button onclick="subTab('overview')" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 sub-tab whitespace-nowrap" id="st-overview">Overview</button>
                        <button onclick="subTab('tasks')" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 sub-tab whitespace-nowrap" id="st-tasks">Tasks</button>
                        <button onclick="subTab('finance')" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 sub-tab whitespace-nowrap" id="st-finance">Finance</button>
                    </div>

                    <div id="view-overview">
                        <div id="devPhaseUI" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Add Land Blocks</h3>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input type="text" id="blockName" placeholder="No (e.g. A1)" class="p-2 border rounded w-20 text-sm focus:ring-blue-500">
                                    <input type="number" id="blockSize" placeholder="Perches" class="p-2 border rounded w-24 text-sm focus:ring-blue-500" oninput="calcBlockPrice()" onkeyup="calcBlockPrice()">
                                    <input type="number" id="blockPerchPrice" placeholder="Price/Perch" class="p-2 border rounded w-32 text-sm focus:ring-blue-500" oninput="calcBlockPrice()" onkeyup="calcBlockPrice()">
                                    <input type="number" id="blockPrice" placeholder="Total Price" class="p-2 border rounded flex-1 bg-gray-50 font-bold text-slate-700 text-sm" readonly>
                                    <button id="addBlockBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 shadow"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Assigned Vehicles</h3>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="regVehicleNo" placeholder="Vehicle Number (e.g. WP-1234)" class="p-2 border rounded w-full uppercase text-sm focus:ring-blue-500">
                                    <button id="regVehicleBtn" onclick="assignVehicle()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900 shadow">Assign</button>
                                </div>
                                <div id="vehicleList" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-slate-700">Land Blocks Map</h3>
                        <div id="blocksContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>
                    
                    <div id="view-tasks" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Site Operations</h3>
                            <button onclick="document.getElementById('newTaskModal').classList.remove('hidden')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900"><i class="fas fa-plus mr-2"></i> Assign Task</button>
                        </div>
                        <div id="adminTaskList" class="space-y-4"></div>
                    </div>

                    <div id="view-finance" class="hidden">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-8">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                <h3 class="font-bold text-2xl text-slate-800 luxury-font">Profit Analysis</h3>
                                <div class="flex gap-2">
                                    <button onclick="downloadFinancialReport()" class="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-bold border hover:bg-blue-800 transition"><i class="fas fa-file-download mr-2"></i> Report</button>
                                    <button onclick="openExpenseModal()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 transition"><i class="fas fa-receipt mr-2"></i> Add Misc Expense</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="p-6 rounded-xl bg-green-50 border border-green-100">
                                    <p class="text-xs text-green-600 uppercase font-bold tracking-widest mb-2">Revenue (Sold)</p>
                                    <h4 id="finIncome" class="text-3xl font-bold text-green-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-red-50 border border-red-100">
                                    <p class="text-xs text-red-600 uppercase font-bold tracking-widest mb-2">Cost (Exp + Tasks)</p>
                                    <h4 id="finExpense" class="text-3xl font-bold text-red-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-slate-50 border border-slate-200 relative overflow-hidden">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent"></div>
                                    <p class="text-xs text-slate-600 uppercase font-bold tracking-widest mb-2 relative z-10">Net Profit</p>
                                    <h4 id="finProfit" class="text-3xl font-bold text-slate-800 relative z-10">Rs. 0.00</h4>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Expense Ledger</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left bg-white rounded-lg overflow-hidden shadow-sm"><tbody id="expenseList"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="page-readings" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">Meter Approvals</h2>
                    <div id="readingsList" class="space-y-4"></div>
                </div>
                
                 <div id="page-reports" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Financial Center</h2>
                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
                        <button onclick="switchFinTab('entry')" id="ft-entry" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 transition whitespace-nowrap">Data Entry</button>
                        <button onclick="switchFinTab('reports')" id="ft-reports" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 transition whitespace-nowrap">View Reports</button>
                    </div>

                    <div id="fin-view-entry">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-coins text-blue-500 mr-2"></i> Transaction Entry</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="txDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Voucher No</label><input type="text" id="txVno" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Description</label><input type="text" id="txDesc" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="txType" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><option value="Expense">Expense</option><option value="Income">Income</option></select></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Amount</label><input type="number" id="txAmount" class="w-full p-2 border rounded bg-gray-50 font-bold focus:ring-blue-500"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Category</label><select id="txCategory" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><optgroup label="Income"><option value="Sales">Revenue</option><option value="Other Income">Other</option></optgroup><optgroup label="Expenses"><option value="Admin Expense">Admin</option><option value="Petty Cash">Petty Cash</option></optgroup></select></div>
                                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="txIsPetty" class="w-4 h-4 text-blue-500 rounded"><label for="txIsPetty" class="text-sm font-bold text-slate-700">Petty Cash Record</label></div>
                                    <button onclick="saveTransaction()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 mt-4 shadow-lg">SAVE TRANSACTION</button>
                                </div>
                            </div>
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 h-fit">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-balance-scale text-blue-500 mr-2"></i> Balance Sheet Entry</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="bsDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Account</label><input type="text" id="bsName" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="bsType" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><option value="Non-Current Asset">Asset (Fixed)</option><option value="Current Asset">Asset (Current)</option><option value="Equity">Equity</option><option value="Current Liability">Liability</option></select></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Value</label><input type="number" id="bsAmount" class="w-full p-2 border rounded bg-gray-50 font-bold focus:ring-blue-500"></div>
                                    <button onclick="saveBSItem()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 mt-4 shadow-lg">SAVE ITEM</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="fin-view-reports" class="hidden">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-wrap gap-4 items-center mb-6">
                            <input type="date" id="repFrom" class="p-2 border rounded bg-gray-50 text-sm"> <input type="date" id="repTo" class="p-2 border rounded bg-gray-50 text-sm">
                            <button onclick="genReport('daybook')" class="px-4 py-2 bg-slate-100 text-slate-800 rounded text-sm font-bold">Day Book</button>
                            <button onclick="genReport('petty')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Petty Cash</button>
                            <button onclick="genReport('pnl')" class="px-4 py-2 bg-green-50 text-green-700 rounded text-sm font-bold">P & L</button>
                            <button onclick="genReport('bs')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Balance Sheet</button>
                        </div>
                        <div id="reportOutputArea" class="bg-white p-8 rounded-2xl shadow border border-blue-100 min-h-[400px]">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-400 uppercase tracking-widest text-sm">Report Preview</h3><button onclick="triggerPDFDownload()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold">Download PDF</button></div>
                            <div id="reportContent" class="overflow-x-auto border rounded-lg p-4 bg-gray-50 text-sm"><p class="text-center text-gray-400 py-10">Select date range & type.</p></div>
                        </div>
                    </div>
                </div>

                <div id="page-settings" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 max-w-md">
                        <h3 class="font-bold text-lg mb-4 text-blue-600">Change Admin Password</h3>
                        <input type="password" id="newAdminPass" placeholder="New Password" class="w-full p-3 border rounded-lg mb-4 focus:ring-blue-500">
                        <button onclick="updatePassword()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800">Update Password</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- RE-INSERTED MISSING MODALS -->
    <div id="newProjectModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-6 text-slate-800">Create New Project</h2>
            <input type="text" id="newProjName" placeholder="Project Name" class="w-full p-3 border rounded-lg mb-3">
            <input type="text" id="newProjArea" placeholder="Area / Location" class="w-full p-3 border rounded-lg mb-3">
            <label class="block text-xs font-bold text-gray-500 mb-1">Link Parent Land (Asset)</label>
            <select id="landLinkSelect" class="w-full p-3 border rounded-lg mb-6 text-sm"></select>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold">Cancel</button>
                <button onclick="createProject()" class="px-6 py-2 bg-blue-900 text-white rounded-lg font-bold shadow hover:bg-blue-800">Create</button>
            </div>
        </div>
    </div>

    <div id="newLandModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-6 text-slate-800">Acquire Land</h2>
            <input type="text" id="landName" placeholder="Land Name" class="w-full p-3 border rounded-lg mb-3">
            <input type="text" id="landSeller" placeholder="Seller Name" class="w-full p-3 border rounded-lg mb-3">
            <input type="number" id="landCost" placeholder="Total Cost" class="w-full p-3 border rounded-lg mb-3" oninput="calcLandAdvance()">
            <label class="block text-xs font-bold text-gray-500 mb-1">Initial Advance Payment (10%)</label>
            <input type="number" id="landAdvance" class="w-full p-3 border rounded-lg mb-6 font-bold text-slate-800">
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('newLandModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold">Cancel</button>
                <button onclick="saveLand()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700">Acquire</button>
            </div>
        </div>
    </div>

    <!-- STAFF MODAL -->
    <div id="newStaffModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 relative">
            <button onclick="document.getElementById('newStaffModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-6 text-slate-800">Staff Member Details</h2>
            <input type="hidden" id="staffMode" value="new">
            <input type="hidden" id="editStaffId" value="">
            <div class="space-y-3">
                <input type="text" id="staffName" placeholder="Full Name" class="w-full p-3 border rounded-lg">
                <input type="text" id="staffNIC" placeholder="NIC Number" class="w-full p-3 border rounded-lg">
                <input type="text" id="staffPhone" placeholder="Phone Number" class="w-full p-3 border rounded-lg">
                <input type="text" id="staffPosition" placeholder="Position (e.g. Sales Agent)" class="w-full p-3 border rounded-lg">
                <input type="number" id="staffSalary" placeholder="Basic Salary" class="w-full p-3 border rounded-lg">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Profile Photo</label>
                    <input type="file" id="staffPhoto" class="w-full text-sm">
                </div>
            </div>
            <button onclick="saveStaff()" id="newStaffBtnText" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow mt-6 hover:bg-blue-700">Save Member</button>
        </div>
    </div>

    <!-- NEW: STAFF PASSWORD CHANGE MODAL -->
    <div id="staffPassChangeModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative">
            <button onclick="document.getElementById('staffPassChangeModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-slate-800">Change Staff Access PIN</h3>
            <div class="space-y-4">
                <input type="password" id="adminAuthPass" placeholder="Admin Password (To Verify)" class="w-full p-3 border rounded-lg text-center">
                <input type="text" id="newStaffPin" placeholder="New Access PIN" class="w-full p-3 border rounded-lg text-center font-bold text-blue-600">
                <button onclick="updateStaffAccessPass()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg shadow hover:bg-yellow-600">Update PIN</button>
            </div>
        </div>
    </div>

    <!-- NEW: STAFF DETAIL MODAL -->
    <div id="staffDetailModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm p-4 overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl mx-4 relative shadow-2xl my-8">
            <button onclick="document.getElementById('staffDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/3 text-center">
                    <img id="sdPhoto" src="" class="w-24 h-24 rounded-full object-cover mx-auto border-4 border-white shadow-lg bg-gray-200">
                    <h2 id="sdName" class="text-xl font-bold text-slate-800 mt-3"></h2>
                    <p id="sdPosition" class="text-sm font-bold text-blue-500 uppercase tracking-wide"></p>
                    <div class="mt-4 flex flex-col gap-2" id="sdActionBtns"></div>
                </div>
                <div class="w-full md:w-2/3">
                    <div class="bg-gray-50 p-4 rounded-xl space-y-2 text-sm border border-gray-100 mb-4">
                        <div class="flex justify-between"><span class="text-gray-500">NIC</span><span id="sdNIC" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Phone</span><span id="sdPhone" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Salary</span><span id="sdSalary" class="font-bold text-green-600"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Joined</span><span id="sdJoined" class="font-bold"></span></div>
                    </div>
                    <h4 class="font-bold text-sm text-slate-700 mb-2">Earnings History</h4>
                    <div class="h-48 overflow-y-auto border rounded-lg p-2 bg-slate-50 text-xs">
                        <table class="w-full text-left">
                            <tbody id="sdEarningsList"></tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-right text-sm font-bold">Total Earnings: <span id="sdTotalEarnings" class="text-green-600">Rs. 0.00</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="newTaskModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="font-bold text-lg mb-4">Assign Site Task</h3>
            <input type="text" id="newTaskTitle" placeholder="Task Title" class="w-full p-2 border rounded mb-2">
            <textarea id="newTaskDesc" placeholder="Description" class="w-full p-2 border rounded mb-2"></textarea>
            <input type="file" id="taskPhoto" class="w-full text-xs mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('newTaskModal').classList.add('hidden')" class="px-3 py-1 text-gray-500">Cancel</button>
                <button id="saveTaskBtn" class="px-4 py-1 bg-slate-800 text-white rounded font-bold">Assign</button>
            </div>
        </div>
    </div>

    <div id="expenseModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="font-bold text-lg mb-4 text-red-600">Add Miscellaneous Expense</h3>
            <input type="text" id="expDesc" placeholder="Description" class="w-full p-2 border rounded mb-2">
            <input type="number" id="expAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('expenseModal').classList.add('hidden')" class="px-3 py-1 text-gray-500">Cancel</button>
                <button id="saveExpenseBtn" class="px-4 py-1 bg-red-600 text-white rounded font-bold">Save</button>
            </div>
        </div>
    </div>

    <div id="landPaymentModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="font-bold text-lg mb-2">Land Payment</h3>
            <p id="landPayInfo" class="text-xs text-gray-500 mb-4"></p>
            <input type="date" id="landPayDate" class="w-full p-2 border rounded mb-2">
            <input type="number" id="landPayAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4">
            <button onclick="submitLandPayment()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Submit Payment</button>
            <button onclick="document.getElementById('landPaymentModal').classList.add('hidden')" class="w-full mt-2 text-gray-500 text-xs">Cancel</button>
        </div>
    </div>
    
    <div id="paymentModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl mx-4 my-10 shadow-2xl relative modal-content-scroll">
            <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="flex justify-between items-start mb-4 border-b pb-4">
                <div><h2 class="text-2xl font-bold text-slate-800">Payment Record</h2><p id="payBlockInfo" class="text-blue-700 font-bold text-sm"></p></div>
                <div class="flex flex-col items-end gap-1"><button id="editPlanBtn" class="text-xs text-blue-600 underline font-bold" onclick="toggleEditPlan()">Edit Interest/Plan</button><button id="resellBtn" class="hidden text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200" onclick="processResell()">CANCEL & RESELL</button></div>
            </div>
            
            <!-- ADDED MISSING SECTION -->
            <div id="editPlanSection" class="hidden bg-gray-100 p-4 rounded-xl mb-4 border border-gray-200">
                <h4 class="font-bold text-xs text-gray-500 uppercase mb-2">Edit Payment Plan</h4>
                <div class="flex gap-2 mb-2">
                    <input type="number" id="editNewRate" placeholder="New Rate %" class="w-1/2 p-2 border rounded text-sm">
                    <input type="number" id="editNewMonths" placeholder="New Months" class="w-1/2 p-2 border rounded text-sm">
                </div>
                <button id="savePlanChangesBtn" class="w-full bg-blue-600 text-white font-bold py-2 rounded text-sm hover:bg-blue-700">Save Changes</button>
            </div>
            
            <div id="epCycleSection" class="hidden mb-6">
                <div class="flex justify-between items-end mb-1">
                    <span id="cycleStatusLabel" class="text-[10px] font-bold uppercase tracking-wider text-blue-600">Cycle Progress</span>
                    <span id="cycleDaysLeft" class="text-[10px] font-bold text-gray-500"></span>
                </div>
                <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden relative">
                    <div id="cycleProgressBar" class="h-full progress-bar-fill bg-blue-500" style="width: 0%"></div>
                </div>
                
                 <div id="epPreStageInfo" class="mt-4 grid grid-cols-2 gap-4 text-xs bg-yellow-50 p-3 rounded border border-yellow-200">
                     <div>
                         <span class="block font-bold text-gray-500">DOWN PAYMENT (40%)</span>
                         <span id="epDpTarget" class="font-bold text-slate-800"></span>
                     </div>
                     <div class="text-right">
                         <span class="block font-bold text-gray-500">PAID SO FAR</span>
                         <span id="epDpPaid" class="font-bold text-green-600"></span>
                     </div>
                     <div class="col-span-2 border-t border-yellow-200 pt-1 text-center font-bold text-red-600" id="epDpDueMsg"></div>
                 </div>

                <div id="epInstallmentInfo" class="hidden mt-4">
                     <div class="flex gap-2">
                         <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase block">Current Rate</span><span id="dispRate" class="text-xs font-bold text-blue-700"></span></div>
                         <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase block">Plan Period</span><span id="dispMonths" class="text-xs font-bold text-blue-700"></span></div>
                    </div>
                    <div class="mt-3 bg-indigo-50 p-4 rounded-lg border border-indigo-100 text-center">
                        <p class="text-[10px] font-bold text-indigo-400 uppercase mb-2">This Month Breakdown</p>
                        <div class="flex justify-between items-center text-xs mb-1">
                            <span class="text-gray-500">Capital:</span>
                            <span id="epThisMonthCapital" class="font-bold text-slate-700">Rs. 0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-xs mb-2 pb-2 border-b border-indigo-200">
                            <span class="text-gray-500">Interest:</span>
                            <span id="epThisMonthInterest" class="font-bold text-slate-700">Rs. 0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-indigo-900 uppercase">Total Due:</span>
                            <span id="epNextDueAmt" class="text-xl font-bold text-indigo-700">Rs. 0.00</span>
                        </div>
                    </div>
                    <!-- Future Balance: Total Payable - Paid Amount -->
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500 border-t pt-2">
                        <span class="font-bold text-red-500 uppercase">Settlement Balance (Today):</span>
                        <span id="epRealtimeFuture" class="font-bold text-red-600 text-sm"></span>
                    </div>
                </div>
            </div>

            <div id="cusDetailsSection" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4 text-sm">
                <h4 class="font-bold text-gray-400 text-xs uppercase mb-2">Customer Details</h4>
                <div class="grid grid-cols-2 gap-2">
                    <p><i class="fas fa-id-badge mr-2 text-blue-500"></i> <span id="viewCusId" class="font-bold text-slate-800"></span></p>
                    <p><i class="fas fa-id-card mr-2 text-gray-400"></i> <span id="viewCusNIC" class="font-medium"></span></p>
                    <p><i class="fas fa-phone mr-2 text-gray-400"></i> <span id="viewCusPhone" class="font-medium"></span></p>
                    <p class="col-span-2"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> <span id="viewCusAddr" class="font-medium text-gray-600"></span></p>
                </div>
            </div>
            
             <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-3 bg-slate-100 rounded-lg"><p class="text-[10px] uppercase font-bold text-gray-500">Payable</p><p id="pmTotal" class="font-bold text-slate-800 text-lg">0.00</p></div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-100"><p class="text-[10px] uppercase font-bold text-green-600">Paid</p><p id="pmPaid" class="font-bold text-green-700 text-lg">0.00</p></div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Balance</p><p id="pmBalance" class="font-bold text-red-700 text-lg">0.00</p></div>
            </div>

            <div id="addPaymentSection" class="bg-slate-50 p-4 rounded-xl mb-6 border border-gray-200">
                <div class="flex gap-3 mb-2"><input type="date" id="newPayDate" class="w-1/3 p-2 border rounded text-sm"><input type="number" id="newPayAmount" placeholder="Amount" class="w-1/3 p-2 border rounded text-sm font-bold text-slate-800"><button id="submitPayBtn" class="w-1/3 bg-green-600 text-white rounded font-bold text-sm shadow hover:bg-green-700">ADD PAYMENT</button></div>
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="downloadPaymentReceipt()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300 font-bold"><i class="fas fa-receipt mr-1"></i> Receipt</button>
                    <button onclick="downloadPaymentHistory()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300 font-bold"><i class="fas fa-history mr-1"></i> Report</button>
                </div>
            </div>
            <div id="paymentCompleteMsg" class="hidden bg-green-100 text-green-800 p-4 rounded-xl text-center font-bold mb-6 border border-green-200"><i class="fas fa-check-circle mr-2"></i> FULLY PAID & CLOSED</div>
            <h3 class="font-bold text-xs text-gray-400 uppercase mb-2">History</h3>
            <div class="overflow-y-auto max-h-40 border rounded-lg"><table class="w-full text-xs text-left"><tbody id="paymentHistoryList" class="divide-y"></tbody></table></div>
        </div>
    </div>
    
    <div id="taskApproveModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]"><div class="p-6 border-b flex justify-between items-center bg-gray-50"><h2 class="text-xl font-bold text-slate-800" id="taskModalHeader">Review</h2><button onclick="document.getElementById('taskApproveModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button></div><div class="p-6 overflow-y-auto flex-1"><h3 id="approveTaskTitle" class="text-2xl font-bold text-slate-800 mb-2"></h3><p class="text-lg mb-4">Cost: <span id="approveTaskCost" class="font-bold text-green-600 text-2xl"></span></p><p class="text-sm mb-4 bg-yellow-50 p-2 rounded border border-yellow-200" id="approveTaskTimeInfo"></p><div id="approveTaskPhotos" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div><div class="p-6 border-t bg-gray-50 flex justify-end"><button id="confirmApproveTaskBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700">APPROVE</button></div></div></div>

    <div id="newProjectReportDataModal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-xl font-bold text-slate-800"><i class="fas fa-file-invoice mr-2 text-blue-600"></i>Project Budget & Cash Flow</h2>
                <button onclick="document.getElementById('newProjectReportDataModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 bg-white">
                <!-- EXCEL LIKE FORM -->
                <div class="max-w-4xl mx-auto">
                    
                    <div class="excel-section-header">Project Overview</div>
                    <div class="excel-like-row"><div class="excel-like-label">Project Name</div><input id="rpt_name" class="excel-like-input bg-gray-100" readonly></div>
                    <div class="excel-like-row"><div class="excel-like-label">Owner</div><input id="rpt_owner" class="excel-like-input"></div>
                    <div class="excel-like-row"><div class="excel-like-label">Location of Land</div><input id="rpt_location" class="excel-like-input bg-gray-100" readonly></div>
                    <div class="excel-like-row"><div class="excel-like-label">Introducer</div><input id="rpt_introducer" class="excel-like-input"></div>
                    
                    <div class="excel-section-header">Land Extent & Allocation</div>
                    <div class="excel-like-row">
                        <div class="excel-like-label">Total Extent</div>
                        <div class="flex gap-2 flex-grow">
                            <input type="number" id="rpt_acres" placeholder="A" class="excel-like-input text-center" oninput="calcReportTotals()">
                            <input type="number" id="rpt_roods" placeholder="R" class="excel-like-input text-center" oninput="calcReportTotals()">
                            <input type="number" id="rpt_perches" placeholder="P" class="excel-like-input text-center" oninput="calcReportTotals()">
                        </div>
                    </div>
                    <div class="excel-like-row"><div class="excel-like-label">Total Perches</div><input id="rpt_tot_perches" class="excel-like-input bg-gray-100 font-bold text-right" readonly></div>
                    <div class="excel-like-row"><div class="excel-like-label">Road Allocation (P)</div><input type="number" id="rpt_road_p" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row"><div class="excel-like-label">Reservation (P)</div><input type="number" id="rpt_res_p" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row"><div class="excel-like-label text-blue-600">Sellable Area (P)</div><input id="rpt_sell_p" class="excel-like-input bg-blue-50 font-bold text-right" readonly></div>
                    
                    <div class="excel-section-header">Cost of Purchase</div>
                    <div class="excel-like-row"><div class="excel-like-label">Purchase Price</div><input type="number" id="rpt_purchase_price" class="excel-like-input font-bold text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Title Insurance</div><input type="number" id="rpt_title_ins" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Stamp Duty (4%)</div><input type="number" id="rpt_stamp" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Legal Fees</div><input type="number" id="rpt_legal" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Introducer Comm.</div><input type="number" id="rpt_intro_comm" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Valuation</div><input type="number" id="rpt_valuation" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row"><div class="excel-like-label font-bold">Total Purchase Cost</div><input id="rpt_tot_purchase" class="excel-like-input bg-gray-200 font-bold text-right" readonly></div>

                    <div class="excel-section-header">Survey Charges</div>
                    <div id="surveyRowsContainer"></div> 
                    <div class="excel-like-row"><div class="excel-like-label font-bold">Total Survey Cost</div><input id="rpt_tot_survey" class="excel-like-input bg-gray-200 font-bold text-right" readonly></div>

                    <div class="excel-section-header">Development Cost</div>
                    <div id="devRowsContainer"></div>
                    <button onclick="addNewDevRow()" class="text-xs text-blue-600 hover:underline mt-1 mb-2 ml-4">+ Add Development Item</button>
                    <div class="excel-like-row"><div class="excel-like-label font-bold">Total Development</div><input id="rpt_tot_dev" class="excel-like-input bg-gray-200 font-bold text-right" readonly></div>

                    <div class="excel-section-header">Other Expenses</div>
                    <div class="excel-like-row"><div class="excel-like-label">Advertising</div><input type="number" id="rpt_ad_cost" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row"><div class="excel-like-label">1% Tax & Approvals</div><input type="number" id="rpt_tax_1pct" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    <div class="excel-like-row"><div class="excel-like-label">Cost of Capital</div><input type="number" id="rpt_cost_capital" class="excel-like-input text-right" oninput="calcReportTotals()"></div>
                    
                    <div class="excel-section-header bg-yellow-100 border-yellow-200">VAT Calculation</div>
                    <div class="excel-like-row"><div class="excel-like-label">Sales Proceeds</div><input type="number" id="rpt_vat_sales" class="excel-like-input font-bold text-right" oninput="calcVAT()"></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Less: Purchase Cost</div><input id="rpt_vat_less_pur" class="excel-like-input bg-gray-100 text-right text-red-600" readonly></div>
                    <div class="excel-like-row excel-sub-row"><div class="excel-like-label">Less: Dev Cost</div><input id="rpt_vat_less_dev" class="excel-like-input bg-gray-100 text-right text-red-600" readonly></div>
                    <div class="excel-like-row"><div class="excel-like-label font-bold">Value Addition</div><input id="rpt_vat_val_add" class="excel-like-input bg-yellow-50 font-bold text-right" readonly></div>
                    <div class="excel-like-row"><div class="excel-like-label">VAT Rate %</div><input type="number" id="rpt_vat_rate" value="18" class="excel-like-input text-center w-20" oninput="calcVAT()"></div>
                    <div class="excel-like-row"><div class="excel-like-label font-bold text-red-600">VAT Payable</div><input id="rpt_vat_payable" class="excel-like-input bg-red-50 font-bold text-right text-red-600" readonly></div>

                    <div class="mt-6 p-4 bg-gray-800 text-white rounded text-center">
                        <h3 class="text-xl font-bold">TOTAL PROJECT COST</h3>
                        <p class="text-3xl font-bold text-yellow-400" id="rpt_grand_total">Rs. 0</p>
                    </div>
                    
                    <div class="excel-section-header">Signatories</div>
                    <div class="flex gap-4">
                        <input type="text" id="rpt_sig_mgr" placeholder="Manager Name" class="excel-like-input">
                        <input type="text" id="rpt_sig_dir" placeholder="Director Name" class="excel-like-input">
                        <input type="text" id="rpt_sig_chm" placeholder="Chairman Name" class="excel-like-input">
                    </div>

                </div>
            </div>

            <div class="p-4 border-t bg-slate-50 flex justify-end gap-3 z-10">
                <button onclick="document.getElementById('newProjectReportDataModal').classList.add('hidden')" class="px-6 py-2 rounded-lg text-slate-600 font-bold hover:bg-slate-200">Close</button>
                <button onclick="saveReportData()" class="px-8 py-2 rounded-lg bg-blue-600 text-white font-bold shadow hover:bg-blue-700">Save Data</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, collectionGroup, addDoc, deleteDoc, onSnapshot, query, where, orderBy, doc, updateDoc, arrayUnion, getDoc, getDocs, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Constants and Globals
        let cInc = 0, cExp = 0;
        let currentProjId = null; 
        let currentProjName = ""; 
        let selectedBlockId = null; 
        let selectedBlockData = null;
        let currentProjUnsub = null;
        let projectTasksData = {};
        let staffListCache = [];
        let selectedLandId = null; // New for Land Payment
        let selectedLandBal = 0;   // New for Land Payment
        let customerCache = []; // New Global for Search
        const apiKey = ""; // Gemini API Key

        const firebaseConfig = {
            apiKey: "AIzaSyAlhMTQ-_sorFg_0ULpjf9kvjuIAWQkDVY",
            authDomain: "land-4d291.firebaseapp.com",
            projectId: "land-4d291",
            storageBucket: "land-4d291.firebasestorage.app",
            messagingSenderId: "1002505362762",
            appId: "1:1002505362762:web:f30e7ba82d8a344670f5b3",
            measurementId: "G-2EEQPP29VR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Variable for Report - UPDATED TO MATCH EXCEL
        let reportDataCache = {
            surveyRows: [
                {desc: "Perimeter survey", amount: 20000},
                {desc: "Blocking out of plan", amount: 3500},
                {desc: "Demarcation of boundaries", amount: 5000},
                {desc: "Roads and Drains demarcation", amount: 7500},
                {desc: "Re demarcation of boundaries", amount: 7500}
            ],
            devRows: [
                {desc: "Fencing", amount: 0},
                {desc: "Site Office", amount: 0},
                {desc: "Clearing", amount: 0},
                {desc: "Road Construction", amount: 0},
                {desc: "Boundaries/Boards", amount: 0},
                {desc: "Drainage", amount: 0},
                {desc: "Culverts", amount: 0},
                {desc: "Site Development", amount: 0},
                {desc: "Water Supply", amount: 0},
                {desc: "Electricity Supply", amount: 0}
            ]
        };

        // --- CORE FUNCTIONS (Defined first and attached to Window) ---

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        };

        // Define Navigation Function globally
        window.nav = (pageId) => {
            // Hide all pages
            const pages = ['projects', 'lands', 'staff', 'readings', 'reports', 'settings', 'detail'];
            pages.forEach(p => {
                const el = document.getElementById('page-' + p);
                if(el) el.classList.add('hidden');
            });
            // Show target
            const target = document.getElementById('page-' + pageId);
            if(target) target.classList.remove('hidden');

            // Update sidebar (active state)
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-blue-900/50', 'text-blue-400', 'border-blue-800'));
            const navBtn = document.getElementById('nav-' + pageId);
            if(navBtn) navBtn.classList.add('bg-blue-900/50', 'text-blue-400', 'border-blue-800');

            // Mobile sidebar toggle check
            if(window.innerWidth < 768) {
                const sb = document.getElementById('sidebar');
                if(sb && !sb.classList.contains('-translate-x-full')) window.toggleSidebar();
            }
        }
        
        window.subTab = (tabId) => {
            const views = ['overview', 'tasks', 'finance'];
            views.forEach(v => document.getElementById('view-' + v).classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            // Styles
            document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('text-slate-800', 'border-b-2', 'border-blue-800'));
            document.getElementById('st-' + tabId).classList.add('text-slate-800', 'border-b-2', 'border-blue-800');
        }

        window.toggleNotifPanel = () => {
             const p = document.getElementById('notifPanel');
             p.classList.toggle('hidden');
        }
        
        // --- NEW: Populate Land Dropdown on Modal Open ---
        window.openNewProjectModal = async () => {
             document.getElementById('newProjectModal').classList.remove('hidden');
             const landSelect = document.getElementById('landLinkSelect');
             landSelect.innerHTML = '<option value="">Select Land...</option>';
             
             // Fetch all lands
             const snap = await getDocs(collection(db, "company_lands"));
             snap.forEach(d => {
                 const l = d.data();
                 // Show land if it's NOT linked to another project
                 if (!l.linkedProjectId) {
                     landSelect.innerHTML += `<option value="${d.id}">${l.name}</option>`;
                 }
             });
        }

        window.closeImgModal = () => document.getElementById('imgModal').classList.add('hidden');
        window.openExpenseModal = () => document.getElementById('expenseModal').classList.remove('hidden');
        window.closeSellModal = () => document.getElementById('sellModal').classList.add('hidden');

        // NEW FUNCTION: Switch Financial Tabs
        window.switchFinTab = (tab) => {
            document.getElementById('fin-view-entry').classList.add('hidden');
            document.getElementById('fin-view-reports').classList.add('hidden');
            
            // Reset styles
            document.getElementById('ft-entry').classList.remove('border-blue-800', 'text-slate-800');
            document.getElementById('ft-reports').classList.remove('border-blue-800', 'text-slate-800');
            document.getElementById('ft-entry').classList.add('text-gray-400');
            document.getElementById('ft-reports').classList.add('text-gray-400');

            // Set active
            document.getElementById('fin-view-' + tab).classList.remove('hidden');
            const btn = document.getElementById('ft-' + tab);
            btn.classList.add('border-blue-800', 'text-slate-800');
            btn.classList.remove('text-gray-400');
        };

        window.loadStaff = async () => {
            const grid = document.getElementById('staffGrid'); 
            const dropdown = document.getElementById('salesDropdown');
            if(!grid || !dropdown) return;

            onSnapshot(collection(db, "staff"), (snap) => {
                grid.innerHTML = ""; dropdown.innerHTML = "";
                staffListCache = []; 
                const today = new Date();
                const curMonthKey = `${today.getFullYear()}_${today.getMonth() + 1}`;

                if(snap.empty) {
                    grid.innerHTML = "<p class='text-gray-500 p-4'>No staff members found.</p>";
                    return;
                }

                snap.forEach(d => {
                    const s = d.data(); 
                    s.id = d.id; // Store ID for logic
                    staffListCache.push(s); 
                    const photo = s.photo || 'https://via.placeholder.com/150';
                    const isPaid = s.lastPaidMonth === curMonthKey;
                    
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 cursor-pointer hover:shadow-md transition relative overflow-hidden";
                    el.onclick = () => window.openStaffDetail(d.id);
                    el.innerHTML = `
                        <img src="${photo}" class="w-12 h-12 rounded-full object-cover border-2 border-blue-100 bg-gray-200">
                        <div>
                            <h4 class="font-bold text-slate-800">${s.name}</h4>
                            <p class="text-[10px] font-bold text-blue-500 uppercase">${s.position || 'Staff'}</p>
                            <p class="text-xs text-gray-500">${s.nic}</p>
                            <p class="text-xs font-bold mt-1 text-blue-600">Salary: ${s.salary.toLocaleString()}</p>
                        </div>
                        ${isPaid ? '<span class="absolute top-2 right-2 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded border border-green-200">PAID: '+ new Date().toLocaleString('default', { month: 'short' }) +'</span>' : ''}
                    `;
                    grid.appendChild(el);

                    const div = document.createElement('div');
                    div.innerHTML = `<span class="font-bold">${s.name}</span> <span class="text-xs text-gray-500">(${s.position || 'Staff'})</span>`;
                    div.onclick = () => {
                        document.getElementById("salesPersonInput").value = s.name;
                        document.getElementById("salesDropdown").classList.remove("show");
                    };
                    dropdown.appendChild(div);
                });
            });
            window.loadStaffPool();
        }

        window.loadProjects = async () => {
            const grid = document.getElementById('projectGrid'); 
            const closedList = document.getElementById('closedProjectList');
            if(!grid || !closedList) return;
            
            onSnapshot(collection(db, "projects"), (snap) => {
                grid.innerHTML = ""; closedList.innerHTML = "";
                
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    const isClosed = d.status === 'closed';
                    const el = document.createElement('div');
                    if(!isClosed) {
                        el.className = "bg-white p-6 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer border border-blue-100 transition relative overflow-hidden group";
                        el.onclick = () => window.openProject(docSnap.id, d);
                        el.innerHTML = `<div class="absolute top-0 left-0 w-2 h-full bg-slate-900 group-hover:bg-blue-600 transition"></div><h3 class="font-bold text-lg text-slate-900 pl-2 project-card-title">${d.name}</h3><p class="text-sm text-gray-500 pl-2"><i class="fas fa-map-marker-alt mr-1"></i> ${d.area}</p><span class="text-[10px] uppercase font-bold bg-blue-100 px-2 py-1 rounded absolute top-4 right-4 text-gray-500 tracking-wider">${d.status}</span>`;
                        grid.appendChild(el);
                    } else {
                        el.className = "bg-gray-100 p-4 rounded-xl flex justify-between items-center cursor-pointer border border-gray-200 hover:bg-gray-200";
                        el.onclick = () => window.openProject(docSnap.id, d);
                        el.innerHTML = `<div><h3 class="font-bold text-slate-700">${d.name}</h3><p class="text-xs text-gray-500">${d.area} (Closed)</p></div><i class="fas fa-chevron-right text-gray-400"></i>`;
                        closedList.appendChild(el);
                    }
                });
            });
        }
        
        window.createProject = async () => {
            const name = document.getElementById('newProjName').value;
            const area = document.getElementById('newProjArea').value;
            const linkedLandId = document.getElementById('landLinkSelect').value;

            if(!name) return alert("Name required");
            try {
                const pData = {
                    name, area, status: 'development', createdAt: serverTimestamp()
                };
                if(linkedLandId) pData.linkedLandId = linkedLandId;

                const ref = await addDoc(collection(db, "projects"), pData);
                
                // If a land was linked, update the Land document
                if(linkedLandId) {
                    await updateDoc(doc(db, "company_lands", linkedLandId), {
                        linkedProjectId: ref.id
                    });
                }

                document.getElementById('newProjectModal').classList.add('hidden');
                alert("Project Created");
            } catch(e) { console.error(e); alert("Error"); }
        }
        
        window.loadLands = async () => {
            onSnapshot(collection(db, "company_lands"), (snap) => {
                const grid = document.getElementById('landsGrid');
                if(!grid) return;
                grid.innerHTML = "";
                snap.forEach(d => {
                    const l = d.data();
                    const paid = (l.advance || 0) + (l.partPayment || 0);
                    const bal = (l.cost || 0) - paid;
                    const isPaid = bal <= 0;
                    grid.innerHTML += `
                        <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full ${isPaid ? 'bg-green-500' : 'bg-red-500'}"></div>
                            <h3 class="font-bold text-lg ml-3">${l.name}</h3>
                            <p class="text-sm text-gray-500 ml-3 mb-2">Seller: ${l.seller}</p>
                            ${l.linkedProjectId ? '<span class="ml-3 bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded">LINKED TO PROJECT</span>' : '<span class="ml-3 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded">AVAILABLE</span>'}
                            <div class="ml-3 grid grid-cols-2 gap-4 text-sm mt-4">
                                <div><p class="text-xs text-gray-400 font-bold uppercase">Cost</p><p class="font-bold">Rs. ${l.cost.toLocaleString()}</p></div>
                                <div><p class="text-xs text-gray-400 font-bold uppercase">Paid</p><p class="font-bold text-green-600">Rs. ${paid.toLocaleString()}</p></div>
                                <div class="col-span-2 border-t pt-2 flex justify-between items-center">
                                    <span class="text-xs font-bold ${isPaid?'text-green-500':'text-red-500'} uppercase">${isPaid?'Fully Paid':'Balance: Rs. '+bal.toLocaleString()}</span>
                                    ${!isPaid ? `<button onclick="openLandPaymentModal('${d.id}', '${l.name}', ${bal})" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 font-bold border border-blue-200">Add Payment</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }
        
        window.saveLand = async () => {
            const name = document.getElementById('landName').value;
            const cost = parseFloat(document.getElementById('landCost').value) || 0;
            const advance = parseFloat(document.getElementById('landAdvance').value) || 0;
            const seller = document.getElementById('landSeller').value;

            await addDoc(collection(db, "company_lands"), {
                name, cost, advance, seller, status: 'acquired', createdAt: serverTimestamp()
            });
            document.getElementById('newLandModal').classList.add('hidden');
            alert("Land Added");
        }
        
        // NEW: Auto calculate 10% advance
        window.calcLandAdvance = () => {
            const cost = parseFloat(document.getElementById('landCost').value) || 0;
            document.getElementById('landAdvance').value = cost * 0.10;
        }
        
        // --- FIXED LAND PAYMENT MODAL ---
        window.openLandPaymentModal = (id, name, bal) => {
            selectedLandId = id;
            selectedLandBal = bal;
            document.getElementById('landPayInfo').innerText = `${name} - Balance Due: Rs. ${bal.toLocaleString()}`;
            document.getElementById('landPaymentModal').classList.remove('hidden');
        };

        window.submitLandPayment = async () => {
             const amt = parseFloat(document.getElementById('landPayAmount').value);
             const date = document.getElementById('landPayDate').value;
             if(!amt || !date) return alert("Enter Amount and Date");
             
             // 1. Update Land Doc (partPayment)
             const landRef = doc(db, "company_lands", selectedLandId);
             const landSnap = await getDoc(landRef);
             if(landSnap.exists()) {
                 const curPaid = landSnap.data().partPayment || 0;
                 await updateDoc(landRef, { partPayment: curPaid + amt });
             }

             // 2. Add Global Transaction
             await addDoc(collection(db, "transactions"), {
                 date: date,
                 description: `Land Payment: ${document.getElementById('landPayInfo').innerText.split(' - ')[0]}`,
                 amount: amt,
                 type: 'Expense',
                 category: 'Land Acquisition',
                 timestamp: serverTimestamp()
             });

             document.getElementById('landPaymentModal').classList.add('hidden');
             alert("Land Payment Recorded Successfully!");
             document.getElementById('landPayAmount').value = "";
        };

        window.toggleProjectView = (type) => {
            const grid = document.getElementById('projectGrid');
            const list = document.getElementById('closedProjectList');
            const btnActive = document.getElementById('btn-view-active');
            const btnClosed = document.getElementById('btn-view-closed');

            if(type === 'active') {
                grid.style.display = 'grid';
                list.style.display = 'none';
                btnActive.classList.add('bg-white', 'shadow', 'text-slate-800');
                btnActive.classList.remove('text-gray-500');
                btnClosed.classList.remove('bg-white', 'shadow', 'text-slate-800');
                btnClosed.classList.add('text-gray-500');
            } else {
                grid.style.display = 'none';
                list.style.display = 'block';
                btnClosed.classList.add('bg-white', 'shadow', 'text-slate-800');
                btnClosed.classList.remove('text-gray-500');
                btnActive.classList.remove('bg-white', 'shadow', 'text-slate-800');
                btnActive.classList.add('text-gray-500');
            }
        }
        
        window.checkOverduePayments = async () => { 
            const blocksQ = query(collectionGroup(db, 'blocks'), where('status', '==', 'sold')); 
            const snap = await getDocs(blocksQ); 
            const list = document.getElementById('notifList'); 
            if(!list) return;
            list.innerHTML = ""; 
            let count = 0; 
            snap.forEach(d => { 
                const b = d.data(); 
                if(b.payment && b.payment.planType === 'EP' && b.payment.nextPaymentDate) { 
                    const nextD = b.payment.nextPaymentDate.seconds ? new Date(b.payment.nextPaymentDate.seconds*1000) : new Date(b.payment.nextPaymentDate); 
                    if(nextD < new Date()) { 
                        count++; 
                        list.innerHTML += `<div class="p-3 border-b bg-red-50"><p class="font-bold text-xs">${b.name}</p><p class="text-[10px] text-red-500">Overdue: ${nextD.toLocaleDateString()}</p></div>`; 
                    } 
                } 
            }); 
            if(count > 0 && document.getElementById('notifBadge')) { 
                document.getElementById('notifBadge').innerText = count; 
                document.getElementById('notifBadge').classList.remove('hidden'); 
            } 
        }

        window.updateNet = (i,e) => { 
            if(i!==null) cInc=i; 
            if(e!==null) cExp=e; 
            const net = cInc-cExp; 
            const el = document.getElementById('finProfit');
            if(el) {
                el.innerText = "Rs. " + net.toLocaleString(); 
                el.className = `text-3xl font-bold relative z-10 ${net>=0?'text-slate-800':'text-red-600'}`; 
            }
        }
        
        // Gemini AI Integration
        window.analyzeProjectWithAI = async () => {
            const modal = document.getElementById('aiAnalysisModal');
            const contentDiv = document.getElementById('aiContent');
            const loadingDiv = document.getElementById('aiLoading');
            
            modal.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            
            // Gather Project Data
            const income = document.getElementById('finIncome').innerText;
            const expense = document.getElementById('finExpense').innerText;
            const profit = document.getElementById('finProfit').innerText;
            const projName = document.getElementById('detailName').innerText;
            
            // Construct Prompt
            const prompt = `Act as a senior real estate financial analyst. Analyze the following project data for "Sithuliya Real Estate":
            
            Project: ${projName}
            Total Revenue: ${income}
            Total Expenses: ${expense}
            Net Profit: ${profit}
            
            Please provide:
            1. A brief financial health summary (Is it profitable? By what margin?).
            2. Three specific, actionable recommendations to improve profitability or speed up sales.
            3. A risk assessment score (Low/Medium/High) based on the figures.
            
            Format the output in clean Markdown with bold headings and bullet points. Keep it professional but concise.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                const resultText = data.candidates[0].content.parts[0].text;
                
                contentDiv.innerHTML = marked.parse(resultText);
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                
            } catch (error) {
                console.error("AI Error:", error);
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                contentDiv.innerHTML = `<p class="text-red-500">Analysis failed. Please try again.</p>`;
            }
        };

        window.attemptLogin = async () => {
            const pwd = document.getElementById('loginPass').value;
            let correct = "Sandeep@1116"; 
            try {
                const settingsRef = doc(db, "settings", "config");
                const snap = await getDoc(settingsRef);
                if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword;
            } catch (e) { console.log("Using default password due to fetch error"); }

            if(pwd === correct) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                // INIT APP IS CALLED HERE BUT ALSO ON LOAD IF LOGGED IN?
                // For this structure, we init data anyway, just toggle view.
                window.loadProjects(); 
                window.checkOverduePayments();
                window.loadStaff();
                window.loadLands(); // FIX: Added
                window.loadMeterReadings(); // FIX: Added
                window.checkPayroll(); // AUTO PAYROLL CHECK
            } else { alert("Incorrect Password"); }
        };

        window.openReportDataModal = async () => {
             if(!currentProjId) return;
            document.getElementById('newProjectReportDataModal').classList.remove('hidden');
            const snap = await getDoc(doc(db, "projects", currentProjId));
            const p = snap.data();
            const d = p.reportData || {};
            const s = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val !== undefined ? val : ""; };
            s('rpt_name', p.name); s('rpt_location', p.area);
            s('rpt_owner', d.owner); s('rpt_introducer', d.introducer);
            s('rpt_acres', d.acres); s('rpt_roods', d.roods); s('rpt_perches', d.perches);
            s('rpt_road_p', d.road_p); s('rpt_res_p', d.res_p);
            calcReportTotals(); 
            
            s('rpt_title_ins', d.title_ins); s('rpt_stamp', d.stamp); s('rpt_legal', d.legal); s('rpt_valuation', d.valuation); s('rpt_intro_comm', d.intro_comm);
            if(p.linkedLandId) {
                const lSnap = await getDoc(doc(db, "company_lands", p.linkedLandId));
                if(lSnap.exists()) s('rpt_purchase_price', lSnap.data().cost);
            } else { s('rpt_purchase_price', d.purchase_price || 0); }
            
            // Render Surveys
            const surveyContainer = document.getElementById('surveyRowsContainer'); 
            surveyContainer.innerHTML = "";
            let sRows = d.surveyRows || reportDataCache.surveyRows;
            sRows.forEach((row, i) => {
                surveyContainer.innerHTML += `
                <div class="excel-like-row excel-sub-row survey-row">
                    <div class="excel-like-label"><input value="${row.desc}" class="border-none bg-transparent w-full text-xs font-bold text-gray-600 survey-desc"></div>
                    <input type="number" value="${row.amount}" class="excel-like-input text-right survey-amount" oninput="calcReportTotals()">
                </div>`;
            });

            // Render Developments
            const devContainer = document.getElementById('devRowsContainer');
            devContainer.innerHTML = "";
            let dRows = d.devRows || reportDataCache.devRows;
            dRows.forEach((row, i) => {
                devContainer.innerHTML += `
                <div class="excel-like-row excel-sub-row dev-row">
                    <div class="excel-like-label"><input value="${row.desc}" class="border-none bg-transparent w-full text-xs font-bold text-gray-600 dev-desc"></div>
                    <input type="number" value="${row.amount}" class="excel-like-input text-right dev-amount" oninput="calcReportTotals()">
                    <button onclick="this.parentElement.remove();calcReportTotals()" class="ml-2 text-red-500 text-xs">x</button>
                </div>`;
            });

            s('rpt_ad_cost', d.ad_cost); s('rpt_tax_1pct', d.tax_1pct); s('rpt_cost_capital', d.cost_capital);
            s('rpt_sig_mgr', d.sig_mgr); s('rpt_sig_dir', d.sig_dir); s('rpt_sig_chm', d.sig_chm);
            s('rpt_vat_rate', d.vat_rate || 18);
            
            calcReportTotals(); // Initial calc
        };

        window.addNewDevRow = () => {
            const devContainer = document.getElementById('devRowsContainer');
            devContainer.innerHTML += `
            <div class="excel-like-row excel-sub-row dev-row">
                <div class="excel-like-label"><input placeholder="New Item" class="border-none bg-transparent w-full text-xs font-bold text-gray-600 dev-desc"></div>
                <input type="number" value="0" class="excel-like-input text-right dev-amount" oninput="calcReportTotals()">
                <button onclick="this.parentElement.remove();calcReportTotals()" class="ml-2 text-red-500 text-xs">x</button>
            </div>`;
        }

        window.calcReportTotals = () => { 
            const getV = (id) => parseFloat(document.getElementById(id).value) || 0; 
            
            // Extent
            const totPerches = (getV('rpt_acres') * 160) + (getV('rpt_roods') * 40) + getV('rpt_perches'); 
            document.getElementById('rpt_tot_perches').value = totPerches; 
            const sellP = totPerches - getV('rpt_road_p') - getV('rpt_res_p');
            document.getElementById('rpt_sell_p').value = sellP;

            // Purchase Cost
            const purTotal = getV('rpt_purchase_price') + getV('rpt_title_ins') + getV('rpt_stamp') + getV('rpt_legal') + getV('rpt_intro_comm') + getV('rpt_valuation');
            document.getElementById('rpt_tot_purchase').value = purTotal;

            // Surveys
            let surTotal = 0;
            document.querySelectorAll('.survey-amount').forEach(i => surTotal += parseFloat(i.value)||0);
            document.getElementById('rpt_tot_survey').value = surTotal;

            // Dev
            let devTotal = 0;
            document.querySelectorAll('.dev-amount').forEach(i => devTotal += parseFloat(i.value)||0);
            document.getElementById('rpt_tot_dev').value = devTotal;

            // Grand Total
            const grandTotal = purTotal + surTotal + devTotal + getV('rpt_ad_cost') + getV('rpt_tax_1pct') + getV('rpt_cost_capital');
            document.getElementById('rpt_grand_total').innerText = "Rs. " + grandTotal.toLocaleString();
            
            // Calc VAT Context
            document.getElementById('rpt_vat_less_pur').value = purTotal;
            document.getElementById('rpt_vat_less_dev').value = devTotal;
            window.calcVAT();
        };
        
        window.calcVAT = () => {
            const sales = parseFloat(document.getElementById('rpt_vat_sales').value) || 0;
            const pur = parseFloat(document.getElementById('rpt_vat_less_pur').value) || 0;
            const dev = parseFloat(document.getElementById('rpt_vat_less_dev').value) || 0;
            const rate = parseFloat(document.getElementById('rpt_vat_rate').value) || 0;
            
            const valAdd = sales - (pur + dev);
            document.getElementById('rpt_vat_val_add').value = valAdd > 0 ? valAdd : 0;
            
            const vat = valAdd > 0 ? valAdd * (rate/100) : 0;
            document.getElementById('rpt_vat_payable').value = vat.toFixed(2);
        };

        window.saveReportData = async () => { 
            const getV = (id) => document.getElementById(id).value; 
            const getVN = (id) => parseFloat(document.getElementById(id).value) || 0;

            let surveyRows = []; 
            document.querySelectorAll('.survey-row').forEach(row => { 
                surveyRows.push({ desc: row.querySelector('.survey-desc').value, amount: parseFloat(row.querySelector('.survey-amount').value)||0 }); 
            }); 
            
            let devRows = []; 
            document.querySelectorAll('.dev-row').forEach(row => { 
                devRows.push({ desc: row.querySelector('.dev-desc').value, amount: parseFloat(row.querySelector('.dev-amount').value)||0 }); 
            }); 

            const data = { 
                owner: getV('rpt_owner'), introducer: getV('rpt_introducer'), 
                acres: getV('rpt_acres'), roods: getV('rpt_roods'), perches: getV('rpt_perches'), 
                road_p: getVN('rpt_road_p'), res_p: getVN('rpt_res_p'),
                
                purchase_price: getVN('rpt_purchase_price'), title_ins: getVN('rpt_title_ins'), 
                stamp: getVN('rpt_stamp'), legal: getVN('rpt_legal'), valuation: getVN('rpt_valuation'), intro_comm: getVN('rpt_intro_comm'),
                
                surveyRows: surveyRows, 
                devRows: devRows, 
                
                ad_cost: getVN('rpt_ad_cost'), tax_1pct: getVN('rpt_tax_1pct'), cost_capital: getVN('rpt_cost_capital'),
                vat_rate: getVN('rpt_vat_rate'),
                
                sig_mgr: getV('rpt_sig_mgr'), sig_dir: getV('rpt_sig_dir'), sig_chm: getV('rpt_sig_chm') 
            }; 
            
            await updateDoc(doc(db, "projects", currentProjId), { reportData: data }); 
            document.getElementById('newProjectReportDataModal').classList.add('hidden'); 
            alert("Report Data Saved!"); 
        };

        window.generateProjectMasterReport = async () => { 
            if(!currentProjId) return alert("Open a project first.");
            const snap = await getDoc(doc(db, "projects", currentProjId));
            const p = snap.data();
            const d = p.reportData;
            if(!d) return alert("Please fill Report Data first.");
            
            // Helper
            const f = (val) => val ? parseFloat(val) : 0;
            const fmt = (val) => f(val).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Calc Totals Again for PDF
            const totPerches = (f(d.acres)*160) + (f(d.roods)*40) + f(d.perches);
            const sellP = totPerches - f(d.road_p) - f(d.res_p);
            
            const purTotal = f(d.purchase_price) + f(d.title_ins) + f(d.stamp) + f(d.legal) + f(d.intro_comm) + f(d.valuation);
            
            let surHtml = ""; let surTotal = 0;
            (d.surveyRows || []).forEach(row => { surTotal += f(row.amount); surHtml += `<tr><td>${row.desc}</td><td style="text-align:right">${fmt(row.amount)}</td></tr>`; });
            
            let devHtml = ""; let devTotal = 0;
            (d.devRows || []).forEach(row => { devTotal += f(row.amount); devHtml += `<tr><td>${row.desc}</td><td style="text-align:right">${fmt(row.amount)}</td></tr>`; });

            const grandTotal = purTotal + surTotal + devTotal + f(d.ad_cost) + f(d.tax_1pct) + f(d.cost_capital);

            // VAT Calc for Report
            // We need Sales Proceeds. In Report Data, we don't save Sales Proceeds usually, but if user entered in modal we could use that.
            // OR fetch actual sales. Let's use Actual Sales from DB blocks.
            let salesProceeds = 0;
            const bSnap = await getDocs(collection(db, `projects/${currentProjId}/blocks`)); 
            bSnap.forEach(b => salesProceeds += (b.data().soldPrice || b.data().price));
            
            const valAdd = salesProceeds - (purTotal + devTotal);
            const vatPayable = valAdd > 0 ? valAdd * (f(d.vat_rate)/100) : 0;

            const html = `
            <div style="font-family: 'Times New Roman', serif; padding: 40px; font-size: 14px;">
                <h1 style="text-align:center; font-weight:bold; font-size:24px; text-decoration:underline; margin-bottom:20px;">PROJECT EVALUATION REPORT</h1>
                
                <table style="width:100%; margin-bottom:20px;">
                    <tr><td style="font-weight:bold; width:150px;">NAME OF THE PROJECT :</td><td>${p.name.toUpperCase()}</td></tr>
                    <tr><td style="font-weight:bold;">Owner :</td><td>${d.owner}</td></tr>
                    <tr><td style="font-weight:bold;">Location of Land :</td><td>${d.location || p.area}</td></tr>
                    <tr><td style="font-weight:bold;">Introducer :</td><td>${d.introducer}</td></tr>
                </table>

                <div style="margin-bottom:10px; font-weight:bold; text-decoration:underline;">EXTENT</div>
                <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                    <tr><td>Total Extent</td><td style="text-align:right">${d.acres}A ${d.roods}R ${d.perches}P</td><td style="text-align:right; font-weight:bold;">${totPerches} P</td></tr>
                    <tr><td>Road Allocation</td><td></td><td style="text-align:right">${d.road_p} P</td></tr>
                    <tr><td>Reservation</td><td></td><td style="text-align:right">${d.res_p} P</td></tr>
                    <tr style="border-top:1px solid #000; font-weight:bold;"><td>Sellable Area</td><td></td><td style="text-align:right">${sellP} P</td></tr>
                </table>

                <div style="margin-bottom:10px; font-weight:bold; text-decoration:underline;">COST OF PURCHASE</div>
                <table style="width:100%; margin-bottom:20px;">
                    <tr><td>Purchase Price</td><td style="text-align:right">${fmt(d.purchase_price)}</td></tr>
                    <tr><td>Title Insurance</td><td style="text-align:right">${fmt(d.title_ins)}</td></tr>
                    <tr><td>Stamp Duty (4%)</td><td style="text-align:right">${fmt(d.stamp)}</td></tr>
                    <tr><td>Legal Fees</td><td style="text-align:right">${fmt(d.legal)}</td></tr>
                    <tr><td>Introducer Comm.</td><td style="text-align:right">${fmt(d.intro_comm)}</td></tr>
                    <tr><td>Valuation</td><td style="text-align:right">${fmt(d.valuation)}</td></tr>
                    <tr style="border-top:1px solid #000; font-weight:bold;"><td>Total Purchase Cost</td><td style="text-align:right">${fmt(purTotal)}</td></tr>
                </table>

                <div style="display:flex; justify-content:space-between; gap:20px;">
                    <div style="width:48%;">
                        <div style="font-weight:bold; text-decoration:underline;">SURVEY CHARGES</div>
                        <table style="width:100%;">${surHtml}<tr style="border-top:1px solid #000; font-weight:bold;"><td>Total</td><td style="text-align:right">${fmt(surTotal)}</td></tr></table>
                    </div>
                    <div style="width:48%;">
                        <div style="font-weight:bold; text-decoration:underline;">DEVELOPMENT COST</div>
                        <table style="width:100%;">${devHtml}<tr style="border-top:1px solid #000; font-weight:bold;"><td>Total</td><td style="text-align:right">${fmt(devTotal)}</td></tr></table>
                    </div>
                </div>

                <div style="margin-top:20px;">
                    <table style="width:100%;">
                        <tr><td>Advertising</td><td style="text-align:right">${fmt(d.ad_cost)}</td></tr>
                        <tr><td>1% Tax and other approvals</td><td style="text-align:right">${fmt(d.tax_1pct)}</td></tr>
                        <tr><td>Cost of the Capital</td><td style="text-align:right">${fmt(d.cost_capital)}</td></tr>
                        <tr style="border-top:2px solid #000; border-bottom:2px solid #000; font-weight:bold; font-size:16px;">
                            <td style="padding:5px 0;">TOTAL PROJECT AMOUNT</td><td style="text-align:right; padding:5px 0;">${fmt(grandTotal)}</td>
                        </tr>
                    </table>
                </div>

                <div style="margin-top:30px; border:1px solid #000; padding:10px;">
                    <h3 style="margin:0; text-decoration:underline;">VAT CALCULATION</h3>
                    <table style="width:100%;">
                        <tr><td>Sales Proceeds</td><td style="text-align:right; font-weight:bold;">${fmt(salesProceeds)}</td></tr>
                        <tr><td>Less: Purchase Cost</td><td style="text-align:right">(${fmt(purTotal)})</td></tr>
                        <tr><td>Less: Development Cost</td><td style="text-align:right">(${fmt(devTotal)})</td></tr>
                        <tr style="font-weight:bold;"><td>Value Addition</td><td style="text-align:right">${fmt(valAdd)}</td></tr>
                        <tr><td>VAT Rate</td><td style="text-align:right">${d.vat_rate}%</td></tr>
                        <tr style="font-weight:bold; font-size:15px;"><td>VAT Payable</td><td style="text-align:right">${fmt(vatPayable)}</td></tr>
                    </table>
                </div>

                <div style="margin-top:80px; display:flex; justify-content:space-between; text-align:center;">
                    <div>..........................................<br>${d.sig_mgr || 'Manager'}</div>
                    <div>..........................................<br>${d.sig_dir || 'Director'}</div>
                    <div>..........................................<br>${d.sig_chm || 'Chairman'}</div>
                </div>
                <div style="text-align:right; margin-top:20px;">Date: ${new Date().toLocaleDateString()}</div>
            </div>`;
            
            document.getElementById('printContainer').innerHTML = html;
            document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        window.downloadPDFActual = async () => {
             const element = document.getElementById('printContainer');
             const opt = { 
                 margin: 0,
                 filename: `Report_${currentProjName}.pdf`, 
                 image: { type: 'jpeg', quality: 0.98 }, 
                 html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
                 jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
             };
            await html2pdf().set(opt).from(element).save();
            document.getElementById('pdfPreviewOverlay').style.display = 'none';
        }
        
        // NEW: Download Financial Report (Profit Analysis)
        window.downloadFinancialReport = async () => {
             if(!currentProjId) return alert("Select a project first.");
             const el = document.getElementById('view-finance');
             // Temporarily hide buttons to clean up PDF
             const buttons = el.querySelectorAll('button');
             buttons.forEach(b => b.style.display = 'none');
             
             const opt = { 
                 margin: 10,
                 filename: `Financial_Report_${currentProjName}.pdf`, 
                 image: { type: 'jpeg', quality: 0.98 }, 
                 html2canvas: { scale: 2, useCORS: true }, 
                 jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } 
             };
             
             await html2pdf().set(opt).from(el).save();
             
             // Restore buttons
             buttons.forEach(b => b.style.display = 'inline-block');
        };

        window.filterStaffGrid = () => {
            const input = document.getElementById('staffSearchInput').value.toLowerCase();
            const grid = document.getElementById('staffGrid');
            const cards = grid.getElementsByTagName('div');
            for (let i = 0; i < cards.length; i++) {
                const nameHeader = cards[i].querySelector('h4');
                if (nameHeader) {
                    const txtValue = nameHeader.textContent || nameHeader.innerText;
                    cards[i].style.display = txtValue.toLowerCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        };

        window.filterSalesFunction = () => {
            const input = document.getElementById("salesPersonInput");
            const filter = input.value.toUpperCase();
            const div = document.getElementById("salesDropdown");
            const a = div.getElementsByTagName("div");
            for (let i = 0; i < a.length; i++) {
                const txtValue = a[i].textContent || a[i].innerText;
                a[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
            }
        };

        window.toggleSalesDropdown = () => document.getElementById("salesDropdown").classList.toggle("show");
        
        window.onclick = function(event) {
            if (!event.target.matches('#salesPersonInput')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for (let i = 0; i < dropdowns.length; i++) {
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show');
                }
            }
        };

        window.loadStaffPool = async () => { 
            const q = query(collection(db, 'transactions'), where('category', '==', 'Staff Welfare')); 
            const snap = await getDocs(q); 
            let total = 0; 
            const list = document.getElementById('staffPoolList'); 
            if(!list) return;
            list.innerHTML = ""; 
            snap.forEach(d => { 
                const t = d.data(); 
                total += t.amount; 
                list.innerHTML += `<div class="flex justify-between border-b border-gray-100 p-1"><span>${t.description.split(':')[1] || t.description}</span><span>${t.amount.toLocaleString()}</span></div>`; 
            }); 
            if(document.getElementById('staffPoolTotal')) {
                document.getElementById('staffPoolTotal').innerText = "Rs. " + total.toLocaleString(); 
            }
        }

        // --- NEW: STAFF AUTO PAYROLL CHECK (Runs on startup) ---
        window.checkPayroll = async () => {
            const today = new Date();
            if (today.getDate() >= 25) { // Only run if it's the 25th or later
                const currentMonthKey = `${today.getFullYear()}_${today.getMonth() + 1}`;
                const snapshot = await getDocs(collection(db, "staff"));
                snapshot.forEach(async (docSnap) => {
                    const s = docSnap.data();
                    if (s.lastPaidMonth !== currentMonthKey) {
                        // 1. Create Expense Transaction
                        await addDoc(collection(db, "transactions"), {
                            date: today.toLocaleDateString('en-CA'),
                            description: `Monthly Salary: ${s.name}`,
                            amount: s.salary || 0,
                            type: 'Expense',
                            category: 'Staff Salary',
                            timestamp: serverTimestamp()
                        });
                        
                        // 2. Add to Staff Earnings History subcollection
                        await addDoc(collection(db, `staff/${docSnap.id}/earnings`), {
                            date: today,
                            amount: s.salary || 0,
                            type: 'Salary',
                            description: `Salary for ${new Date().toLocaleString('default', { month: 'long' })}`
                        });

                        // 3. Update Staff Doc
                        await updateDoc(doc(db, "staff", docSnap.id), { lastPaidMonth: currentMonthKey });
                        console.log(`Auto-Paid Salary for ${s.name}`);
                    }
                });
            }
        };

        // NEW: OPEN STAFF DETAIL MODAL (Fixed Buttons & Earnings Display)
        window.openStaffDetail = async (id) => {
            const s = staffListCache.find(x => x.id === id); 
            if(!s) return;
            
            document.getElementById('sdPhoto').src = s.photo || 'https://via.placeholder.com/150';
            document.getElementById('sdName').innerText = s.name;
            document.getElementById('sdPosition').innerText = s.position || 'Staff Member';
            document.getElementById('sdNIC').innerText = s.nic || '-';
            document.getElementById('sdPhone').innerText = s.phone || '-';
            document.getElementById('sdSalary').innerText = "Rs. " + (s.salary ? s.salary.toLocaleString() : '0');
            document.getElementById('sdJoined').innerText = s.joinedDate ? new Date(s.joinedDate.seconds*1000).toLocaleDateString() : '-';
            
            // Generate Buttons
            const btnContainer = document.getElementById('sdActionBtns');
            btnContainer.innerHTML = `
                <button onclick="editStaff('${id}')" class="w-full py-2 border border-gray-300 rounded-lg font-bold text-gray-600 hover:bg-gray-50 text-xs">Edit Details</button>
                <button onclick="deleteStaff('${id}')" class="w-full py-2 bg-red-600 text-white rounded-lg font-bold shadow hover:bg-red-700 text-xs">Remove Member</button>
            `;
            
            // Load Earnings (Salary + Commissions)
            const earnList = document.getElementById('sdEarningsList');
            earnList.innerHTML = "Loading...";
            let totalEarn = 0;
            
            try {
                // Fetch from subcollection 'earnings'
                const earnSnap = await getDocs(collection(db, `staff/${id}/earnings`));
                let html = "";
                earnSnap.forEach(doc => {
                    const e = doc.data();
                    const d = e.date.seconds ? new Date(e.date.seconds*1000) : new Date(e.date);
                    totalEarn += (e.amount || 0);
                    let color = e.type === 'Salary' ? 'text-blue-600' : 'text-purple-600';
                    // Added Project/Description display for commissions
                    let desc = e.description || '';
                    html += `<tr class="border-b border-gray-100">
                        <td class="p-1 text-gray-500">
                            ${d.toLocaleDateString()}<br>
                            <span class="text-[9px] text-gray-400">${desc}</span>
                        </td>
                        <td class="p-1 font-bold ${color}">${e.type}</td>
                        <td class="p-1 text-right font-bold">Rs. ${e.amount.toLocaleString()}</td>
                    </tr>`;
                });
                earnList.innerHTML = html || "<tr><td colspan='3' class='text-center p-2 text-gray-400'>No earnings history.</td></tr>";
                document.getElementById('sdTotalEarnings').innerText = "Rs. " + totalEarn.toLocaleString();
            } catch(e) { console.log(e); earnList.innerHTML = "Error loading earnings."; }

            document.getElementById('staffDetailModal').classList.remove('hidden');
        };

        // NEW: DELETE STAFF
        window.deleteStaff = async (id) => {
            if(!confirm("Are you sure you want to remove this staff member? This cannot be undone.")) return;
            await deleteDoc(doc(db, "staff", id));
            document.getElementById('staffDetailModal').classList.add('hidden');
            alert("Staff Member Removed.");
        };

        // NEW: EDIT STAFF (Re-uses New Staff Modal)
        window.editStaff = (id) => {
            const s = staffListCache.find(x => x.id === id);
            if(!s) return;
            
            document.getElementById('staffDetailModal').classList.add('hidden');
            document.getElementById('newStaffModal').classList.remove('hidden');
            
            document.getElementById('staffMode').value = 'edit';
            document.getElementById('editStaffId').value = id;
            document.getElementById('newStaffBtnText').innerText = 'Update Details';
            
            document.getElementById('staffName').value = s.name;
            document.getElementById('staffNIC').value = s.nic;
            document.getElementById('staffPhone').value = s.phone;
            document.getElementById('staffPosition').value = s.position;
            document.getElementById('staffSalary').value = s.salary;
        };

        // NEW: SAVE/UPDATE STAFF
        window.saveStaff = async () => {
            const mode = document.getElementById('staffMode').value;
            const name = document.getElementById('staffName').value;
            const nic = document.getElementById('staffNIC').value;
            const phone = document.getElementById('staffPhone').value;
            const pos = document.getElementById('staffPosition').value;
            const sal = parseFloat(document.getElementById('staffSalary').value);
            const file = document.getElementById('staffPhoto').files[0];
            
            if(!name || !nic) return alert("Name and NIC required");
            
            let photoBase64 = null;
            if(file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => reader.onload = resolve);
                photoBase64 = reader.result;
            }

            const data = { name, nic, phone, position: pos, salary: sal };
            if(photoBase64) data.photo = photoBase64;

            if (mode === 'edit') {
                const id = document.getElementById('editStaffId').value;
                await updateDoc(doc(db, "staff", id), data);
                alert("Staff Details Updated!");
            } else {
                data.joinedDate = serverTimestamp();
                await addDoc(collection(db, "staff"), data);
                alert("New Staff Member Added!");
            }
            
            document.getElementById('newStaffModal').classList.add('hidden');
        };

        // NEW: UPDATE STAFF ACCESS PASS
        window.updateStaffAccessPass = async () => {
            const adminPass = document.getElementById('adminAuthPass').value;
            const newPin = document.getElementById('newStaffPin').value;
            
            // Verify Admin
            let correct = "Sandeep@1116";
            try {
                const snap = await getDoc(doc(db, "settings", "config"));
                if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword;
            } catch(e) {}

            if(adminPass !== correct) return alert("Admin Password Incorrect");
            
            await setDoc(doc(db, "settings", "staff_config"), { accessPassword: newPin }, { merge: true });
            document.getElementById('staffPassChangeModal').classList.add('hidden');
            alert("Staff PIN Updated!");
        };

        window.openProject = (id, data) => {
            currentProjId = id; currentProjName = data.name; nav('detail');
            const isClosed = data.status === 'closed';
            document.getElementById('endDevBtn').style.display = (data.status === 'development') ? 'block' : 'none';
            document.getElementById('devPhaseUI').style.display = (data.status === 'development') ? 'grid' : 'none';
            
            // --- FIX: Logic to show Close Button ---
            // If project is 'active' (dev ended), show close button.
            if (data.status === 'active') {
                document.getElementById('closeProjBtn').classList.remove('hidden');
            } else {
                document.getElementById('closeProjBtn').classList.add('hidden');
            }

            if(currentProjUnsub) currentProjUnsub(); 
            currentProjUnsub = onSnapshot(doc(db, "projects", id), async (docSnap) => {
                if (docSnap.exists()) {
                    const pData = docSnap.data();
                    document.getElementById('detailName').innerText = pData.name; document.getElementById('detailArea').innerText = pData.area || 'Unknown'; document.getElementById('detailStatus').innerText = pData.status || 'Active';
                    const vList = document.getElementById('vehicleList'); vList.innerHTML = ""; (pData.assignedVehicles || []).forEach(v => vList.innerHTML += `<span class="bg-blue-200 px-2 py-1 rounded text-xs font-bold mr-1">${v}</span>`);
                    if(pData.linkedLandId) { const l = await getDoc(doc(db, "company_lands", pData.linkedLandId)); if(l.exists()) document.getElementById('detailLandName').innerText = l.data().name; } 
                    else { document.getElementById('detailLandName').innerText = ""; }
                }
            });
            loadBlocks(id, data.status === 'development'); loadExpensesAndProfit(id); loadProjectTasks(id);
        }

        window.endDevelopmentPhase = async () => { if(!confirm("End Development Phase?")) return; await updateDoc(doc(db, "projects", currentProjId), { status: 'active' }); alert("Development Phase Ended."); };
        window.closeProject = async () => {
             if(!confirm("Are you sure you want to CLOSE this project? This will remove the linked land from Assets.")) return;
             const pSnap = await getDoc(doc(db, "projects", currentProjId));
             const pData = pSnap.data();
             await updateDoc(doc(db, "projects", currentProjId), { status: 'closed' });
             if(pData.linkedLandId) {
                 const lSnap = await getDoc(doc(db, "company_lands", pData.linkedLandId));
                 if(lSnap.exists()) {
                     const l = lSnap.data();
                     await addDoc(collection(db, "bs_items"), { date: new Date().toLocaleDateString('en-CA'), name: `Project Closed (Sold): ${l.name}`, type: "Current Asset", amount: -l.cost, timestamp: serverTimestamp() });
                 }
             }
             alert("Project Closed Successfully."); nav('projects');
        };

        // NEW: DELETE PROJECT FUNCTION
        window.deleteProject = async () => {
            if(!confirm("DANGER: This will permanently delete the project and all its data. Continue?")) return;
            const pwd = prompt("Enter Admin Password to Confirm Delete:");
            const settingsRef = doc(db, "settings", "config");
            const snap = await getDoc(settingsRef);
            let correct = "Sandeep@1116"; 
            if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword;

            if(pwd === correct) {
                await deleteDoc(doc(db, "projects", currentProjId));
                alert("Project Deleted.");
                nav('projects');
            } else { alert("Incorrect Password."); }
        };

        window.assignVehicle = async () => { const vNo = document.getElementById('regVehicleNo').value; if(!vNo) return; await updateDoc(doc(db, "projects", currentProjId), { assignedVehicles: arrayUnion(vNo) }); document.getElementById('regVehicleNo').value = ""; };
        
        // Correctly attached event listeners
        const addBlockBtn = document.getElementById('addBlockBtn');
        if (addBlockBtn) {
            addBlockBtn.addEventListener('click', async () => { const name = document.getElementById('blockName').value; const size = document.getElementById('blockSize').value; const price = document.getElementById('blockPrice').value; const pPrice = document.getElementById('blockPerchPrice').value; if(!name) return; await addDoc(collection(db, `projects/${currentProjId}/blocks`), { name, size, price: parseFloat(price), perchPrice: parseFloat(pPrice), status: "available" }); document.getElementById('blockName').value = ""; document.getElementById('blockPrice').value = ""; });
        }
        
        window.loadProjectTasks = (pid) => {
            onSnapshot(collection(db, `projects/${pid}/tasks`), (snap) => {
                const list = document.getElementById('adminTaskList'); list.innerHTML = ""; projectTasksData = {}; 
                snap.forEach(d => {
                    const t = d.data(); projectTasksData[d.id] = t; 
                    let statusBadge = ""; let actionBtn = "";
                    if (t.status === 'completed') { statusBadge = '<span class="text-green-600 font-bold text-xs bg-green-100 px-2 rounded">Paid</span>'; actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-xs font-bold hover:bg-gray-300">View</button>`; } 
                    else { statusBadge = '<span class="text-gray-400 text-xs bg-gray-100 px-2 rounded">Pending</span>'; actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-slate-900 text-white px-4 py-2 rounded text-xs font-bold">Review</button>`; }
                    let imgHtml = "";
                    if(t.photos && t.photos.length > 0) imgHtml = `<img src="${t.photos[0]}" class="w-16 h-16 rounded object-cover ml-4 border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${t.photos[0]}';document.getElementById('imgModal').classList.remove('hidden')">`;
                    else if(t.photo) imgHtml = `<img src="${t.photo}" class="w-16 h-16 rounded object-cover ml-4 border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${t.photo}';document.getElementById('imgModal').classList.remove('hidden')">`;
                    const el = document.createElement('div'); el.className = "bg-white p-4 rounded-xl border border-blue-100 shadow-sm flex justify-between items-center";
                    el.innerHTML = `<div class="flex items-center"><div><h4 class="font-bold text-slate-800">${t.title}</h4><p class="text-xs text-gray-500">${t.description||'-'}</p><div class="mt-1">${statusBadge} ${t.submittedCost ? `<span class="ml-2 font-bold">Rs. ${t.submittedCost}</span>` : ''}</div></div>${imgHtml}</div>${actionBtn}`;
                    list.appendChild(el);
                });
            });
        }
        
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        if(saveTaskBtn) {
            saveTaskBtn.addEventListener('click', async () => { const title = document.getElementById('newTaskTitle').value; const desc = document.getElementById('newTaskDesc').value; const file = document.getElementById('taskPhoto').files[0]; let photoBase64 = null; if(file) photoBase64 = await processImage(file); await addDoc(collection(db, `projects/${currentProjId}/tasks`), { title, description: desc, status: 'new', photo: photoBase64, createdAt: serverTimestamp() }); document.getElementById('newTaskModal').classList.add('hidden'); });
        }
        
        window.loadMeterReadings = () => { 
            try {
                // Modified query to sort client-side if index is missing to prevent crash
                const q = collection(db, "meter_readings");
                onSnapshot(q, (snap) => { 
                    const list = document.getElementById('readingsList'); 
                    list.innerHTML = ""; 
                    
                    if(snap.empty) {
                        list.innerHTML = "<p class='text-gray-500 p-4'>No readings found.</p>";
                        return;
                    }

                    // Client-side sort to be safe
                    let readings = [];
                    snap.forEach(d => readings.push({id: d.id, ...d.data()}));
                    readings.sort((a,b) => (b.date > a.date) ? 1 : -1);

                    readings.forEach(r => { 
                        const el = document.createElement('div'); 
                        el.className = "bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex gap-4"; 
                        el.innerHTML = `<div class="flex-1"><h4 class="font-bold text-lg text-slate-800">${r.vehicleNo}</h4><p class="text-lg text-blue-600 font-bold">Rs. ${r.totalCost.toLocaleString()}</p>${r.status!=='approved' ? `<button onclick="openApproveModal('${r.id}', 'meter')" class="mt-2 bg-green-600 text-white px-4 py-1 rounded shadow text-sm font-bold">Review</button>` : `<button onclick="openApproveModal('${r.id}', 'meter')" class="mt-2 bg-gray-200 text-gray-700 px-4 py-1 rounded shadow text-sm font-bold">View</button>`}</div>`; 
                        list.appendChild(el); 
                    }); 
                }, (error) => {
                    console.error("Error loading meter readings:", error);
                    document.getElementById('readingsList').innerHTML = "<p class='text-red-500 p-4'>Error loading data. Check permissions.</p>";
                });
            } catch(e) {
                console.error(e);
            }
        }

        window.processSale = async (downloadPdf) => {
            // --- FIX: ADDED ERROR HANDLING & VALIDATION FOR BUTTONS ---
            try {
                if(!currentProjId || !selectedBlockId) {
                    return alert("System Error: Project or Block context lost. Please refresh and try again.");
                }

                const nic = document.getElementById('cusNIC').value; const name = document.getElementById('cusName').value; const phone = document.getElementById('cusPhone').value; const address = document.getElementById('cusAddress').value;
                if(!nic || !name) return alert("Customer Name and NIC are required!");
                
                let customerId = ""; 
                const q = query(collection(db, "customers"), where("nic", "==", nic)); 
                const snap = await getDocs(q);
                if(!snap.empty) { customerId = snap.docs[0].data().customerId; } else { const nicPrefix = nic.substring(0, 5); const randomNum = Math.floor(Math.random() * 10); const randomChar = String.fromCharCode(65 + Math.floor(Math.random() * 26)); customerId = `${nicPrefix}${randomNum}${randomChar}`; }
                
                await addDoc(collection(db, "customers"), { customerId, name, nic, phone, address, joinedDate: new Date(), projectName: currentProjName, projectId: currentProjId, blockName: selectedBlockData.name, blockId: selectedBlockId });
                
                const cus = { customerId, name, address, nic, phone }; 
                const price = parseFloat(document.getElementById('finalPrice').value); 
                const plan = document.getElementById('payPlanType').value; 
                const planFee = parseFloat(document.getElementById('planFee').value) || 0; 
                const deedFee = parseFloat(document.getElementById('deedFee').value) || 0;
                const salespersonName = document.getElementById('salesPersonInput').value; // Get Name
                
                let ep = {}; let nextD = null; let status = 'sold'; let paidNow = 0;

                if(plan === 'EP') { 
                    const cycle = parseInt(document.getElementById('epCycle').value);
                    const rate = parseFloat(document.getElementById('epRate').value);
                    const months = parseFloat(document.getElementById('epMonths').value);
                    const booking = parseFloat(document.getElementById('bookingFee').value) || 0;
                    const dpPct = parseFloat(document.getElementById('downPayPct').value);
                    const dpTotal = price * (dpPct / 100);
                    const loanAmt = price - dpTotal; 
                    let totalPayable = 0;
                    if (rate === 0) { totalPayable = loanAmt; } else { const r = (rate / 100) / 12; const emi = (loanAmt * r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1); totalPayable = emi * months; }
                    ep = { rate: rate, months: months, cycleDays: cycle, totalPayable: totalPayable, paidAmount: 0, downPayment: { required: dpTotal, paid: booking, isComplete: false } }; 
                    const d = new Date(); d.setDate(d.getDate() + 30); nextD = d;
                    paidNow = booking;
                } else { 
                    paidNow = parseFloat(document.getElementById('cashAdvancePay').value) || 0;
                    if(paidNow >= price) status = 'sold_finished'; 
                }

                // --- COMMISSION LOGIC (FIXED) ---
                if(salespersonName) { 
                    const comm = price * 0.0075; 
                    
                    // Add Global Expense
                    await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `Commission: ${salespersonName} (Block ${selectedBlockData.name})`, amount: comm, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() }); 
                    await recordDailyTransaction(`Commission: ${salespersonName}`, comm, 'expense', currentProjName); 
                    
                    // Add to Staff Earnings (Search by name - simplistic)
                    const s = staffListCache.find(x => x.name === salespersonName);
                    if(s) {
                        // --- FIX: Include Project Name in Description ---
                        await addDoc(collection(db, `staff/${s.id}/earnings`), {
                            date: new Date(),
                            amount: comm,
                            type: 'Commission',
                            description: `Commission: ${selectedBlockData.name} (${currentProjName})`
                        });
                    }
                }
                
                // --- FIX: WELFARE POOL DESCRIPTION ---
                const poolComm = price * 0.0025;
                await addDoc(collection(db, "transactions"), { date: new Date().toLocaleDateString('en-CA'), description: `Staff Pool: ${selectedBlockData.name} - ${currentProjName}`, amount: poolComm, type: 'Income', category: 'Staff Welfare', timestamp: serverTimestamp() });

                const histEntry = {date: new Date(), amount: paidNow, type: plan === 'EP' ? 'Booking Fee' : 'Payment'};
                
                // SAVE TO DB
                await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { 
                    status: status, soldPrice: price, customer: cus, soldDate: new Date(), fees: { planFee, deedFee }, 
                    payment: { totalPrice: price, advancePaid: paidNow, planType: plan, epDetails: ep, nextPaymentDate: nextD, history: [histEntry] } 
                });
                await recordDailyTransaction(`Sale Payment: ${selectedBlockData.name} - ${cus.name}`, paidNow, 'income', currentProjName);
                
                // UPDATE LOCAL OBJECT FOR IMMEDIATE RECEIPT
                selectedBlockData.customer = cus;
                selectedBlockData.projectName = currentProjName;
                selectedBlockData.payment = { totalPrice: price, planType: plan };
                
                if(downloadPdf) {
                    document.getElementById('newPayAmount').value = paidNow;
                    document.getElementById('newPayDate').valueAsDate = new Date();
                    await downloadPaymentReceipt(); 
                    closeSellModal();
                } else { 
                    alert("Sale Complete!");
                    closeSellModal(); 
                }
            } catch (error) {
                console.error("Process Sale Error:", error);
                alert("Error processing sale. Please check your connection and try again.\nError: " + error.message);
            }
        };

        window.openPaymentModal = async (data) => {
            selectedBlockData = data; document.getElementById('paymentModal').classList.remove('hidden');
            const isFin = data.status === 'sold_finished'; const isEP = data.payment.planType === 'EP';
            document.getElementById('addPaymentSection').style.display = isFin ? 'none' : 'block'; document.getElementById('editPlanBtn').style.display = (isFin || !isEP) ? 'none' : 'block'; document.getElementById('resellBtn').classList.toggle('hidden', isFin); document.getElementById('paymentCompleteMsg').classList.toggle('hidden', !isFin);
            document.getElementById('payBlockInfo').innerText = `${data.name} - ${data.customer.name}`; document.getElementById('viewCusId').innerText = data.customer.customerId || "N/A"; document.getElementById('viewCusNIC').innerText = data.customer.nic || "N/A"; document.getElementById('viewCusPhone').innerText = data.customer.phone || "N/A"; document.getElementById('viewCusAddr').innerText = data.customer.address || "N/A";
            
            let total = 0, paid = 0; 
            if(isEP) { 
                const loanPayable = data.payment.epDetails.totalPayable; 
                const dpReq = data.payment.epDetails.downPayment.required; 
                total = loanPayable + dpReq; 
                
                const epPaid = data.payment.epDetails.paidAmount || 0; 
                const dpPaid = data.payment.epDetails.downPayment.paid || 0; 
                paid = epPaid + dpPaid;
            } else { total = data.soldPrice; paid = (data.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0); }
            
            document.getElementById('pmTotal').innerText = total.toLocaleString(); document.getElementById('pmPaid').innerText = paid.toLocaleString(); document.getElementById('pmBalance').innerText = (total-paid).toLocaleString();
            
            const cycleSec = document.getElementById('epCycleSection'); const preInfo = document.getElementById('epPreStageInfo'); const instInfo = document.getElementById('epInstallmentInfo');
            if(isEP) {
                cycleSec.classList.remove('hidden');
                const dp = data.payment.epDetails.downPayment;
                const dpDone = dp.paid >= (dp.required - 100); 
                document.getElementById('epDpTarget').innerText = dp.required.toLocaleString(); document.getElementById('epDpPaid').innerText = dp.paid.toLocaleString();
                if(!dpDone) {
                    preInfo.classList.remove('hidden'); instInfo.classList.add('hidden');
                    const bal = dp.required - dp.paid; document.getElementById('epDpDueMsg').innerText = `Finish Down Payment (Due: Rs. ${bal.toLocaleString()})`;
                } else {
                    preInfo.classList.add('hidden'); instInfo.classList.remove('hidden');
                    
                    const totalPaid = (data.payment.epDetails.paidAmount || 0) + (data.payment.epDetails.downPayment.paid || 0);
                    const settlementBalance = data.soldPrice - totalPaid;
                    document.getElementById('epRealtimeFuture').innerText = "Rs. " + (settlementBalance > 0 ? settlementBalance.toLocaleString() : "0.00");

                    // --- ENHANCED EMI BREAKDOWN ---
                    const fullTerm = data.payment.epDetails.months;
                    const originalLoan = data.soldPrice - data.payment.epDetails.downPayment.required;
                    const principalPaid = (data.payment.epDetails.paidAmount || 0); 
                    const pctPaid = principalPaid / originalLoan;
                    let monthsLeft = Math.max(1, Math.round(fullTerm * (1 - pctPaid)));
                    if (settlementBalance <= 0) monthsLeft = 0;

                    let thisMonthPayable = 0;
                    let monthlyPrincipal = 0;
                    let thisMonthInterest = 0;

                    if (monthsLeft > 0) {
                        monthlyPrincipal = settlementBalance / monthsLeft;
                        const annualRate = data.payment.epDetails.rate || 0;
                        const monthlyRate = (annualRate / 12) / 100;
                        thisMonthInterest = settlementBalance * monthlyRate;
                        thisMonthPayable = monthlyPrincipal + thisMonthInterest;
                    }

                    document.getElementById('epThisMonthCapital').innerText = "Rs. " + monthlyPrincipal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('epThisMonthInterest').innerText = "Rs. " + thisMonthInterest.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('epNextDueAmt').innerText = "Rs. " + thisMonthPayable.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
            } else { cycleSec.classList.add('hidden'); document.getElementById('epRealtimeFuture').innerText = "N/A"; }
            
            const tbody = document.getElementById('paymentHistoryList'); tbody.innerHTML = ""; (data.payment.history||[]).forEach(h => { const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date); tbody.innerHTML += `<tr><td class="py-2">${d.toLocaleDateString()}</td><td class="font-bold">Rs.${(h.amount||0).toLocaleString()}</td><td class="text-gray-500">${h.type}</td></tr>`; }); document.getElementById('newPayDate').valueAsDate = new Date(); 
            if(isEP) updateCycleUI(data); 
        };

        window.downloadPaymentReceipt = async () => {
             const amt = parseFloat(document.getElementById('newPayAmount').value || 0);
             const date = document.getElementById('newPayDate').value;
             // Ensure data exists in context (fixed auto-fill issue)
             const cus = selectedBlockData.customer || {name:'-', nic:'-'};
             const html = `<div class="receipt-box"><div class="receipt-header"><h2 class="receipt-title">OFFICIAL RECEIPT</h2><p>Sithuliya Real Estate</p><p style="font-size:12px;">Kurunegala, Sri Lanka</p></div><div style="margin-bottom:20px; font-size:14px;"><p><strong>Date:</strong> ${date}</p><p><strong>Receipt No:</strong> #${Math.floor(10000 + Math.random() * 90000)}</p></div><div style="border-top:2px solid #eee; border-bottom:2px solid #eee; padding:15px 0;"><div class="receipt-row"><span class="receipt-label">Customer Name</span><span class="receipt-value">${cus.name}</span></div><div class="receipt-row"><span class="receipt-label">Customer NIC</span><span class="receipt-value">${cus.nic}</span></div><div class="receipt-row"><span class="receipt-label">Project</span><span class="receipt-value">${selectedBlockData.projectName || currentProjName}</span></div><div class="receipt-row"><span class="receipt-label">Block Number</span><span class="receipt-value">${selectedBlockData.name}</span></div><div class="receipt-row"><span class="receipt-label">Payment Plan</span><span class="receipt-value">${selectedBlockData.payment.planType}</span></div></div><div style="margin-top:20px; background:#f9f9f9; padding:15px;"><div class="receipt-row" style="font-size:18px;"><span class="receipt-label">AMOUNT PAID</span><span class="receipt-value">Rs. ${amt.toLocaleString()}.00</span></div></div><div class="receipt-footer"><div><div class="sign-line">Cashier Signature</div></div><div><div class="sign-line">Customer Signature</div></div></div><p style="text-align:center; font-size:10px; margin-top:20px; color:#888;">Thank you for your business!</p></div>`;
             document.getElementById('printContainer').innerHTML = html;
             document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        window.downloadPaymentHistory = async () => {
            let rows = ""; (selectedBlockData.payment.history || []).forEach(h => { const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date); rows += `<tr><td style="border-bottom:1px solid #ddd; padding:8px;">${d.toLocaleDateString()}</td><td style="border-bottom:1px solid #ddd; padding:8px;">${h.type}</td><td style="border-bottom:1px solid #ddd; padding:8px; text-align:right">Rs. ${h.amount.toLocaleString()}</td></tr>`; });
            document.getElementById('printContainer').innerHTML = `<h2 class="text-center text-xl underline mb-4">PAYMENT HISTORY</h2><table style="width:100%; border-collapse:collapse; margin-top:20px;"><thead><tr style="background:#f2f2f2;"><th>Date</th><th>Type</th><th style="text-align:right">Amount</th></tr></thead><tbody>${rows}</tbody></table>`;
            document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

        function updateCycleUI(data) {
            const container = document.getElementById('epCycleSection');
            if (data.payment.planType !== 'EP') { container.classList.add('hidden'); return; }
            const dp = data.payment.epDetails.downPayment;
            if(dp.paid < (dp.required - 100)) return; 

            const fill = document.getElementById('cycleProgressBar'); const label = document.getElementById('cycleStatusLabel'); const daysLabel = document.getElementById('cycleDaysLeft');
            document.getElementById('dispRate').innerText = (data.payment.epDetails.rate || 0) + "%";
            document.getElementById('dispMonths').innerText = (data.payment.epDetails.months || 0) + " M";

            const nextD = data.payment.nextPaymentDate.seconds ? new Date(data.payment.nextPaymentDate.seconds*1000) : new Date(data.payment.nextPaymentDate);
            const cycleDays = parseInt(data.payment.epDetails.cycleDays || 30);
            const today = new Date();
            const startD = new Date(nextD); startD.setDate(startD.getDate() - cycleDays);

            if (today <= nextD) {
                const totalTime = nextD - startD, elapsed = today - startD;
                const percent = Math.min(100, Math.max(0, (elapsed / totalTime) * 100));
                fill.style.width = percent + "%"; fill.className = "h-full progress-bar-fill bg-blue-500";
                label.innerText = "Cycle Progress"; label.className = "text-[10px] font-bold uppercase text-blue-600";
                daysLabel.innerText = Math.ceil((nextD - today)/(1000*60*60*24)) + " days left";
            } else {
                const diffTime = today - nextD;
                const diffDays = diffTime / (1000*60*60*24);
                const gracePercent = Math.min(100, (diffDays / 5) * 100);
                fill.style.width = gracePercent + "%"; fill.className = "h-full progress-bar-fill bg-red-600";
                label.innerText = "OVERDUE (Grace Period)"; label.className = "text-[10px] font-bold uppercase text-red-600 animate-pulse";
                daysLabel.innerText = "Penalty in " + Math.max(0, Math.ceil(5 - diffDays)) + " days";
                if (diffDays >= 5) applyLatePenalty(data);
            }
        }
        
        async function applyLatePenalty(data) {
            const lastHist = data.payment.history[data.payment.history.length-1];
            if (lastHist && lastHist.type.includes('Penalty') && new Date(lastHist.date.seconds*1000).toDateString() === new Date().toDateString()) return;
            const bal = data.payment.epDetails.totalPayable - data.payment.epDetails.paidAmount;
            const penalty = bal * 0.04;
            const newTotal = data.payment.epDetails.totalPayable + penalty;
            const newNext = new Date(); newNext.setDate(newNext.getDate() + parseInt(data.payment.epDetails.cycleDays || 30));
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), {
                "payment.epDetails.totalPayable": newTotal, "payment.nextPaymentDate": newNext,
                "payment.history": arrayUnion({date: new Date(), amount: 0, type: 'Late Penalty (4%)', note: 'Added automatically'})
            });
            await addDoc(collection(db, "notifications"), { title: "Penalty Applied", message: `4% added to ${data.customer.name}`, timestamp: serverTimestamp() });
        }

        window.toggleEditPlan = () => document.getElementById('editPlanSection').classList.toggle('hidden');
        
        const savePlanBtn = document.getElementById('savePlanChangesBtn');
        if(savePlanBtn) {
            savePlanBtn.addEventListener('click', async () => {
                const rate = parseFloat(document.getElementById('editNewRate').value); const months = parseFloat(document.getElementById('editNewMonths').value); if(!rate || !months) return alert("Please enter valid Rate and Months");
                await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { "payment.epDetails.rate": rate, "payment.epDetails.months": months }); alert("Updated!"); document.getElementById('paymentModal').classList.add('hidden');
            });
        }

        const submitPayBtn = document.getElementById('submitPayBtn');
        if(submitPayBtn) {
            submitPayBtn.addEventListener('click', async () => {
                const amt = parseFloat(document.getElementById('newPayAmount').value); 
                if(!amt) return;
                const b = selectedBlockData;
                let updateData = { "payment.history": arrayUnion({date: new Date(), amount: amt, type: 'Payment'}) };
                let currentPaid = 0, totalDue = 0;

                if (b.payment.planType === 'EP') {
                    const dp = b.payment.epDetails.downPayment;
                    if(dp.paid < (dp.required - 100)) {
                        const newDpPaid = dp.paid + amt;
                        updateData["payment.epDetails.downPayment.paid"] = newDpPaid;
                        updateData["payment.history"] = arrayUnion({date: new Date(), amount: amt, type: 'Down Payment Part'});
                        if(newDpPaid >= (dp.required - 100)) {
                            updateData["payment.epDetails.downPayment.isComplete"] = true;
                            const nextD = new Date(); nextD.setDate(nextD.getDate() + 30); 
                            updateData["payment.nextPaymentDate"] = nextD;
                        }
                    } else {
                        const newEpPaid = (b.payment.epDetails.paidAmount || 0) + amt;
                        updateData["payment.epDetails.paidAmount"] = newEpPaid;
                        updateData["payment.history"] = arrayUnion({date: new Date(), amount: amt, type: 'Installment'});
                        const cycleDays = parseInt(b.payment.epDetails.cycleDays || 30);
                        const currentNext = b.payment.nextPaymentDate.seconds ? new Date(b.payment.nextPaymentDate.seconds*1000) : new Date(b.payment.nextPaymentDate);
                        const oneInst = b.payment.epDetails.totalPayable / b.payment.epDetails.months;
                        if(amt >= (oneInst - 500)) { currentNext.setDate(currentNext.getDate() + cycleDays); updateData["payment.nextPaymentDate"] = currentNext; }
                        if(newEpPaid >= (b.payment.epDetails.totalPayable - 100)) updateData["status"] = "sold_finished";
                    }
                } else {
                    const prevPaid = (b.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0);
                    currentPaid = prevPaid + amt;
                    totalDue = b.soldPrice;
                    if (currentPaid >= totalDue - 100) updateData["status"] = "sold_finished";
                }

                await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), updateData);
                await recordDailyTransaction(`Payment: ${b.name}`, amt, 'income', currentProjName);
                document.getElementById('paymentModal').classList.add('hidden');
                alert("Payment Added!");
            });
        }

        window.processResell = async () => { if(!confirm("Cancel sale?")) return; const b = selectedBlockData; const paid = b.payment.epDetails ? b.payment.epDetails.paidAmount : b.soldPrice; await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: `REFUND: ${b.name}`, amount: paid, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() }); await recordDailyTransaction(`REFUND: ${b.name}`, paid, 'expense', currentProjName); await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { status: 'available', customer: null, payment: null, soldPrice: null, soldDate: null }); alert("Cancelled!"); document.getElementById('paymentModal').classList.add('hidden'); };
        
        const saveExpBtn = document.getElementById('saveExpenseBtn');
        if(saveExpBtn) {
            saveExpBtn.addEventListener('click', async () => { const amt = parseFloat(document.getElementById('expAmount').value); const desc = document.getElementById('expDesc').value; await addDoc(collection(db, `projects/${currentProjId}/expenses`), { description: desc, amount: amt, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() }); await recordDailyTransaction(`Expense: ${desc}`, amt, 'expense', currentProjName); document.getElementById('expenseModal').classList.add('hidden'); });
        }
        
        // FIXED: Robust Block Price Calculation
        window.calcBlockPrice = () => { 
            const size = parseFloat(document.getElementById('blockSize').value) || 0;
            const pPrice = parseFloat(document.getElementById('blockPerchPrice').value) || 0;
            const total = size * pPrice;
            document.getElementById('blockPrice').value = total > 0 ? total : '';
        };
        
        window.toggleEPFields = () => { const plan = document.getElementById('payPlanType').value; const isEP = plan === 'EP'; document.getElementById('epFields').classList.toggle('hidden', !isEP); document.getElementById('cashFields').classList.toggle('hidden', isEP); if(isEP) window.calculateEP(); };
        window.calculateEP = () => { 
            const price = parseFloat(document.getElementById('finalPrice').value)||0; const booking = parseFloat(document.getElementById('bookingFee').value)||0; const pct = parseFloat(document.getElementById('downPayPct').value)||40;
            const dpAmount = price * (pct / 100); document.getElementById('downPayAmount').value = dpAmount;
            const dpBal = dpAmount - booking; document.getElementById('downPayBalanceDisp').innerText = dpBal.toLocaleString();
            const loanAmt = price - dpAmount; document.getElementById('loanAmount').value = loanAmt.toLocaleString();
            
            const rate = parseFloat(document.getElementById('epRate').value)||15; const months = parseFloat(document.getElementById('epMonths').value)||60;
            
            // REDUCING BALANCE / EMI CALCULATION
            let monthly = 0;
            let totalPayable = 0;

            if (rate === 0) {
                // No interest case
                monthly = loanAmt / months;
                totalPayable = loanAmt;
            } else {
                // Monthly Interest Rate
                const r = (rate / 100) / 12;
                
                // EMI Formula: P * r * (1+r)^n / ((1+r)^n - 1)
                monthly = (loanAmt * r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1);
                
                // Total Payable = Monthly Installment * Number of Months
                totalPayable = monthly * months;
            }

            document.getElementById('epMonthlyInst').innerText = monthly.toLocaleString(undefined, {maximumFractionDigits: 2}); 
            document.getElementById('epTotalPayable').innerText = totalPayable.toLocaleString(undefined, {maximumFractionDigits: 2}); 
            
            const deedFee = (price * 0.05) - 1000; document.getElementById('deedFee').value = deedFee > 0 ? deedFee : 0;
        };
        
        function loadBlocks(pid, isDevMode) { 
            const container = document.getElementById('blocksContainer');
            if(!container) return;
            
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { 
                container.innerHTML = ""; 
                
                if(snap.empty) {
                    container.innerHTML = "<div class='col-span-full text-center text-gray-400 py-10'>No blocks added yet.</div>";
                    return;
                }

                snap.forEach(d => { 
                    const b = d.data(); 
                    const isSold = b.status === 'sold';
                    const isFin = b.status === 'sold_finished'; 
                    
                    let bgClass = 'bg-white border-blue-100 hover:border-blue-400';
                    let statusText = `Rs.${(b.price || 0).toLocaleString()}`;
                    let statusColor = 'text-blue-600';

                    if (isFin) {
                        bgClass = 'bg-slate-800 text-white';
                        statusText = 'CLOSED';
                        statusColor = 'text-green-400';
                    } else if (isSold) {
                        bgClass = 'bg-red-50 border-red-200';
                        statusText = 'SOLD';
                        statusColor = 'text-red-600';
                    }

                    const el = document.createElement('div'); 
                    el.className = `p-4 border-2 rounded-xl text-center cursor-pointer relative overflow-hidden transition transform hover:scale-105 ${bgClass}`; 
                    el.innerHTML = `
                        <h4 class="font-bold text-xl">${b.name}</h4>
                        <p class="text-xs ${isFin?'text-gray-400':'text-gray-500'}">${b.size}P</p>
                        <p class="font-bold mt-2 ${statusColor}">${statusText}</p>
                    `; 
                    
                    el.onclick = () => { 
                        selectedBlockId = d.id; 
                        selectedBlockData = b; 
                        if(isSold || isFin) {
                            openPaymentModal(b); 
                        } else {
                            openSellModal(); 
                        }
                    }; 
                    container.appendChild(el); 
                }); 
            }); 
        }

        function openSellModal() { document.getElementById('sellModal').classList.remove('hidden'); document.getElementById('sellBlockName').innerText = selectedBlockData.name; document.getElementById('finalPrice').value = selectedBlockData.price; document.getElementById('payPlanType').value = "Cash"; toggleEPFields(); }
        
        function loadExpensesAndProfit(pid) {
            onSnapshot(collection(db, `projects/${pid}/expenses`), (snap) => {
                const list = document.getElementById('expenseList'); 
                if(!list) return;
                list.innerHTML = ""; 
                let totalExp = 0;
                snap.forEach(d => { 
                    const e = d.data(); totalExp += e.amount;
                    list.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3">${e.date}</td><td class="p-3">${e.description}</td><td class="p-3 font-bold text-red-600">Rs. ${e.amount.toLocaleString()}</td></tr>`; 
                });
                if(document.getElementById('finExpense')) {
                    document.getElementById('finExpense').innerText = "Rs. " + totalExp.toLocaleString();
                    updateNet(null, totalExp);
                }
            });
            
            // Calc Income
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => {
                 let inc = 0;
                 snap.forEach(b => {
                     const bd = b.data();
                     if(bd.status.includes('sold')) inc += (bd.soldPrice || bd.price);
                 });
                 if(document.getElementById('finIncome')) {
                     document.getElementById('finIncome').innerText = "Rs. " + inc.toLocaleString();
                     updateNet(inc, null);
                 }
            });
        }
        
        async function recordDailyTransaction(desc, amt, type, proj) {
            await addDoc(collection(db, "transactions"), {
                date: new Date().toLocaleDateString('en-CA'),
                description: desc,
                amount: amt,
                type: type === 'income' ? 'Income' : 'Expense',
                category: proj || 'General',
                timestamp: serverTimestamp()
            });
        }

        // --- NEW: STAFF ACCESS FUNCTIONS ---
        window.openStaffAccess = () => {
            document.getElementById('staffAccessModal').classList.remove('hidden');
            document.getElementById('staffAccessInput').focus();
        };

        window.verifyStaffAccess = async () => {
            const input = document.getElementById('staffAccessInput').value;
            let pin = "1234"; // Default PIN
            let adminPass = "Sandeep@1116"; // Default Admin Pass as backup
            
            try {
                // FIXED: Checking settings/staff_config per user request
                const s = await getDoc(doc(db, "settings", "staff_config"));
                if(s.exists()) {
                    if(s.data().accessPassword) pin = s.data().accessPassword;
                }
                
                // Also check legacy/admin pass
                const c = await getDoc(doc(db, "settings", "config"));
                if(c.exists() && c.data().adminPassword) adminPass = c.data().adminPassword;
                
            } catch(e) {}
            
            if(input === pin || input === adminPass) {
                document.getElementById('staffAccessModal').classList.add('hidden');
                document.getElementById('staffAccessInput').value = "";
                nav('staff');
            } else {
                alert("Incorrect PIN!");
            }
        };
        
        let selectedApproveId = null;
        let selectedApproveType = null;

        window.openApproveModal = async (id, type) => {
            selectedApproveId = id;
            selectedApproveType = type;
            const modal = document.getElementById('taskApproveModal');
            modal.classList.remove('hidden');
            
            document.getElementById('taskModalHeader').innerText = type === 'task' ? 'Review Site Task' : 'Review Meter Reading';
            
            // Clear previous
            document.getElementById('approveTaskTitle').innerText = "Loading...";
            document.getElementById('approveTaskCost').innerText = "...";
            document.getElementById('approveTaskPhotos').innerHTML = "";
            
            let data;
            if(type === 'task') {
                data = projectTasksData[id];
                if(!data) return; 
                
                document.getElementById('approveTaskTitle').innerText = data.title;
                document.getElementById('approveTaskCost').innerText = "Rs. " + (data.submittedCost || 0).toLocaleString();
                document.getElementById('approveTaskTimeInfo').innerText = data.description;
                
                // IMPROVED PHOTO VIEW
                let images = [];
                if(data.photos && Array.isArray(data.photos)) images = data.photos;
                else if(data.photo) images = [data.photo];
                
                let imgHtml = "";
                images.forEach(img => {
                    imgHtml += `<img src="${img}" class="w-full h-48 object-cover rounded cursor-pointer border border-gray-300 hover:opacity-90" onclick="document.getElementById('imgModalSrc').src='${img}';document.getElementById('imgModal').classList.remove('hidden')">`;
                });
                document.getElementById('approveTaskPhotos').innerHTML = imgHtml || "<p class='text-gray-400'>No photos attached.</p>";

            } else {
                // Meter reading - FIX: Handle start/end photos
                const snap = await getDoc(doc(db, "meter_readings", id));
                if(snap.exists()) {
                    data = snap.data();
                    document.getElementById('approveTaskTitle').innerText = data.vehicleNo;
                    document.getElementById('approveTaskCost').innerText = "Rs. " + (data.totalCost || 0).toLocaleString();
                    document.getElementById('approveTaskTimeInfo').innerText = `Date: ${data.date} | Start: ${data.startReading} | End: ${data.endReading}`;
                    
                    let images = [];
                    // Check array format first
                    if(data.photos && Array.isArray(data.photos)) images = data.photos;
                    else if(data.photo) images = [data.photo];
                    // Check specific meter fields if array is empty
                    else {
                        if (data.startPhoto) images.push(data.startPhoto);
                        if (data.endPhoto) images.push(data.endPhoto);
                    }
                    
                    let imgHtml = "";
                    if (images.length > 0) {
                        images.forEach(img => {
                            imgHtml += `<img src="${img}" class="w-full h-48 object-cover rounded cursor-pointer border border-gray-300 hover:opacity-90" onclick="document.getElementById('imgModalSrc').src='${img}';document.getElementById('imgModal').classList.remove('hidden')">`;
                        });
                    } else {
                        imgHtml = "<p class='text-gray-400 col-span-2 text-center'>No photos attached.</p>";
                    }
                    document.getElementById('approveTaskPhotos').innerHTML = imgHtml;
                }
            }
            
            // Hide/Show Approve button based on status
            const btn = document.getElementById('confirmApproveTaskBtn');
            if(data && (data.status === 'completed' || data.status === 'approved')) {
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
                btn.onclick = () => confirmApprove(); 
            }
        };

        window.confirmApprove = async () => {
            if(!selectedApproveId) return;
            if(selectedApproveType === 'task') {
                const cost = parseFloat(prompt("Confirm/Edit Cost for Approval:", document.getElementById('approveTaskCost').innerText.replace('Rs. ', '').replace(/,/g, '')));
                if(isNaN(cost)) return;
                
                await updateDoc(doc(db, `projects/${currentProjId}/tasks/${selectedApproveId}`), {
                    status: 'completed',
                    submittedCost: cost,
                    approvedAt: serverTimestamp()
                });
                
                // Add expense
                const tTitle = document.getElementById('approveTaskTitle').innerText;
                await addDoc(collection(db, `projects/${currentProjId}/expenses`), {
                    description: `Task: ${tTitle}`,
                    amount: cost,
                    date: new Date().toLocaleDateString('en-CA'),
                    createdAt: serverTimestamp()
                });
                await recordDailyTransaction(`Task: ${tTitle} (${currentProjName})`, cost, 'expense', currentProjName);
                
            } else {
                // Meter
                await updateDoc(doc(db, "meter_readings", selectedApproveId), { status: 'approved' });
            }
            document.getElementById('taskApproveModal').classList.add('hidden');
            alert("Approved!");
        };

        // --- NEW: GEN REPORT FUNCTION ---
        window.genReport = async (type) => {
            const start = document.getElementById('repFrom').value;
            const end = document.getElementById('repTo').value;
            const container = document.getElementById('reportContent');
            
            if(!start || !end) return alert("Select Date Range first!");
            container.innerHTML = "<p class='text-center p-4'>Generating...</p>";

            let html = `<h2 class="text-xl font-bold text-center mb-4 uppercase">${type.replace('_', ' ')} Report</h2>
                        <p class="text-center text-xs mb-4 text-gray-500">From ${start} To ${end}</p>`;

            if (type === 'daybook' || type === 'petty') {
                let q = query(collection(db, "transactions"), where("date", ">=", start), where("date", "<=", end), orderBy("date"));
                const snap = await getDocs(q);
                let rows = ""; let totalIn = 0, totalOut = 0;
                
                snap.forEach(d => {
                    const t = d.data();
                    if (type === 'petty' && t.category !== 'Petty Cash' && !t.description.toLowerCase().includes('petty')) return;
                    
                    const isInc = t.type === 'Income';
                    if(isInc) totalIn += t.amount; else totalOut += t.amount;
                    
                    rows += `<tr class="border-b">
                        <td class="p-2">${t.date}</td>
                        <td class="p-2">${t.description}</td>
                        <td class="p-2 font-bold ${isInc ? 'text-green-600' : 'text-red-600'}">${isInc ? 'IN' : 'OUT'}</td>
                        <td class="p-2 text-right">${t.amount.toLocaleString()}</td>
                    </tr>`;
                });
                
                html += `<table class="w-full text-xs"><thead><tr class="bg-gray-100"><th>Date</th><th>Desc</th><th>Type</th><th class="text-right">Amount</th></tr></thead><tbody>${rows}</tbody></table>
                         <div class="mt-4 flex justify-between font-bold text-sm border-t pt-2">
                            <span>Total Income: ${totalIn.toLocaleString()}</span>
                            <span>Total Expense: ${totalOut.toLocaleString()}</span>
                            <span class="${totalIn-totalOut >= 0 ? 'text-green-600' : 'text-red-600'}">Net: ${(totalIn-totalOut).toLocaleString()}</span>
                         </div>`;
            
            } else if (type === 'pnl') {
                let q = query(collection(db, "transactions"), where("date", ">=", start), where("date", "<=", end));
                const snap = await getDocs(q);
                let inc = 0, exp = 0;
                let cats = {};
                
                snap.forEach(d => {
                    const t = d.data();
                    if(t.type === 'Income') inc += t.amount; else exp += t.amount;
                    if(!cats[t.category]) cats[t.category] = 0;
                    cats[t.category] += t.amount;
                });
                
                let catRows = "";
                for(const [k, v] of Object.entries(cats)) {
                    catRows += `<tr><td>${k}</td><td class="text-right">${v.toLocaleString()}</td></tr>`;
                }

                html += `<div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded text-center"><h3 class="font-bold text-green-700">Total Income</h3><p class="text-xl">${inc.toLocaleString()}</p></div>
                            <div class="bg-red-50 p-4 rounded text-center"><h3 class="font-bold text-red-700">Total Expenses</h3><p class="text-xl">${exp.toLocaleString()}</p></div>
                         </div>
                         <div class="text-center p-4 bg-slate-100 rounded mb-4"><h3 class="font-bold">NET PROFIT / (LOSS)</h3><p class="text-2xl font-bold ${inc-exp>=0?'text-green-600':'text-red-600'}">Rs. ${(inc-exp).toLocaleString()}</p></div>
                         <h4 class="font-bold border-b mb-2">Category Breakdown</h4>
                         <table class="w-full text-xs"><tbody>${catRows}</tbody></table>`;
            
            } else if (type === 'bs') {
                // Simplified Balance Sheet logic (Fetching BS Items + Cash Calculation)
                const bsSnap = await getDocs(collection(db, "bs_items"));
                let assets = [], liabs = [], equity = [];
                let totA = 0, totL = 0, totE = 0;
                
                bsSnap.forEach(d => {
                    const i = d.data();
                    const row = `<tr><td>${i.name}</td><td class="text-right">${i.amount.toLocaleString()}</td></tr>`;
                    if(i.type.includes('Asset')) { assets.push(row); totA += i.amount; }
                    else if(i.type.includes('Liability')) { liabs.push(row); totL += i.amount; }
                    else { equity.push(row); totE += i.amount; }
                });
                
                html += `<div class="grid grid-cols-2 gap-8">
                            <div><h3 class="font-bold bg-blue-100 p-1 mb-2">ASSETS</h3><table class="w-full text-xs">${assets.join('')}</table><div class="border-t font-bold text-right mt-2">${totA.toLocaleString()}</div></div>
                            <div>
                                <h3 class="font-bold bg-red-100 p-1 mb-2">LIABILITIES</h3><table class="w-full text-xs">${liabs.join('')}</table><div class="border-t font-bold text-right mt-2">${totL.toLocaleString()}</div>
                                <h3 class="font-bold bg-yellow-100 p-1 mb-2 mt-4">EQUITY</h3><table class="w-full text-xs">${equity.join('')}</table><div class="border-t font-bold text-right mt-2">${totE.toLocaleString()}</div>
                            </div>
                         </div>`;
            }

            container.innerHTML = html;
            // Prep for PDF
            document.getElementById('printContainer').innerHTML = `<div style="padding:20px; font-family:sans-serif;">${html}</div>`;
        };

        window.triggerPDFDownload = async () => {
             const element = document.getElementById('printContainer');
             const opt = { 
                 margin: 10,
                 filename: `Financial_Report_${new Date().toISOString().split('T')[0]}.pdf`, 
                 image: { type: 'jpeg', quality: 0.98 }, 
                 html2canvas: { scale: 2 }, 
                 jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
             };
            await html2pdf().set(opt).from(element).save();
        };

        // --- NEW: SAVE TRANSACTION (Data Entry) ---
        window.saveTransaction = async () => {
            const date = document.getElementById('txDate').value;
            const desc = document.getElementById('txDesc').value;
            const type = document.getElementById('txType').value;
            const amt = parseFloat(document.getElementById('txAmount').value);
            const cat = document.getElementById('txCategory').value;
            const isPetty = document.getElementById('txIsPetty').checked;
            
            if(!date || !amt) return alert("Date and Amount Required");
            
            await addDoc(collection(db, "transactions"), {
                date, description: desc, type, amount: amt, category: isPetty ? 'Petty Cash' : cat, isPetty, timestamp: serverTimestamp()
            });
            
            alert("Transaction Saved!");
            document.getElementById('txAmount').value = ""; document.getElementById('txDesc').value = "";
        };

        window.saveBSItem = async () => {
            const date = document.getElementById('bsDate').value;
            const name = document.getElementById('bsName').value;
            const type = document.getElementById('bsType').value;
            const amt = parseFloat(document.getElementById('bsAmount').value);
            
            await addDoc(collection(db, "bs_items"), {
                date, name, type, amount: amt, timestamp: serverTimestamp()
            });
            alert("Balance Sheet Item Added!");
        };

        // --- NEW: CUSTOMER SEARCH FUNCTIONS ---
        
        window.loadCustomers = () => {
            onSnapshot(collection(db, "customers"), (snap) => {
                customerCache = [];
                snap.forEach(d => {
                    customerCache.push({ id: d.id, ...d.data() });
                });
            });
        };

        window.handleGlobalSearch = () => {
            const query = document.getElementById('projSearch').value.toLowerCase();
            const results = document.getElementById('searchResults');
            
            // 1. Filter Projects (Only if on projects page)
            const grid = document.getElementById('projectGrid');
            if (grid && !grid.classList.contains('hidden')) {
                const cards = grid.querySelectorAll('div > h3');
                cards.forEach(cardTitle => {
                    const card = cardTitle.parentElement.parentElement; // Assuming structure: div > div > h3 (check your HTML structure)
                    // Actually, structure is: div.bg-white > div(absolute) + h3 + p ...
                    // Correct structure from loadProjects: 
                    // <div class="... relative ... group"> ... <h3 ...>${d.name}</h3> ... </div>
                    // The parent of H3 is the card div directly.
                    const cardDiv = cardTitle.parentElement; 
                    if(cardTitle.innerText.toLowerCase().includes(query)) {
                        cardDiv.style.display = "block";
                    } else {
                        cardDiv.style.display = "none";
                    }
                });
            }

            // 2. Customer Search
            if(query.length < 2) { results.classList.add('hidden'); return; }
            
            const matches = customerCache.filter(c => 
                (c.name && c.name.toLowerCase().includes(query)) ||
                (c.nic && c.nic.toLowerCase().includes(query)) ||
                (c.customerId && c.customerId.toLowerCase().includes(query))
            );

            // Render Results
            results.innerHTML = '';
            if(matches.length > 0) {
                results.classList.remove('hidden');
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = "p-3 border-b hover:bg-blue-50 cursor-pointer flex justify-between items-center";
                    div.innerHTML = `<div><p class="font-bold text-sm text-slate-800">${m.name}</p><p class="text-xs text-gray-500 font-bold">${m.blockName} @ ${m.projectName}</p></div><span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold">${m.nic}</span>`;
                    div.onclick = () => window.navigateToBlock(m.projectId, m.blockId);
                    results.appendChild(div);
                });
            } else {
                results.innerHTML = '<div class="p-3 text-sm text-gray-500 text-center">No customers found.</div>';
                results.classList.remove('hidden');
            }
        };

        window.navigateToBlock = async (pid, bid) => {
            // Close search results
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('projSearch').value = "";
            
            // 1. Get Project Data & Open Project View
            const pSnap = await getDoc(doc(db, "projects", pid));
            if(!pSnap.exists()) return alert("Project not found!");
            
            // This switches view to 'detail' and loads blocks
            openProject(pid, pSnap.data()); 
            
            // 2. Wait a bit for blocks to load (or fetch directly)
            // Ideally, we fetch the specific block data directly to ensure we have it for the modal
            const bSnap = await getDoc(doc(db, `projects/${pid}/blocks/${bid}`));
            if(bSnap.exists()) {
                selectedBlockId = bid;
                selectedBlockData = bSnap.data();
                // Ensure customer data is attached if missing in block (it should be there from processSale)
                if(!selectedBlockData.projectName) selectedBlockData.projectName = pSnap.data().name;
                
                openPaymentModal(selectedBlockData);
            } else {
                alert("Block data not found!");
            }
        };

        function initApp() { 
            console.log("App Initializing...");
            window.loadProjects(); 
            window.checkOverduePayments();
            window.loadStaff(); 
            window.loadLands(); // FIX: Added
            window.loadMeterReadings(); // FIX: Added
            window.loadCustomers(); // FIX: Added Customer Cache
        }
        window.initApp = initApp;

        // --- THE MISSING LINK: AUTO START ---
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

    </script>
</body>
</html>
